(function(a,b){L.MarkerClusterGroup=L.FeatureGroup.extend({options:{maxClusterRadius:80,iconCreateFunction:null,spiderfyOnMaxZoom:true,showCoverageOnHover:true,zoomToBoundsOnClick:true,singleMarkerMode:false,disableClusteringAtZoom:null,animateAddingMarkers:false,spiderfyDistanceMultiplier:1,polygonOptions:{}},initialize:function(c){L.Util.setOptions(this,c);if(!this.options.iconCreateFunction){this.options.iconCreateFunction=this._defaultIconCreateFunction}L.FeatureGroup.prototype.initialize.call(this,[]);this._inZoomAnimation=0;this._needsClustering=[];this._currentShownBounds=null},addLayer:function(f){if(f instanceof L.LayerGroup){var g=[];for(var e in f._layers){if(f._layers.hasOwnProperty(e)){g.push(f._layers[e])}}return this.addLayers(g)}if(!this._map){this._needsClustering.push(f);return this}if(this.hasLayer(f)){return this}if(this._unspiderfy){this._unspiderfy()}this._addLayer(f,this._maxZoom);var c=f,d=this._map.getZoom();if(f.__parent){while(c.__parent._zoom>=d){c=c.__parent}}if(this._currentShownBounds.contains(c.getLatLng())){if(this.options.animateAddingMarkers){this._animationAddLayer(f,c)}else{this._animationAddLayerNonAnimated(f,c)}}return this},removeLayer:function(c){if(!this._map){this._arraySplice(this._needsClustering,c);return this}if(!c.__parent){return this}if(this._unspiderfy){this._unspiderfy();this._unspiderfyLayer(c)}this._removeLayer(c,true);if(c._icon){L.FeatureGroup.prototype.removeLayer.call(this,c);c.setOpacity(1)}return this},addLayers:function(f){var e,d,c;if(!this._map){this._needsClustering=this._needsClustering.concat(f);return this}for(e=0,d=f.length;e<d;e++){c=f[e];if(this.hasLayer(c)){continue}this._addLayer(c,this._maxZoom);if(c.__parent){if(c.__parent.getChildCount()===2){var h=c.__parent.getAllChildMarkers(),g=h[0]===c?h[1]:h[0];L.FeatureGroup.prototype.removeLayer.call(this,g)}}}for(e in this._layers){if(this._layers.hasOwnProperty(e)){c=this._layers[e];if(c instanceof L.MarkerCluster&&c._iconNeedsUpdate){c._updateIcon()}}}this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds);return this},removeLayers:function(f){var e,d,c;if(!this._map){for(e=0,d=f.length;e<d;e++){this._arraySplice(this._needsClustering,f[e])}return this}for(e=0,d=f.length;e<d;e++){c=f[e];if(!c.__parent){continue}this._removeLayer(c,true,true);if(c._icon){L.FeatureGroup.prototype.removeLayer.call(this,c);c.setOpacity(1)}}this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds);for(e in this._layers){if(this._layers.hasOwnProperty(e)){c=this._layers[e];if(c instanceof L.MarkerCluster){c._updateIcon()}}}return this},clearLayers:function(){if(!this._map){this._needsClustering=[];delete this._gridClusters;delete this._gridUnclustered}if(this._unspiderfy){this._unspiderfy()}for(var c in this._layers){if(this._layers.hasOwnProperty(c)){L.FeatureGroup.prototype.removeLayer.call(this,this._layers[c])}}this.eachLayer(function(d){delete d.__parent});if(this._map){this._generateInitialClusters()}return this},getBounds:function(){var d=new L.LatLngBounds();if(this._topClusterLevel){d.extend(this._topClusterLevel._bounds)}else{for(var c=this._needsClustering.length-1;c>=0;c--){d.extend(this._needsClustering[c].getLatLng())}}return d},eachLayer:function(f,d){var e=this._needsClustering.slice(),c;if(this._topClusterLevel){this._topClusterLevel.getAllChildMarkers(e)}for(c=e.length-1;c>=0;c--){f.call(d,e[c])}},hasLayer:function(d){if(this._needsClustering.length>0){var e=this._needsClustering;for(var c=e.length-1;c>=0;c--){if(e[c]===d){return true}}}return !!(d.__parent&&d.__parent._group===this)},zoomToShowLayer:function(c,e){var d=function(){if((c._icon||c.__parent._icon)&&!this._inZoomAnimation){this._map.off("moveend",d,this);this.off("animationend",d,this);if(c._icon){e()}else{if(c.__parent._icon){var f=function(){this.off("spiderfied",f,this);e()};this.on("spiderfied",f,this);c.__parent.spiderfy()}}}};if(c._icon){e()}else{if(c.__parent._zoom<this._map.getZoom()){this._map.on("moveend",d,this);if(!c._icon){this._map.panTo(c.getLatLng())}}else{this._map.on("moveend",d,this);this.on("animationend",d,this);this._map.setView(c.getLatLng(),c.__parent._zoom+1);c.__parent.zoomToBounds()}}},onAdd:function(f){this._map=f;if(!this._gridClusters){this._generateInitialClusters()}for(var e=0,c=this._needsClustering.length;e<c;e++){var d=this._needsClustering[e];if(d.__parent){continue}this._addLayer(d,this._maxZoom)}this._needsClustering=[];this._map.on("zoomend",this._zoomEnd,this);this._map.on("moveend",this._moveEnd,this);if(this._spiderfierOnAdd){this._spiderfierOnAdd()}this._bindEvents();this._zoom=this._map.getZoom();this._currentShownBounds=this._getExpandedVisibleBounds();this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds)},onRemove:function(d){this._map.off("zoomend",this._zoomEnd,this);this._map.off("moveend",this._moveEnd,this);this._unbindEvents();this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim","");if(this._spiderfierOnRemove){this._spiderfierOnRemove()}for(var c in this._layers){if(this._layers.hasOwnProperty(c)){L.FeatureGroup.prototype.removeLayer.call(this,this._layers[c])}}this._map=null},_arraySplice:function(d,e){for(var c=d.length-1;c>=0;c--){if(d[c]===e){d.splice(c,1);return}}},_removeLayer:function(h,e,j){var f=this._gridClusters,d=this._gridUnclustered,c=this._map;if(e){for(var i=this._maxZoom;i>=0;i--){if(!d[i].removeObject(h,c.project(h.getLatLng(),i))){break}}}var k=h.__parent,g=k._markers,l;this._arraySplice(g,h);while(k){k._childCount--;if(k._zoom<0){break}else{if(e&&k._childCount<=1){l=k._markers[0]===h?k._markers[1]:k._markers[0];f[k._zoom].removeObject(k,c.project(k._cLatLng,k._zoom));d[k._zoom].addObject(l,c.project(l.getLatLng(),k._zoom));this._arraySplice(k.__parent._childClusters,k);k.__parent._markers.push(l);l.__parent=k.__parent;if(k._icon){L.FeatureGroup.prototype.removeLayer.call(this,k);if(!j){L.FeatureGroup.prototype.addLayer.call(this,l)}}}else{k._recalculateBounds();if(!j||!k._icon){k._updateIcon()}}}k=k.__parent}delete h.__parent},_propagateEvent:function(c){if(c.target instanceof L.MarkerCluster){c.type="cluster"+c.type}L.FeatureGroup.prototype._propagateEvent.call(this,c)},_defaultIconCreateFunction:function(d){var e=d.getChildCount();var f=" marker-cluster-";if(e<10){f+="small"}else{if(e<100){f+="medium"}else{f+="large"}}return new L.DivIcon({html:"<div><span>"+e+"</span></div>",className:"marker-cluster"+f,iconSize:new L.Point(40,40)})},_bindEvents:function(){var g=null,f=this._map,d=this.options.spiderfyOnMaxZoom,c=this.options.showCoverageOnHover,e=this.options.zoomToBoundsOnClick;if(d||e){this.on("clusterclick",function(h){if(f.getMaxZoom()===f.getZoom()){if(d){h.layer.spiderfy()}}else{if(e){h.layer.zoomToBounds()}}},this)}if(c){this.on("clustermouseover",function(h){if(this._inZoomAnimation){return}if(g){f.removeLayer(g)}if(h.layer.getChildCount()>2){g=new L.Polygon(h.layer.getConvexHull(),this.options.polygonOptions);f.addLayer(g)}},this);this.on("clustermouseout",function(){if(g){f.removeLayer(g);g=null}},this);f.on("zoomend",function(){if(g){f.removeLayer(g);g=null}},this);f.on("layerremove",function(h){if(g&&h.layer===this){f.removeLayer(g);g=null}},this)}},_unbindEvents:function(){var d=this.options.spiderfyOnMaxZoom,c=this.options.showCoverageOnHover,f=this.options.zoomToBoundsOnClick,e=this._map;if(d||f){this.off("clusterclick",null,this)}if(c){this.off("clustermouseover",null,this);this.off("clustermouseout",null,this);e.off("zoomend",null,this);e.off("layerremove",null,this)}},_zoomEnd:function(){if(!this._map){return}this._mergeSplitClusters();this._zoom=this._map._zoom;this._currentShownBounds=this._getExpandedVisibleBounds()},_moveEnd:function(){if(this._inZoomAnimation){return}var c=this._getExpandedVisibleBounds();this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,this._zoom,c);this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,c);this._currentShownBounds=c;return},_generateInitialClusters:function(){var d=this._map.getMaxZoom(),c=this.options.maxClusterRadius;if(this.options.disableClusteringAtZoom){d=this.options.disableClusteringAtZoom-1}this._maxZoom=d;this._gridClusters={};this._gridUnclustered={};for(var e=d;e>=0;e--){this._gridClusters[e]=new L.DistanceGrid(c);this._gridUnclustered[e]=new L.DistanceGrid(c)}this._topClusterLevel=new L.MarkerCluster(this,-1)},_addLayer:function(g,l){var e=this._gridClusters,c=this._gridUnclustered,k,h;if(this.options.singleMarkerMode){g.options.icon=this.options.iconCreateFunction({getChildCount:function(){return 1},getAllChildMarkers:function(){return[g]}})}for(;l>=0;l--){k=this._map.project(g.getLatLng(),l);var d=e[l].getNearObject(k);if(d){d._addChild(g);g.__parent=d;return}d=c[l].getNearObject(k);if(d){var i=d.__parent;if(i){this._removeLayer(d,false)}var j=new L.MarkerCluster(this,l,d,g);e[l].addObject(j,this._map.project(j._cLatLng,l));d.__parent=j;g.__parent=j;var f=j;for(h=l-1;h>i._zoom;h--){f=new L.MarkerCluster(this,h,f);e[h].addObject(f,this._map.project(d.getLatLng(),h))}i._addChild(f);for(h=l;h>=0;h--){if(!c[h].removeObject(d,this._map.project(d.getLatLng(),h))){break}}return}c[l].addObject(g,k)}this._topClusterLevel._addChild(g);g.__parent=this._topClusterLevel;return},_mergeSplitClusters:function(){if(this._zoom<this._map._zoom){this._animationStart();this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,this._zoom,this._getExpandedVisibleBounds());this._animationZoomIn(this._zoom,this._map._zoom)}else{if(this._zoom>this._map._zoom){this._animationStart();this._animationZoomOut(this._zoom,this._map._zoom)}else{this._moveEnd()}}},_getExpandedVisibleBounds:function(){var h=this._map,d=h.getBounds(),c=d._southWest,g=d._northEast,f=L.Browser.mobile?0:Math.abs(c.lat-g.lat),e=L.Browser.mobile?0:Math.abs(c.lng-g.lng);return new L.LatLngBounds(new L.LatLng(c.lat-f,c.lng-e,true),new L.LatLng(g.lat+f,g.lng+e,true))},_animationAddLayerNonAnimated:function(c,d){if(d===c){L.FeatureGroup.prototype.addLayer.call(this,c)}else{if(d._childCount===2){d._addToMap();var e=d.getAllChildMarkers();L.FeatureGroup.prototype.removeLayer.call(this,e[0]);L.FeatureGroup.prototype.removeLayer.call(this,e[1])}else{d._updateIcon()}}}});L.MarkerClusterGroup.include(!L.DomUtil.TRANSITION?{_animationStart:function(){},_animationZoomIn:function(d,c){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,d);this._topClusterLevel._recursivelyAddChildrenToMap(null,c,this._getExpandedVisibleBounds())},_animationZoomOut:function(d,c){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,d);this._topClusterLevel._recursivelyAddChildrenToMap(null,c,this._getExpandedVisibleBounds())},_animationAddLayer:function(c,d){this._animationAddLayerNonAnimated(c,d)}}:{_animationStart:function(){this._map._mapPane.className+=" leaflet-cluster-anim";this._inZoomAnimation++},_animationEnd:function(){if(this._map){this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim","")}this._inZoomAnimation--;this.fire("animationend")},_animationZoomIn:function(h,e){var g=this,f=this._getExpandedVisibleBounds(),d;this._topClusterLevel._recursively(f,h,0,function(n){var j=n._latlng,l=n._markers,i;if(n._isSingleParent()&&h+1===e){L.FeatureGroup.prototype.removeLayer.call(g,n);n._recursivelyAddChildrenToMap(null,e,f)}else{n.setOpacity(0);n._recursivelyAddChildrenToMap(j,e,f)}for(d=l.length-1;d>=0;d--){i=l[d];if(!f.contains(i._latlng)){L.FeatureGroup.prototype.removeLayer.call(g,i)}}});this._forceLayout();var c,k;g._topClusterLevel._recursivelyBecomeVisible(f,e);for(c in g._layers){if(g._layers.hasOwnProperty(c)){k=g._layers[c];if(!(k instanceof L.MarkerCluster)&&k._icon){k.setOpacity(1)}}}g._topClusterLevel._recursively(f,h,e,function(i){i._recursivelyRestoreChildPositions(e)});setTimeout(function(){g._topClusterLevel._recursively(f,h,0,function(i){L.FeatureGroup.prototype.removeLayer.call(g,i);i.setOpacity(1)});g._animationEnd()},250)},_animationZoomOut:function(d,c){this._animationZoomOutSingle(this._topClusterLevel,d-1,c);this._topClusterLevel._recursivelyAddChildrenToMap(null,c,this._getExpandedVisibleBounds());this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,d,this._getExpandedVisibleBounds())},_animationZoomOutSingle:function(c,g,d){var f=this._getExpandedVisibleBounds();c._recursivelyAnimateChildrenInAndAddSelfToMap(f,g+1,d);var e=this;this._forceLayout();c._recursivelyBecomeVisible(f,d);setTimeout(function(){if(c._childCount===1){var h=c._markers[0];h.setLatLng(h.getLatLng());h.setOpacity(1);return}c._recursively(f,d,0,function(i){i._recursivelyRemoveChildrenFromMap(f,g+1)});e._animationEnd()},250)},_animationAddLayer:function(c,e){var d=this;L.FeatureGroup.prototype.addLayer.call(this,c);if(e!==c){if(e._childCount>2){e._updateIcon();this._forceLayout();this._animationStart();c._setPos(this._map.latLngToLayerPoint(e.getLatLng()));c.setOpacity(0);setTimeout(function(){L.FeatureGroup.prototype.removeLayer.call(d,c);c.setOpacity(1);d._animationEnd()},250)}else{this._forceLayout();d._animationStart();d._animationZoomOutSingle(e,this._map.getMaxZoom(),this._map.getZoom())}}},_forceLayout:function(){L.Util.falseFn(document.body.offsetWidth)}});L.MarkerCluster=L.Marker.extend({initialize:function(f,e,d,c){L.Marker.prototype.initialize.call(this,d?(d._cLatLng||d.getLatLng()):new L.LatLng(0,0),{icon:this});this._group=f;this._zoom=e;this._markers=[];this._childClusters=[];this._childCount=0;this._iconNeedsUpdate=true;this._bounds=new L.LatLngBounds();if(d){this._addChild(d)}if(c){this._addChild(c)}},getAllChildMarkers:function(e){e=e||[];for(var d=this._childClusters.length-1;d>=0;d--){this._childClusters[d].getAllChildMarkers(e)}for(var c=this._markers.length-1;c>=0;c--){e.push(this._markers[c])}return e},getChildCount:function(){return this._childCount},zoomToBounds:function(){this._group._map.fitBounds(this._bounds)},_updateIcon:function(){this._iconNeedsUpdate=true;if(this._icon){this.setIcon(this)}},createIcon:function(){if(this._iconNeedsUpdate){this._iconObj=this._group.options.iconCreateFunction(this);this._iconNeedsUpdate=false}return this._iconObj.createIcon()},createShadow:function(){return this._iconObj.createShadow()},_addChild:function(c,d){this._iconNeedsUpdate=true;this._expandBounds(c);if(c instanceof L.MarkerCluster){if(!d){this._childClusters.push(c);c.__parent=this}this._childCount+=c._childCount}else{if(!d){this._markers.push(c)}this._childCount++}if(this.__parent){this.__parent._addChild(c,true)}},_expandBounds:function(e){var f,d=e._wLatLng||e._latlng;if(e instanceof L.MarkerCluster){this._bounds.extend(e._bounds);f=e._childCount}else{this._bounds.extend(d);f=1}if(!this._cLatLng){this._cLatLng=e._cLatLng||d}var c=this._childCount+f;if(!this._wLatLng){this._latlng=this._wLatLng=new L.LatLng(d.lat,d.lng)}else{this._wLatLng.lat=(d.lat*f+this._wLatLng.lat*this._childCount)/c;this._wLatLng.lng=(d.lng*f+this._wLatLng.lng*this._childCount)/c}},_addToMap:function(c){if(c){this._backupLatlng=this._latlng;this.setLatLng(c)}L.FeatureGroup.prototype.addLayer.call(this._group,this)},_recursivelyAnimateChildrenIn:function(e,c,d){this._recursively(e,0,d-1,function(j){var h=j._markers,g,f;for(g=h.length-1;g>=0;g--){f=h[g];if(f._icon){f._setPos(c);f.setOpacity(0)}}},function(i){var h=i._childClusters,g,f;for(g=h.length-1;g>=0;g--){f=h[g];if(f._icon){f._setPos(c);f.setOpacity(0)}}})},_recursivelyAnimateChildrenInAndAddSelfToMap:function(e,d,c){this._recursively(e,c,0,function(f){f._recursivelyAnimateChildrenIn(e,f._group._map.latLngToLayerPoint(f.getLatLng()).round(),d);if(f._isSingleParent()&&d-1===c){f.setOpacity(1);f._recursivelyRemoveChildrenFromMap(e,d)}else{f.setOpacity(0)}f._addToMap()})},_recursivelyBecomeVisible:function(c,d){this._recursively(c,0,d,null,function(e){e.setOpacity(1)})},_recursivelyAddChildrenToMap:function(c,e,d){this._recursively(d,-1,e,function(h){if(e===h._zoom){return}for(var g=h._markers.length-1;g>=0;g--){var f=h._markers[g];if(!d.contains(f._latlng)){continue}if(c){f._backupLatlng=f.getLatLng();f.setLatLng(c);f.setOpacity(0)}L.FeatureGroup.prototype.addLayer.call(h._group,f)}},function(f){f._addToMap(c)})},_recursivelyRestoreChildPositions:function(g){for(var f=this._markers.length-1;f>=0;f--){var c=this._markers[f];if(c._backupLatlng){c.setLatLng(c._backupLatlng);delete c._backupLatlng}}if(g-1===this._zoom){for(var e=this._childClusters.length-1;e>=0;e--){this._childClusters[e]._restorePosition()}}else{for(var d=this._childClusters.length-1;d>=0;d--){this._childClusters[d]._recursivelyRestoreChildPositions(g)}}},_restorePosition:function(){if(this._backupLatlng){this.setLatLng(this._backupLatlng);delete this._backupLatlng}},_recursivelyRemoveChildrenFromMap:function(d,g,f){var c,e;this._recursively(d,-1,g-1,function(h){for(e=h._markers.length-1;e>=0;e--){c=h._markers[e];if(!f||!f.contains(c._latlng)){L.FeatureGroup.prototype.removeLayer.call(h._group,c);c.setOpacity(1)}}},function(h){for(e=h._childClusters.length-1;e>=0;e--){c=h._childClusters[e];if(!f||!f.contains(c._latlng)){L.FeatureGroup.prototype.removeLayer.call(h._group,c);c.setOpacity(1)}}})},_recursively:function(k,j,f,d,g){var h=this._childClusters,m=this._zoom,e,l;if(j>m){for(e=h.length-1;e>=0;e--){l=h[e];if(k.intersects(l._bounds)){l._recursively(k,j,f,d,g)}}}else{if(d){d(this)}if(g&&this._zoom===f){g(this)}if(f>m){for(e=h.length-1;e>=0;e--){l=h[e];if(k.intersects(l._bounds)){l._recursively(k,j,f,d,g)}}}}},_recalculateBounds:function(){var e=this._markers,d=this._childClusters,c;this._bounds=new L.LatLngBounds();delete this._wLatLng;for(c=e.length-1;c>=0;c--){this._expandBounds(e[c])}for(c=d.length-1;c>=0;c--){this._expandBounds(d[c])}},_isSingleParent:function(){return this._childClusters.length>0&&this._childClusters[0]._childCount===this._childCount}});L.DistanceGrid=function(c){this._cellSize=c;this._sqCellSize=c*c;this._grid={};this._objectPoint={}};L.DistanceGrid.prototype={addObject:function(h,e){var d=this._getCoord(e.x),j=this._getCoord(e.y),g=this._grid,i=g[j]=g[j]||{},c=i[d]=i[d]||[],f=L.Util.stamp(h);this._objectPoint[f]=e;c.push(h)},updateObject:function(d,c){this.removeObject(d);this.addObject(d,c)},removeObject:function(d,j){var h=this._getCoord(j.x),g=this._getCoord(j.y),c=this._grid,l=c[g]=c[g]||{},k=l[h]=l[h]||[],e,f;delete this._objectPoint[L.Util.stamp(d)];for(e=0,f=k.length;e<f;e++){if(k[e]===d){k.splice(e,1);if(f===1){delete l[h]}return true}}},eachObject:function(m,d){var g,f,e,l,o,n,h,c=this._grid;for(g in c){if(c.hasOwnProperty(g)){o=c[g];for(f in o){if(o.hasOwnProperty(f)){n=o[f];for(e=0,l=n.length;e<l;e++){h=m.call(d,n[e]);if(h){e--;l--}}}}}}},getNearObject:function(p){var o=this._getCoord(p.x),n=this._getCoord(p.y),g,e,d,s,r,h,f,m,q=this._objectPoint,l=this._sqCellSize,c=null;for(g=n-1;g<=n+1;g++){s=this._grid[g];if(s){for(e=o-1;e<=o+1;e++){r=s[e];if(r){for(d=0,h=r.length;d<h;d++){f=r[d];m=this._sqDist(q[L.Util.stamp(f)],p);if(m<l){l=m;c=f}}}}}}return c},_getCoord:function(c){return Math.floor(c/this._cellSize)},_sqDist:function(f,e){var d=e.x-f.x,c=e.y-f.y;return d*d+c*c}};(function(){L.QuickHull={getDistant:function(e,f){var c=f[1].lat-f[0].lat,d=f[0].lng-f[1].lng;return(d*(e.lat-f[0].lat)+c*(e.lng-f[0].lng))},findMostDistantPointFromBaseLine:function(e,k){var h=0,c=null,g=[],f,j,l;for(f=k.length-1;f>=0;f--){j=k[f];l=this.getDistant(j,e);if(l>0){g.push(j)}else{continue}if(l>h){h=l;c=j}}return{maxPoint:c,newPoints:g}},buildConvexHull:function(c,f){var e=[],d=this.findMostDistantPointFromBaseLine(c,f);if(d.maxPoint){e=e.concat(this.buildConvexHull([c[0],d.maxPoint],d.newPoints));e=e.concat(this.buildConvexHull([d.maxPoint,c[1]],d.newPoints));return e}else{return[c]}},getConvexHull:function(h){var j=false,k=false,c=null,g=null,d;for(d=h.length-1;d>=0;d--){var f=h[d];if(j===false||f.lat>j){c=f;j=f.lat}if(k===false||f.lat<k){g=f;k=f.lat}}var e=[].concat(this.buildConvexHull([g,c],h),this.buildConvexHull([c,g],h));return e}}}());L.MarkerCluster.include({getConvexHull:function(){var f=this.getAllChildMarkers(),d=[],h=[],g,e,c;for(c=f.length-1;c>=0;c--){e=f[c].getLatLng();d.push(e)}g=L.QuickHull.getConvexHull(d);for(c=g.length-1;c>=0;c--){h.push(g[c][0])}return h}});L.MarkerCluster.include({_2PI:Math.PI*2,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_circleSpiralSwitchover:9,spiderfy:function(){if(this._group._spiderfied===this||this._group._inZoomAnimation){return}var g=this.getAllChildMarkers(),f=this._group,e=f._map,c=e.latLngToLayerPoint(this._latlng),d;this._group._unspiderfy();this._group._spiderfied=this;if(g.length>=this._circleSpiralSwitchover){d=this._generatePointsSpiral(g.length,c)}else{c.y+=10;d=this._generatePointsCircle(g.length,c)}this._animationSpiderfy(g,d)},unspiderfy:function(c){if(this._group._inZoomAnimation){return}this._animationUnspiderfy(c);this._group._spiderfied=null},_generatePointsCircle:function(g,k){var c=this._group.options.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+g),h=c/this._2PI,f=this._2PI/g,e=[],d,j;e.length=g;for(d=g-1;d>=0;d--){j=this._circleStartAngle+d*f;e[d]=new L.Point(k.x+h*Math.cos(j),k.y+h*Math.sin(j))._round()}return e},_generatePointsSpiral:function(f,k){var g=this._group.options.spiderfyDistanceMultiplier*this._spiralLengthStart,e=this._group.options.spiderfyDistanceMultiplier*this._spiralFootSeparation,h=this._group.options.spiderfyDistanceMultiplier*this._spiralLengthFactor,j=0,d=[],c;d.length=f;for(c=f-1;c>=0;c--){j+=e/g+c*0.0005;d[c]=new L.Point(k.x+g*Math.cos(j),k.y+g*Math.sin(j))._round();g+=this._2PI*h/j}return d}});L.MarkerCluster.include(!L.DomUtil.TRANSITION?{_animationSpiderfy:function(k,d){var j=this._group,h=j._map,f,c,g,e;for(f=k.length-1;f>=0;f--){e=h.layerPointToLatLng(d[f]);c=k[f];c._preSpiderfyLatlng=c._latlng;c.setLatLng(e);c.setZIndexOffset(1000000);L.FeatureGroup.prototype.addLayer.call(j,c);g=new L.Polyline([this._latlng,e],{weight:1.5,color:"#222"});h.addLayer(g);c._spiderLeg=g}this.setOpacity(0.3);j.fire("spiderfied")},_animationUnspiderfy:function(){var g=this._group,f=g._map,e=this.getAllChildMarkers(),c,d;this.setOpacity(1);for(d=e.length-1;d>=0;d--){c=e[d];L.FeatureGroup.prototype.removeLayer.call(g,c);c.setLatLng(c._preSpiderfyLatlng);delete c._preSpiderfyLatlng;c.setZIndexOffset(0);f.removeLayer(c._spiderLeg);delete c._spiderLeg}}}:{SVG_ANIMATION:(function(){return document.createElementNS("http://www.w3.org/2000/svg","animate").toString().indexOf("SVGAnimate")>-1}()),_animationSpiderfy:function(f,l){var p=this,r=this._group,d=r._map,n=d.latLngToLayerPoint(this._latlng),k,g,q,o;for(k=f.length-1;k>=0;k--){g=f[k];g.setZIndexOffset(1000000);g.setOpacity(0);L.FeatureGroup.prototype.addLayer.call(r,g);g._setPos(n)}r._forceLayout();r._animationStart();var c=L.Path.SVG?0:0.3,j=L.Path.SVG_NS;for(k=f.length-1;k>=0;k--){o=d.layerPointToLatLng(l[k]);g=f[k];g._preSpiderfyLatlng=g._latlng;g.setLatLng(o);g.setOpacity(1);q=new L.Polyline([p._latlng,o],{weight:1.5,color:"#222",opacity:c});d.addLayer(q);g._spiderLeg=q;if(!L.Path.SVG||!this.SVG_ANIMATION){continue}var e=q._path.getTotalLength();q._path.setAttribute("stroke-dasharray",e+","+e);var h=document.createElementNS(j,"animate");h.setAttribute("attributeName","stroke-dashoffset");h.setAttribute("begin","indefinite");h.setAttribute("from",e);h.setAttribute("to",0);h.setAttribute("dur",0.25);q._path.appendChild(h);h.beginElement();h=document.createElementNS(j,"animate");h.setAttribute("attributeName","stroke-opacity");h.setAttribute("attributeName","stroke-opacity");h.setAttribute("begin","indefinite");h.setAttribute("from",0);h.setAttribute("to",0.5);h.setAttribute("dur",0.25);q._path.appendChild(h);h.beginElement()}p.setOpacity(0.3);if(L.Path.SVG){this._group._forceLayout();for(k=f.length-1;k>=0;k--){g=f[k]._spiderLeg;g.options.opacity=0.5;g._path.setAttribute("stroke-opacity",0.5)}}setTimeout(function(){r._animationEnd();r.fire("spiderfied")},250)},_animationUnspiderfy:function(l){var k=this._group,c=k._map,h=l?c._latLngToNewLayerPoint(this._latlng,l.zoom,l.center):c.latLngToLayerPoint(this._latlng),d=this.getAllChildMarkers(),g=L.Path.SVG&&this.SVG_ANIMATION,e,f,j;k._animationStart();this.setOpacity(1);for(f=d.length-1;f>=0;f--){e=d[f];if(!e._preSpiderfyLatlng){continue}e.setLatLng(e._preSpiderfyLatlng);delete e._preSpiderfyLatlng;e._setPos(h);e.setOpacity(0);if(g){j=e._spiderLeg._path.childNodes[0];j.setAttribute("to",j.getAttribute("from"));j.setAttribute("from",0);j.beginElement();j=e._spiderLeg._path.childNodes[1];j.setAttribute("from",0.5);j.setAttribute("to",0);j.setAttribute("stroke-opacity",0);j.beginElement();e._spiderLeg._path.setAttribute("stroke-opacity",0)}}setTimeout(function(){var i=0;for(f=d.length-1;f>=0;f--){e=d[f];if(e._spiderLeg){i++}}for(f=d.length-1;f>=0;f--){e=d[f];if(!e._spiderLeg){continue}e.setOpacity(1);e.setZIndexOffset(0);if(i>1){L.FeatureGroup.prototype.removeLayer.call(k,e)}c.removeLayer(e._spiderLeg);delete e._spiderLeg}k._animationEnd()},250)}});L.MarkerClusterGroup.include({_spiderfied:null,_spiderfierOnAdd:function(){this._map.on("click",this._unspiderfyWrapper,this);if(this._map.options.zoomAnimation){this._map.on("zoomstart",this._unspiderfyZoomStart,this)}else{this._map.on("zoomend",this._unspiderfyWrapper,this)}if(L.Path.SVG&&!L.Browser.touch){this._map._initPathRoot()}},_spiderfierOnRemove:function(){this._map.off("click",this._unspiderfyWrapper,this);this._map.off("zoomstart",this._unspiderfyZoomStart,this);this._map.off("zoomanim",this._unspiderfyZoomAnim,this);this._unspiderfy()},_unspiderfyZoomStart:function(){if(!this._map){return}this._map.on("zoomanim",this._unspiderfyZoomAnim,this)},_unspiderfyZoomAnim:function(c){if(L.DomUtil.hasClass(this._map._mapPane,"leaflet-touching")){return}this._map.off("zoomanim",this._unspiderfyZoomAnim,this);this._unspiderfy(c)},_unspiderfyWrapper:function(){this._unspiderfy()},_unspiderfy:function(c){if(this._spiderfied){this._spiderfied.unspiderfy(c)}},_unspiderfyLayer:function(c){if(c._spiderLeg){L.FeatureGroup.prototype.removeLayer.call(this,c);c.setOpacity(1);c.setZIndexOffset(0);this._map.removeLayer(c._spiderLeg);delete c._spiderLeg}}})}(this));
/*
 * jQuery Cookie Plugin v1.3.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2013 Klaus Hartl
 * Released under the MIT license
 */
(function(a){if(typeof define==="function"&&define.amd){define(["jquery"],a)}else{a(jQuery)}}(function(e){var a=/\+/g;function d(g){return g}function b(g){return decodeURIComponent(g.replace(a," "))}function f(g){if(g.indexOf('"')===0){g=g.slice(1,-1).replace(/\\"/g,'"').replace(/\\\\/g,"\\")}try{return c.json?JSON.parse(g):g}catch(h){}}var c=e.cookie=function(p,o,u){if(o!==undefined){u=e.extend({},c.defaults,u);if(typeof u.expires==="number"){var q=u.expires,s=u.expires=new Date();s.setDate(s.getDate()+q)}o=c.json?JSON.stringify(o):String(o);return(document.cookie=[c.raw?p:encodeURIComponent(p),"=",c.raw?o:encodeURIComponent(o),u.expires?"; expires="+u.expires.toUTCString():"",u.path?"; path="+u.path:"",u.domain?"; domain="+u.domain:"",u.secure?"; secure":""].join(""))}var g=c.raw?d:b;var r=document.cookie.split("; ");var v=p?undefined:{};for(var n=0,k=r.length;n<k;n++){var m=r[n].split("=");var h=g(m.shift());var j=g(m.join("="));if(p&&p===h){v=f(j);break}if(!p){v[h]=f(j)}}return v};c.defaults={};e.removeCookie=function(h,g){if(e.cookie(h)!==undefined){e.cookie(h,"",e.extend(g,{expires:-1}));return true}return false}}));
/*
 * jQuery imagesLoaded plugin v2.1.1
 * http://github.com/desandro/imagesloaded
 *
 * MIT License. by Paul Irish et al.
 */
(function(a,b){var c="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";a.fn.imagesLoaded=function(l){var i=this,n=a.isFunction(a.Deferred)?a.Deferred():0,m=a.isFunction(n.notify),f=i.find("img").add(i.filter("img")),g=[],k=[],h=[];if(a.isPlainObject(l)){a.each(l,function(o,p){if(o==="callback"){l=p}else{if(n){n[o](p)}}})}function j(){var o=a(k),p=a(h);if(n){if(h.length){n.reject(f,o,p)}else{n.resolve(f)}}if(a.isFunction(l)){l.call(i,f,o,p)}}function e(o){d(o.target,o.type==="error")}function d(o,p){if(o.src===c||a.inArray(o,g)!==-1){return}g.push(o);if(p){h.push(o)}else{k.push(o)}a.data(o,"imagesLoaded",{isBroken:p,src:o.src});if(m){n.notifyWith(a(o),[p,f,a(k),a(h)])}if(f.length===g.length){setTimeout(j);f.unbind(".imagesLoaded",e)}}if(!f.length){j()}else{f.bind("load.imagesLoaded error.imagesLoaded",e).each(function(o,q){var r=q.src;var p=a.data(q,"imagesLoaded");if(p&&p.src===r){d(q,p.isBroken);return}if(q.complete&&q.naturalWidth!==b){d(q,q.naturalWidth===0||q.naturalHeight===0);return}if(q.readyState||q.complete){q.src=c;q.src=r}})}return n?n.promise(i):i}})(jQuery);L.BingLayer=L.TileLayer.extend({options:{subdomains:[0,1,2,3],type:"Aerial",attribution:"Bing",culture:""},initialize:function(b,a){L.Util.setOptions(this,a);this._key=b;this._url=null;this.meta={};this.loadMetadata()},tile2quad:function(a,g,e){var c="";for(var d=e;d>0;d--){var f=0;var b=1<<(d-1);if((a&b)!=0){f+=1}if((g&b)!=0){f+=2}c=c+f}return c},getTileUrl:function(c,d){var d=this._getZoomForUrl();var a=this.options.subdomains,b=this.options.subdomains[Math.abs((c.x+c.y)%a.length)];return this._url.replace("{subdomain}",b).replace("{quadkey}",this.tile2quad(c.x,c.y,d)).replace("{culture}",this.options.culture)},loadMetadata:function(){var d=this;var c="_bing_metadata_"+L.Util.stamp(this);window[c]=function(g){d.meta=g;window[c]=undefined;var f=document.getElementById(c);f.parentNode.removeChild(f);if(g.errorDetails){alert("Got metadata"+g.errorDetails);return}d.initMetadata()};var b="http://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.options.type+"?include=ImageryProviders&jsonp="+c+"&key="+this._key;var a=document.createElement("script");a.type="text/javascript";a.src=b;a.id=c;document.getElementsByTagName("head")[0].appendChild(a)},initMetadata:function(){var e=this.meta.resourceSets[0].resources[0];this.options.subdomains=e.imageUrlSubdomains;this._url=e.imageUrl;this._providers=[];for(var b=0;b<e.imageryProviders.length;b++){var g=e.imageryProviders[b];for(var a=0;a<g.coverageAreas.length;a++){var h=g.coverageAreas[a];var f={zoomMin:h.zoomMin,zoomMax:h.zoomMax,active:false};var d=new L.LatLngBounds(new L.LatLng(h.bbox[0]+0.01,h.bbox[1]+0.01),new L.LatLng(h.bbox[2]-0.01,h.bbox[3]-0.01));f.bounds=d;f.attrib=g.attribution;this._providers.push(f)}}this._update()},_update:function(){if(this._url==null||!this._map){return}this._update_attribution();L.TileLayer.prototype._update.apply(this,[])},_update_attribution:function(){var c=this._map.getBounds();var b=this._map.getZoom();for(var a=0;a<this._providers.length;a++){var d=this._providers[a];if((b<=d.zoomMax&&b>=d.zoomMin)&&c.intersects(d.bounds)){if(!d.active){this._map.attributionControl.addAttribution(d.attrib)}d.active=true}else{if(d.active){this._map.attributionControl.removeAttribution(d.attrib)}d.active=false}}},onRemove:function(c){for(var a=0;a<this._providers.length;a++){var b=this._providers[a];if(b.active){this._map.attributionControl.removeAttribution(b.attrib);b.active=false}}L.TileLayer.prototype.onRemove.apply(this,[c])}});
/*
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */
(function(a,b){if(typeof exports==="object"&&exports){module.exports=b}else{if(typeof define==="function"&&define.amd){define(b)}else{a.Mustache=b}}}(this,(function(){var v={};v.name="mustache.js";v.version="0.7.2";v.tags=["{{","}}"];v.Scanner=t;v.Context=r;v.Writer=p;var d=/\s*/;var k=/\s+/;var h=/\S/;var g=/\s*=/;var m=/\s*\}/;var s=/#|\^|\/|>|\{|&|=|!/;var i=RegExp.prototype.test;var u=Object.prototype.toString;function n(y,x){return i.call(y,x)}function f(x){return !n(h,x)}var j=Array.isArray||function(x){return u.call(x)==="[object Array]"};function e(x){return x.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function l(x){return String(x).replace(/[&<>"'\/]/g,function(y){return c[y]})}v.escape=l;function t(x){this.string=x;this.tail=x;this.pos=0}t.prototype.eos=function(){return this.tail===""};t.prototype.scan=function(y){var x=this.tail.match(y);if(x&&x.index===0){this.tail=this.tail.substring(x[0].length);this.pos+=x[0].length;return x[0]}return""};t.prototype.scanUntil=function(y){var x,z=this.tail.search(y);switch(z){case -1:x=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:x="";break;default:x=this.tail.substring(0,z);this.tail=this.tail.substring(z);this.pos+=z}return x};function r(x,y){this.view=x;this.parent=y;this._cache={}}r.make=function(x){return(x instanceof r)?x:new r(x)};r.prototype.push=function(x){return new r(x,this)};r.prototype.lookup=function(x){var A=this._cache[x];if(!A){if(x=="."){A=this.view}else{var z=this;while(z){if(x.indexOf(".")>0){A=z.view;var B=x.split("."),y=0;while(A&&y<B.length){A=A[B[y++]]}}else{A=z.view[x]}if(A!=null){break}z=z.parent}}this._cache[x]=A}if(typeof A==="function"){A=A.call(this.view)}return A};function p(){this.clearCache()}p.prototype.clearCache=function(){this._cache={};this._partialCache={}};p.prototype.compile=function(z,x){var y=this._cache[z];if(!y){var A=v.parse(z,x);y=this._cache[z]=this.compileTokens(A,z)}return y};p.prototype.compilePartial=function(y,A,x){var z=this.compile(A,x);this._partialCache[y]=z;return z};p.prototype.getPartial=function(x){if(!(x in this._partialCache)&&this._loadPartial){this.compilePartial(x,this._loadPartial(x))}return this._partialCache[x]};p.prototype.compileTokens=function(z,y){var x=this;return function(A,C){if(C){if(typeof C==="function"){x._loadPartial=C}else{for(var B in C){x.compilePartial(B,C[B])}}}return o(z,x,r.make(A),y)}};p.prototype.render=function(z,x,y){return this.compile(z)(x,y)};function o(E,y,x,H){var B="";var z,F,G;for(var C=0,D=E.length;C<D;++C){z=E[C];F=z[1];switch(z[0]){case"#":G=x.lookup(F);if(typeof G==="object"){if(j(G)){for(var A=0,J=G.length;A<J;++A){B+=o(z[4],y,x.push(G[A]),H)}}else{if(G){B+=o(z[4],y,x.push(G),H)}}}else{if(typeof G==="function"){var I=H==null?null:H.slice(z[3],z[5]);G=G.call(x.view,I,function(K){return y.render(K,x)});if(G!=null){B+=G}}else{if(G){B+=o(z[4],y,x,H)}}}break;case"^":G=x.lookup(F);if(!G||(j(G)&&G.length===0)){B+=o(z[4],y,x,H)}break;case">":G=y.getPartial(F);if(typeof G==="function"){B+=G(x)}break;case"&":G=x.lookup(F);if(G!=null){B+=G}break;case"name":G=x.lookup(F);if(G!=null){B+=v.escape(G)}break;case"text":B+=F;break}}return B}function w(D){var y=[];var C=y;var E=[];var A;for(var z=0,x=D.length;z<x;++z){A=D[z];switch(A[0]){case"#":case"^":E.push(A);C.push(A);C=A[4]=[];break;case"/":var B=E.pop();B[5]=A[2];C=E.length>0?E[E.length-1][4]:y;break;default:C.push(A)}}return y}function a(C){var z=[];var B,y;for(var A=0,x=C.length;A<x;++A){B=C[A];if(B){if(B[0]==="text"&&y&&y[0]==="text"){y[1]+=B[1];y[3]=B[3]}else{y=B;z.push(B)}}}return z}function q(x){return[new RegExp(e(x[0])+"\\s*"),new RegExp("\\s*"+e(x[1]))]}v.parse=function(O,D){O=O||"";D=D||v.tags;if(typeof D==="string"){D=D.split(k)}if(D.length!==2){throw new Error("Invalid tags: "+D.join(", "))}var H=q(D);var z=new t(O);var F=[];var E=[];var C=[];var P=false;var N=false;function M(){if(P&&!N){while(C.length){delete E[C.pop()]}}else{C=[]}P=false;N=false}var A,y,G,I,B;while(!z.eos()){A=z.pos;G=z.scanUntil(H[0]);if(G){for(var J=0,K=G.length;J<K;++J){I=G.charAt(J);if(f(I)){C.push(E.length)}else{N=true}E.push(["text",I,A,A+1]);A+=1;if(I=="\n"){M()}}}if(!z.scan(H[0])){break}P=true;y=z.scan(s)||"name";z.scan(d);if(y==="="){G=z.scanUntil(g);z.scan(g);z.scanUntil(H[1])}else{if(y==="{"){G=z.scanUntil(new RegExp("\\s*"+e("}"+D[1])));z.scan(m);z.scanUntil(H[1]);y="&"}else{G=z.scanUntil(H[1])}}if(!z.scan(H[1])){throw new Error("Unclosed tag at "+z.pos)}B=[y,G,A,z.pos];E.push(B);if(y==="#"||y==="^"){F.push(B)}else{if(y==="/"){if(F.length===0){throw new Error('Unopened section "'+G+'" at '+A)}var x=F.pop();if(x[1]!==G){throw new Error('Unclosed section "'+x[1]+'" at '+A)}}else{if(y==="name"||y==="{"||y==="&"){N=true}else{if(y==="="){D=G.split(k);if(D.length!==2){throw new Error("Invalid tags at "+A+": "+D.join(", "))}H=q(D)}}}}}var x=F.pop();if(x){throw new Error('Unclosed section "'+x[1]+'" at '+z.pos)}E=a(E);return w(E)};var b=new p();v.clearCache=function(){return b.clearCache()};v.compile=function(y,x){return b.compile(y,x)};v.compilePartial=function(y,z,x){return b.compilePartial(y,z,x)};v.compileTokens=function(y,x){return b.compileTokens(y,x)};v.render=function(z,x,y){return b.render(z,x,y)};v.to_html=function(A,y,z,B){var x=v.render(A,y,z);if(typeof B==="function"){B(x)}else{return x}};return v}())));var UIK={};UIK.viewmodel={};UIK.view={};UIK.templates={};(function(b,a){a.config={};b.extend(a.config,{data:{points:{checked:{name:"Проверенные",createIcon:function(){return a.map.getIcon("uik-checked",20)},createLayer:function(){return new L.MarkerClusterGroup({disableClusteringAtZoom:17,iconCreateFunction:function(c){return new L.DivIcon({html:"<div><span>"+c.getChildCount()+"</span></div>",className:"marker-cluster marker-cluster-small",iconSize:new L.Point(40,40)})}})},searchCssClass:"checked",z:1},unchecked:{name:"Непроверенные",createIcon:function(){return a.map.getIcon("uik-unchecked",20)},createLayer:function(){return new L.MarkerClusterGroup({disableClusteringAtZoom:17,iconCreateFunction:function(c){return new L.DivIcon({html:"<div><span>"+c.getChildCount()+"</span></div>",className:"marker-cluster marker-cluster-medium",iconSize:new L.Point(40,40)})}})},searchCssClass:"non-checked",z:2},blocked:{name:"Заблокированные",createIcon:function(){return a.map.getIcon("uik-blocked",20)},createLayer:function(){return new L.MarkerClusterGroup({disableClusteringAtZoom:17,iconCreateFunction:function(c){return new L.DivIcon({html:"<div><span>"+c.getChildCount()+"</span></div>",className:"marker-cluster marker-cluster-large",iconSize:new L.Point(40,40)})}})},searchCssClass:"blocked",z:3},uik_2012:{name:"УИК 2012",createIcon:function(){return a.map.getIcon("uik-2012",20)},createLayer:function(){return new L.MarkerClusterGroup({disableClusteringAtZoom:17,iconCreateFunction:function(c){return new L.DivIcon({html:"<div><span>"+c.getChildCount()+"</span></div>",className:"marker-cluster marker-cluster-large",iconSize:new L.Point(40,40)})}})},searchCssClass:"uik2012",z:4}}}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{version:null});b.extend(a.view,{$document:null});a.loader={};b.extend(a.loader,{templates:["uikPopupTemplate","uikPopupInfoTemplate","searchResultsTemplate","userLogsTemplate","alertsTemplate"],init:function(){var c=this;this.setDomOptions();window.setTimeout(function(){c.initModules();b("img").imagesLoaded(function(){a.view.$body.removeClass("loading")})},1000)},initModules:function(){try{a.common.init();a.alerts.init();a.permalink.init();a.map.init();a.geocoder.init();a.searcher.init();a.searcher.address.init();a.searcher.tab.init();a.editor.init();a.user.init();a.uiks.init();a.uiks_2012.init();a.josm.init();a.editor.tab.init()}catch(c){alert(c)}},setDomOptions:function(){a.view.$document=b(document)}});b(document).ready(function(){a.loader.init()})})(jQuery,UIK);(function(b,a){a.helpers={};b.extend(a.helpers,{getIcon:function(d,c){return L.divIcon({className:d,iconSize:[c,c],iconAnchor:[c/2,c/2],popupAnchor:[0,2-(c/2)]})},hashToArrayKeyValues:function(d){var c=[];if(Object.prototype.toString.call(d)==="[object Array]"){return d}for(var e in d){if(!d.hasOwnProperty(e)){continue}c.push({key:e,val:d[e]})}return c},boolToString:function(d,c){switch(d){case null:return c?"null":"";break;case true:return c?"true":"Да";break;case false:return c?"false":"Нет";break}throw"The bool value is not convertible to string"},valueNullToString:function(c){if(c===null){return""}return c},sortByFields:function(){var d=arguments,c=this;return function(j,h){var f=0,e=0,g=d.length;while(e===0&&f<g){e=c.dynamicSort(d[f])(j,h);f++}return e}},dynamicSort:function(d){var c=1;if(d[0]==="-"){c=-1;d=d.substr(1,d.length-1)}return function(g,f){var e=(g[d]<f[d])?-1:(g[d]>f[d])?1:0;return e*c}}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{bodyPanelsVisible:[true,true,true,true]});b.extend(a.view,{$body:null,$popup:null});a.common={};b.extend(a.common,{init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){var c=this;a.view.$document.on("/sm/common/openPopup",function(f,g,d){c.openPopup(g,d)});a.view.$popup.find("a.close").off("click").on("click",function(){a.view.$body.removeClass("popup")});a.view.$document.on("/sm/common/setMainLoad",function(){a.view.$body.addClass("loader")})},openPopup:function(g,c){var f=a.view.$popup,e,d;f.find("div.header").text(g);f.find("div.content").html(c);e=f.width()/2;d=f.height()/2;f.css({"margin-left":-e+"px","margin-top":-d+"px"});a.view.$body.addClass("popup")},closePopup:function(){},setDomOptions:function(){a.view.$body=b("body");a.view.$popup=b("#popup")}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{map:null,mapLayers:{},isPopupOpened:false});b.extend(a.view,{$map:null});a.map={};b.extend(a.map,{defaultExtent:{latlng:new L.LatLng(55.742,37.658),zoom:17},init:function(){this.buildMap();this.buildLayerManager();this.buildLayers();a.map.lockHistory=false;a.map.extentHistory=[];a.map.extentHistoryPointer=-1;this.pushCurrentExtent();this.bindEvents();a.alerts.showAlert("historyShortcuts")},bindEvents:function(){var c=this;a.viewmodel.map.on("moveend",function(h){var g=h.target,d=g.getCenter(),f=g.getZoom();c.setLastExtentToCookie(d,f);a.map.pushCurrentExtent();a.view.$document.trigger("/uik/permalink/update",[d,f]);a.view.$document.trigger("/uik/map/updateAllLayers")});a.view.$document.on("/uik/map/updateAllLayers",function(){a.view.$document.trigger("/uik/uiks_2012/updateUiks");a.view.$document.trigger("/uik/uiks/updateUiks")});a.view.$document.on("/uik/map/openPopup",function(i,j,f){var g=a.viewmodel,d=g.mapLayers.select,h=g.map;h.panTo(j);h.openPopup(L.popup().setLatLng(j).setContent(f))});a.viewmodel.map.on("popupclose",function(){var d=a.viewmodel;d.isPopupOpened=false;d.mapLayers.select.clearLayers()});b("#map").keydown(function(d){if(d.keyCode==80){a.map.backwardExtentHistory()}if(d.keyCode==78){a.map.forwardExtentHistory()}})},pushCurrentExtent:function(){var c=[a.viewmodel.map.getCenter(),a.viewmodel.map.getZoom()];if(a.map.extentHistoryPointer>=0&&a.map.extentHistory[a.map.extentHistoryPointer][0].lat==c[0].lat&&a.map.extentHistory[a.map.extentHistoryPointer][0].lng==c[0].lng&&a.map.extentHistory[a.map.extentHistoryPointer][1]==c[1]){return}while(a.map.extentHistory.length-1>a.map.extentHistoryPointer){a.map.extentHistory.pop()}a.map.extentHistory.push(c);a.map.extentHistoryPointer++},backwardExtentHistory:function(){if(a.map.extentHistoryPointer>0){a.map.extentHistoryPointer-=1;var c=a.map.extentHistory[a.map.extentHistoryPointer];a.map.lockHistory=true;a.viewmodel.map.setView(c[0],c[1]);a.map.lockHistory=false}},forwardExtentHistory:function(){if(a.map.extentHistoryPointer+1<a.map.extentHistory.length){a.map.extentHistoryPointer+=1;var c=a.map.extentHistory[a.map.extentHistoryPointer];a.map.lockHistory=true;a.viewmodel.map.setView(c[0],c[1]);a.map.lockHistory=false}},buildMap:function(){var e=a.viewmodel,d=this.getExtentFromUrl(),c;a.view.$map=b("#map");e.map=new L.Map("map");L.control.scale().addTo(e.map);if(d){e.map.setView(d.latlng,d.zoom);this.setLastExtentToCookie(d.latlng,d.zoom)}else{lastExtent=this.getLastExtentFromCookie();if(lastExtent){e.map.setView(lastExtent.latlng,lastExtent.zoom)}else{e.map.setView(this.defaultExtent.latlng,this.defaultExtent.zoom);this.setLastExtentToCookie(this.defaultExtent.latlng,this.defaultExtent.zoom)}}a.view.$document.trigger("/uik/permalink/update",[e.map.getCenter(),e.map.getZoom()]);c=L.layerGroup();e.map.addLayer(c);e.mapLayers.select=c},buildLayers:function(){var g=a.config.data.points,d,f,c,e={},h=[];a.viewmodel.mapLayers.points={};for(d in g){if(g.hasOwnProperty(d)){f=g[d].createLayer();a.viewmodel.map.addLayer(f);a.viewmodel.mapLayers.points[d]=f;e[g[d].z]=d;h.push(g[d].z)}}h.sort(function(j,i){return i-j});b.each(h,function(j,k){a.viewmodel.mapLayers.points[e[k]].bringToFront()})},getLastExtentFromCookie:function(){var e=parseFloat(b.cookie("map.lat"),10),c=parseFloat(b.cookie("map.lng"),10),d=parseInt(b.cookie("map.zoom"),10);if(e&&c&&d){return{latlng:new L.LatLng(e,c),zoom:d}}else{return null}},setLastExtentToCookie:function(d,c){b.cookie("map.lat",d.lat,{expires:7,path:"/"});b.cookie("map.lng",d.lng,{expires:7,path:"/"});b.cookie("map.zoom",c,{expires:7,path:"/"})},getExtentFromUrl:function(){var e=parseFloat(this.getURLParameter("lat")),c=parseFloat(this.getURLParameter("lon")),d=parseFloat(this.getURLParameter("zoom"));if(e&&c&&d){return{latlng:new L.LatLng(e,c),zoom:d}}return null},getURLParameter:function(c){return decodeURI((RegExp(c+"=(.+?)(&|$)").exec(location.search)||[,null])[1])}})})(jQuery,UIK);(function(b,a){b.extend(a.map,{getIcon:function(d,c){return L.divIcon({className:d,iconSize:[c,c],iconAnchor:[c/2,c/2],popupAnchor:[0,2-(c/2)]})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{currentTileLayer:null});b.extend(a.view,{$tileLayers:null,$manager:null});b.extend(a.map,{_layers:{},_lastIndex:0,buildLayerManager:function(){var c=a.view;a.view.$manager=b("#manager");this.addTileLayer("osm","http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png","© OpenStreetMap contributors");this.addBingLayer("AujH--7B6FRTK8b81QgPhuvw_Sb3kc8hBO-Lp5OLNyhCD4ZQoGGW4cQS6zBgaeEh");a.view.$tileLayers=c.$map.find("div.leaflet-tile-pane div.leaflet-layer");this.bindLayerManagerEvents();this.onLayer("osm")},bindLayerManagerEvents:function(){var c=this;a.viewmodel.map.off("zoomend").on("zoomend",function(){c.onLayer()});a.view.$manager.find("div.tile-layers div.icon").off("click").on("click",function(d){c.onLayer(b(this).data("layer"))})},onLayer:function(e){var d=a.viewmodel,c=a.view,f=b(a.viewmodel.map.getPanes().tilePane).find("div.leaflet-layer");if(e){c.$body.removeClass(d.currentTileLayer).addClass(e);d.currentTileLayer=e;f.hide().eq(this._layers[e].index).show()}else{f.hide().eq(this._layers[d.currentTileLayer].index).show()}},addTileLayer:function(f,d,c){var e=new L.TileLayer(d,{minZoom:8,maxZoom:18,attribution:c});this._layers[f]={layer:a.viewmodel.map.addLayer(e,true),index:this._lastIndex};this._lastIndex=+1},addBingLayer:function(d){var c=new L.BingLayer(d,{minZoom:8,maxZoom:18});this._layers.bing={layer:a.viewmodel.map.addLayer(c,true),index:this._lastIndex};this._lastIndex=+1}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{});a.geocoder={};b.extend(a.geocoder,{init:function(){this.bindEvents()},bindEvents:function(){},directGeocode:function(d,e){var c="http://beta.openstreetmap.ru/api/search?callback=?&q="+d;b.ajax({type:"GET",url:c,async:false,jsonpCallback:"jsonCallback",contentType:"application/json",dataType:"jsonp",success:function(f){e(f)}})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{searcherCollapsed:false,filter:{},isFilterValidated:true});b.extend(a.view,{$searchContainer:null,$filterName:null,$$filterAddr:null,$searchButton:null,$uiksSearchResults:null,$uikspSearchResults:null,$clearSearch:null});a.searcher={};b.extend(a.searcher,{min_characters_count:3,init:function(){this.setDomOptions();this.initFilter();this.bindEvents()},setDomOptions:function(){var c=a.view;c.$searchContainer=b("#searchContainer");c.$filterName=b("#filter_name");c.$filterAddr=b("#filter_address");c.$searchButton=b("#search");c.$uiksSearchResults=b("#searchUIK").find("div.searchResults");c.$uikspSearchResults=b("#searchUIK_2012").find("div.searchResults");c.$clearSearch=c.$searchContainer.find("a.clear-search")},initFilter:function(){var g=this,e=a.view,f,d,i,c,j,h;e.$searchContainer.find("div.search-block").each(function(k){f=b(this);d=f.data("filter");h=a.viewmodel.filter;h[d]={};h[d].json={};h[d].is_valid=true;h[d].trigger=f.data("trigger");h[d].btn_search=f.find("div.search");h[d].clear_search=f.find("a.clear-search");h[d].elements={};f.find("input.filterable").each(function(){(function(l,n,m){i=b(l);c=i.data("filter");a.viewmodel.filter[n].elements[c]={element:i,is_valid:true};m[n].json[c]=""})(this,d,h)})})},bindEvents:function(){var c=a.view,d=this;this.bindKeyUpHandlers();c.$searchContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){a.viewmodel.searcherCollapsed=!a.viewmodel.searcherCollapsed;a.view.$body.toggleClass("searcher-collapsed",d.searcherCollapsed)});c.$document.on("/sm/searcher/update",function(){d.updateSearch()})},bindKeyUpHandlers:function(){var e=this,d=a.viewmodel.filter,f,i,g,k,j,c,h;for(i in d){if(d.hasOwnProperty(i)){f=d[i];for(k in f.elements){if(f.elements.hasOwnProperty(k)){g=f.elements[k].element;(function(n,l,m){n.off("keyup").on("keyup",function(o){h=b(this);if(o.keyCode===13){if(m.validateFilter(l)){m.applyFilter(l)}}else{j=m[h.data("validate")](h.val());h.toggleClass("invalid",!j);l.elements[k].is_valid=j;c=m.validateFilter(l);l.btn_search.toggleClass("active",c);if(c){m.buildFilterJson(l)}if(c&&m.isEmptyFilters(l)){l.btn_search.removeClass("active")}}});l.clear_search.off("click").on("click",function(){b.each(l.elements,function(){this.element.val("")});m.applyFilter(l)});l.btn_search.off("click").on("click",function(){if(b(this).hasClass("active")){m.applyFilter(l)}})})(g,f,e)}}}}},validateFilter:function(c){var e=c.elements,d;for(d in e){if(e.hasOwnProperty(d)&&!e[d].is_valid){c.is_valid=false;return false}}c.is_valid=true;return true},isEmptyFilters:function(d){var e=d.elements,c;for(c in e){if(e.hasOwnProperty(c)){if(b.trim(e[c].element.val())!==""){return false}}}return true},validateDefault:function(d){var c=b.trim(d);return c.length>this.min_characters_count||c===""},validateNumber:function(d){var c=b.trim(d);return c.length>2||c===""},applyFilter:function(c){this.buildFilterJson(c);this.search(c)},buildFilterJson:function(d){var e=d.elements,c;for(c in e){if(e.hasOwnProperty(c)){d.json[c]=b.trim(e[c].element.val())}}},search:function(c){a.view.$document.trigger(c.trigger)},updateSearch:function(){var d=a.viewmodel.pointLayers.uiks,c=a.config.data.points,g,f=a.view.$uiksSearchResults.find("div"),e;f.empty();for(g in d){if(d.hasOwnProperty(g)){e=this.getHtmlForSearchResults(c[g].searchCssClass,d[g].elements);f.append(e)}}f.find("a.target").on("click",function(){var h=b(this).parent();a.viewmodel.map.setView(new L.LatLng(h.data("lat"),h.data("lon")),18);b("#target").show().delay(1000).fadeOut(1000)});f.find("a.edit").on("click",function(){if(a.viewmodel.editable){return false}var i=b(this).parent(),h;a.viewmodel.map.setView(new L.LatLng(i.data("lat"),i.data("lon")),18);b("#target").show().delay(1000).fadeOut(1000);h=i.data("id");b.getJSON(document.url_root+"uik/"+h,function(j){if(!a.viewmodel.editable){a.viewmodel.uikSelected=j;a.view.$document.trigger("/uik/editor/startEdit")}})});f.prop("class","active");f=a.view.$uikspSearchResults.find("div");d=a.viewmodel.pointLayers.uiksp;f.empty();for(g in d){if(d.hasOwnProperty(g)){e=a.templates.searchResultsTemplate({cssClass:c[g].searchCssClass,uiks:d[g].elements,isAuth:false});f.append(e)}}f.find("a.target").on("click",function(){var h=b(this).parent();a.viewmodel.map.setView(new L.LatLng(h.data("lat"),h.data("lon")),18);b("#target").show().delay(1000).fadeOut(1000)});f.prop("class","active")},getHtmlForSearchResults:function(c,d){return a.templates.searchResultsTemplate({cssClass:c,uiks:d,isAuth:a.viewmodel.isAuth})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{$divAddressSearchResults:null});a.searcher.address={};b.extend(a.searcher.address,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$divAddressSearchResults=b("#searchAddress").find("div.searchResults div")},bindEvents:function(){var c=this;a.view.$document.on("/uik/search/address",function(){c.searchAddress()})},searchAddress:function(){var d=this,c=a.view.$divAddressSearchResults,e;c.empty();a.geocoder.directGeocode(a.viewmodel.filter.address.json.address,function(f){e=f.matches;c.append(d.getHtmlForSearchResults("",e));c.find("a.target").on("click",function(){var g=b(this).parent();a.viewmodel.map.setView(new L.LatLng(g.data("lat"),g.data("lon")),16);b("#target").show().delay(1000).fadeOut(1000)})})},getHtmlForSearchResults:function(c,d){return a.templates.addressSearchTemplate({cssClass:c,matches:d})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{$activatedSearchTab:null});a.searcher.tab={};b.extend(a.searcher.tab,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$activatedSearchTab=a.view.$searchContainer.find("ul.nav li.active")},bindEvents:function(){var c=this,d;a.view.$searchContainer.find("ul.nav li").off("click").on("click",function(f){d=b(this);if(d.data("id")!==a.view.$activatedSearchTab.data("id")){c.activateTab(d)}})},activateTab:function(d){var c=a.view;c.$activatedSearchTab.removeClass("active");c.$activatedSearchTab=d.addClass("active");c.$searchContainer.attr("class",d.data("id"))}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{editorCollapsed:false,editable:false,latlngEditable:{lat:{validated:null,marker:null,editor:null},lng:{validated:null,marker:null,editor:null},isNeedApplied:false,sourceCoordinates:null},markerEditable:null});b.extend(a.view,{$editorContainer:null});a.editor={};b.extend(a.editor,{regex:{url:new RegExp("(https?)://[-A-Za-z0-9+&@#/%?=~_|!:,.;]*[-A-Za-z0-9+&@#/%=~_|]")},precisionDegree:6,init:function(){this.setDomOptions();this.buildEditLayer();this.bindEvents()},setDomOptions:function(){a.view.$editorContainer=b("#editorContainer");a.viewmodel.editorCollapsed=a.view.$body.hasClass("editor-collapsed")},buildEditLayer:function(){var c=L.layerGroup();a.viewmodel.mapLayers.edit=c;a.viewmodel.map.addLayer(c)},bindEvents:function(){var c=this;a.view.$editorContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){c.toggleEditor()});a.view.$document.on("/uik/editor/startEdit",function(d){c.startAjaxEdition()});b("#save").off("click").on("click",function(d){d.stopPropagation();c.save()});b("#discard").off("click").on("click",function(f){var d=a.viewmodel;f.stopPropagation();if(!d.latlngEditable.sourceCoordinates.equals(d.markerEditable.getLatLng())){d.map.setView(d.latlngEditable.sourceCoordinates,18);b("#target").show().delay(1000).fadeOut(1000)}c.finishAjaxEdition()});b("#editorForm").find(":checkbox").off("click").on("click",function(){var e=b(this),d=b("#"+e.data("id"));if(e.is(":checked")){d.val(1)}else{d.val(0)}});b("#lat, #lng").off("keyup").on("keyup",function(d){c.coordinatesInputHandler(d,b(this))});b("#applyCoordinates").off("click").on("click",function(){c.applyCoordinates(a.viewmodel.latlngEditable)});b("#undoCoordinates").off("click").on("click",function(){c.undoCoordinates()});b("#resetCenter").off("click").on("click",function(){c.resetCenter()})},toggleEditor:function(){var c=!a.viewmodel.editorCollapsed;a.viewmodel.editorCollapsed=c;a.view.$body.toggleClass("editor-collapsed",c)},coordinatesInputHandler:function(g,h){var c=h.attr("id"),j=h.val(),k=a.viewmodel.latlngEditable,l=k[c],d=l.validated,i=l.editor!==l.marker,f=k.isNeedApplied;if(g.keyCode===13){if(k.isNeedApplied){this.applyCoordinates(k)}}else{l.validated=this.verifyDecimalDegree(j);if(l.validated){j=parseFloat(j.replace(",",".")).toFixed(this.precisionDegree);l.editor=j}else{a.alerts.showAlert("validateCoordinatesError")}k.isNeedApplied=this.getIsCanApplied(k);if(f!==k.isNeedApplied){b("#applyCoordinates").prop("disabled",!k.isNeedApplied)}if(k.isNeedApplied){a.alerts.showAlert("changeCoordinates")}if(d!==l.validated){h.toggleClass("invalid",!l.validated)}else{if(i!==(l.editor!==l.marker)){h.toggleClass("need-apply",l.editor!==l.marker)}}}},getIsCanApplied:function(c){if(!c.lat.validated||!c.lng.validated){return false}return c.lat.editor!==c.lat.marker||c.lng.editor!==c.lng.marker},verifyDecimalDegree:function(c){return !/^\s*$/.test(c)&&!isNaN(c)},applyCoordinates:function(c){var d=a.viewmodel,e=new L.LatLng(parseFloat(c.lat.editor),parseFloat(c.lng.editor));this.updateCoordinates(e);d.markerEditable.setLatLng(e);d.map.setView(e,18);b("#target").show().delay(1000).fadeOut(1000);b("#lat, #lng").removeClass("need-apply");b("#undoCoordinates").prop("disabled",false)},undoCoordinates:function(){var c=a.viewmodel,d=new L.LatLng(c.uikSelected.uik.old_geom.lat,c.uikSelected.uik.old_geom.lng);this.updateCoordinates(d);c.markerEditable.setLatLng(d);c.map.setView(d,c.map.getZoom());b("#undoCoordinates").prop("disabled",true)},resetCenter:function(){var c=a.viewmodel.map.getCenter();this.updateCoordinates(c);a.viewmodel.markerEditable.setLatLng(c);b("#undoCoordinates").prop("disabled",false)},startAjaxEdition:function(){var c=this;b.ajax({type:"GET",url:document.url_root+"uik/block/"+a.viewmodel.uikSelected.uik.id}).done(function(){c.startEdit()})},startEdit:function(){var d=a.viewmodel,c=a.view;c.$body.addClass("editable");if(d.editorCollapsed){this.toggleEditor()}c.$editorContainer.find("input, select, textarea, button").removeAttr("disabled");c.$editorContainer.find("form").removeClass("disabled");d.editable=true;this.startEditingGeometry(d.uikSelected.uik.geom.lat,d.uikSelected.uik.geom.lng);this.fillEditor(d.uikSelected);d.uikSelected.uik.old_geom=jQuery.extend({},d.uikSelected.uik.geom);a.uiks.versions.showVersions();d.map.closePopup();b("#editUIK-link").click()},startEditingGeometry:function(h,e){var f=this,d=L.marker([h,e],{icon:a.helpers.getIcon("stop-editable",25),draggable:true}),c=h.toFixed(this.precisionDegree),g=e.toFixed(this.precisionDegree);d.on("dragend",function(i){f.updateCoordinates(i.target.getLatLng());b("#undoCoordinates").prop("disabled",false)});a.viewmodel.mapLayers.edit.addLayer(d);b("#applyCoordinates").prop("disabled",true);b("#undoCoordinates").prop("disabled",true);a.viewmodel.latlngEditable={lat:{validated:true,marker:c,editor:c},lng:{validated:true,marker:g,editor:g},isNeedApplied:false,sourceCoordinates:new L.LatLng(h,e)};a.viewmodel.markerEditable=d},updateCoordinates:function(f){var h=f.lat.toFixed(this.precisionDegree),d=f.lng.toFixed(this.precisionDegree),g=a.viewmodel,c=g.latlngEditable.isNeedApplied,e=g.latlngEditable.sourceCoordinates;g.uikSelected.uik.geom.lat=f.lat;g.uikSelected.uik.geom.lng=f.lng;if(c){b("#applyCoordinates").prop("disabled",true)}g.latlngEditable={lat:{validated:true,marker:h,editor:h},lng:{validated:true,marker:d,editor:d},isNeedApplied:false,sourceCoordinates:e};b("#lat").val(h);b("#lng").val(d)},fillEditor:function(d){var c=a.helpers;b("#name").val(d.uik.number_official).attr("disabled","disabled");b("#region").val(d.region.name).attr("disabled","disabled");b("#tik").val(d.tik.name).attr("disabled","disabled");b("#address_voting").val(c.valueNullToString(d.uik.address_voting));b("#place_voting").val(c.valueNullToString(d.uik.place_voting));b("#geo_precision option:eq("+d.geo_precision.id+")").prop("selected",true);b("#lat").val(d.uik.geom.lat.toFixed(this.precisionDegree));b("#lng").val(d.uik.geom.lng.toFixed(this.precisionDegree));b("#comment").val(c.valueNullToString(d.uik.comment));if(d.uik.is_applied){b("#is_applied").val(1);b("#chb_is_applied").prop("checked",true)}else{b("#is_applied").val(0);b("#chb_is_applied").prop("checked",false)}},save:function(){if(!this.verifyEditor()){return}var h=this,j=b("#editorContainer form"),k=j.serializeArray(),d=k.length,c=a.viewmodel.uikSelected,f={id:c.uik.id},e=document.url_root+"uik/"+f.id,g=0;for(g;g<d;g+=1){f[k[g].name]=k[g].value}f.geom=c.uik.geom;b.ajax({type:"POST",url:e,data:{uik:JSON.stringify(f)}}).done(function(){a.alerts.showAlert("saveSuccessful");h.finishEditing()}).error(function(){a.alerts.showAlert("saveError")})},verifyEditor:function(){var d=true,c=a.viewmodel.latlngEditable;if(c.isNeedApplied){d=false;a.alerts.showAlert("notAppliedCoordinates")}if(!c.lat.validated||!c.lng.validated){d=false;a.alerts.showAlert("validateCoordinatesError")}return d},finishAjaxEdition:function(){var c=this;b.ajax({type:"GET",url:document.url_root+"uik/unblock/"+a.viewmodel.uikSelected.uik.id}).done(function(){c.finishEditing()})},finishEditing:function(){var d=a.viewmodel,c=a.view;d.map.closePopup();d.mapLayers.edit.clearLayers();d.editable=false;c.$body.addClass("editable");c.$editorContainer.find("input, textarea").val("");c.$editorContainer.find("input:checkbox").prop("checked",false);c.$editorContainer.find("input, select, textarea, button").attr("disabled","disabled").removeClass("invalid");c.$editorContainer.find("form").addClass("disabled");a.view.$document.trigger("/uik/map/updateAllLayers")}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{uikSelected:null,uikSelectedId:null,pointLayers:{}});b.extend(a.view,{});a.uiks={};b.extend(a.uiks,{init:function(){this.updatePoints();this.bindEvents()},bindEvents:function(){var c=this;a.view.$document.on("/uik/uiks/updateUiks",function(){c.updatePoints()})},updatePoints:function(){var c=this.validateZoom();this.clearLayers();if(!c){return}a.view.$document.trigger("/uik/uiks/startUpdate");this.updateUiksByAjax()},clearLayers:function(){var c=a.viewmodel.mapLayers;c.points.checked.clearLayers();c.points.unchecked.clearLayers();c.points.blocked.clearLayers()},updateUiksByAjax:function(){var d=this,c=document.url_root+"uik/all",e=a.viewmodel.filter,f={uik:e.uik.json,uik_2012:e.uik_2012.json};b.ajax({type:"GET",url:c,data:{bbox:JSON.stringify(a.viewmodel.map.getBounds()),center:JSON.stringify(a.viewmodel.map.getCenter()),filter:JSON.stringify(f)},dataType:"json",success:function(g){d.renderUiks(g);a.view.$document.trigger("/sm/searcher/update");a.view.$document.trigger("/sm/stops/endUpdate")},context:d})},renderUiks:function(j){var d=a.viewmodel,q=d.mapLayers.points,o=a.config.data.points,n=j.data.points.layers,p,k,m,c,l,h,g,f=a.templates.uikPopupTemplate({css:"edit"}),e=this;d.pointLayers.uiks=j.data.points.layers;for(p in n){if(n.hasOwnProperty(p)){k=n[p].elements;m=n[p].count;if(m>0){l=o[p].createIcon()}for(g=0;g<m;g+=1){c=k[g];h=L.marker([c.lat,c.lon],{icon:l}).on("click",function(r){var i=r.target;a.view.$document.trigger("/uik/map/openPopup",[i.getLatLng(),f]);e.buildUikPopup(i.id)});h.id=c.id;q[p].addLayer(h)}}}},buildUikPopup:function(c){return b.getJSON(document.url_root+"uik/"+c,function(e){if(!a.viewmodel.editable){a.viewmodel.uikSelected=e}var d=a.templates.uikPopupInfoTemplate({uik:e.uik,tik:e.tik,region:e.region,geo_precision:e.geo_precision,isUserEditor:a.viewmodel.isAuth,editDenied:a.viewmodel.editable||e.uik.is_blocked,isBlocked:e.uik.is_blocked,userBlocked:e.uik.user_blocked,isUnBlocked:e.uik.is_unblocked});b("#uik-popup").removeClass("loader").empty().append(d);b("button#edit").off("click").on("click",function(){a.view.$document.trigger("/uik/editor/startEdit")});if(e.uik.is_unblocked){b("#unblock").off("click").on("click",function(){b.ajax({type:"GET",url:document.url_root+"uik/unblock/"+a.viewmodel.uikSelected.uik.id}).done(function(){a.viewmodel.map.closePopup();a.view.$document.trigger("/uik/map/updateAllLayers")})})}a.uiks.versions.showVersions();b("#versionsUIK-link").click()}).error(function(){b("#uik-popup").removeClass("loader").empty().append("Error connection")})},validateZoom:function(){if(a.viewmodel.map.getZoom()<14){a.alerts.showAlert("zoom");return false}return true}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{uikSelected:null,uikSelectedId:null});b.extend(a.view,{});a.uiks_2012={};b.extend(a.uiks_2012,{init:function(){this.updatePoints();this.bindEvents()},bindEvents:function(){var c=this;a.view.$document.on("/uik/uiks_2012/updateUiks",function(){c.updatePoints()})},updatePoints:function(){var c=this.validateZoom();this.clearLayers();if(!c){return}a.view.$document.trigger("/uik/uiks_2012/startUpdate");this.updateUiksByAjax()},clearLayers:function(){a.viewmodel.mapLayers.points.uik_2012.clearLayers()},updateUiksByAjax:function(){var d=this,c=document.url_root+"uikp/all",e=a.viewmodel.filter,f={uik:e.uik.json,uik_2012:e.uik_2012.json};b.ajax({type:"GET",url:c,data:{bbox:JSON.stringify(a.viewmodel.map.getBounds()),center:JSON.stringify(a.viewmodel.map.getCenter()),filter:JSON.stringify(f)},dataType:"json",success:function(g){d.renderUiks(g);a.view.$document.trigger("/sm/searcher/update");a.view.$document.trigger("/sm/stops/endUpdate")},context:d})},renderUiks:function(j){var d=a.viewmodel,q=d.mapLayers.points,o=a.config.data.points,n=j.points.layers,p,k,m,c,l,h,g,f=a.templates.uikPopupTemplate({css:"edit"}),e=this;d.pointLayers.uiksp=j.points.layers;for(p in n){if(n.hasOwnProperty(p)){k=n[p].elements;m=n[p].count;if(m>0){l=o[p].createIcon()}for(g=0;g<m;g+=1){c=k[g];h=L.marker([c.lat,c.lon],{icon:l}).on("click",function(r){var i=r.target;a.view.$document.trigger("/uik/map/openPopup",[i.getLatLng(),f]);e.buildUikPopup(i.id)});h.id=c.id;q[p].addLayer(h)}}}},buildUikPopup:function(c){return b.getJSON(document.url_root+"uikp/"+c,function(e){var d=a.templates.uik2012PopupInfoTemplate({uikp:e.uikp});b("#uik-popup").removeClass("loader").empty().append(d)}).error(function(){b("#uik-popup").removeClass("loader").empty().append("Error connection")})},validateZoom:function(){if(a.viewmodel.map.getZoom()<14){a.alerts.showAlert("zoom");return false}return true}})})(jQuery,UIK);(function(b,a){a.alerts={};b.extend(a.view,{$alerts:null});b.extend(a.viewmodel,{alerts:{}});b.extend(a.alerts,{alerts:{historyShortcuts:{id:"historyShortcuts",type:"info",text:"Используйте клавиши p и n при работе с картой",statusText:"Можно перемещаться по истории экранов."},zoom:{id:"zoom",type:"alert",text:"Увеличьте масштаб для отображения УИКов",statusText:"Мелкий масштаб!"},saveSuccessful:{id:"saveSuccessful",type:"info",text:"УИК был успешно обновлен",statusText:""},saveError:{id:"saveError",type:"error",text:"УИК не был обновлен - произошла ошибка.",statusText:"Ошибка!"},changeCoordinates:{id:"coodrinateChanged",type:"info",text:"После изменения координаты должны быть применены.",statusText:"Внимание! "},notAppliedCoordinates:{id:"notAppliedCoordinates",type:"error",text:"Вы не применили координаты к редактируемому УИКу. ",statusText:"Ошибка сохранения:"},validateCoordinatesError:{id:"valCoordError",type:"error",text:"Десятичные градусы должны быть введены как 58.00000",statusText:"Неправильный формат ввода координат:"}},init:function(){a.view.$alerts=b("#alerts")},showAlert:function(d){if(!this.alerts[d]||a.viewmodel.alerts[d]){return false}a.viewmodel.alerts[d]=true;var c=a.templates.alertsTemplate(this.alerts[d]);a.view.$alerts.append(c);b("#alert_"+this.alerts[d].id).fadeIn().delay(2000).fadeOut("slow",function(){b(this).remove();a.viewmodel.alerts[d]=false})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{isAuth:false});b.extend(a.view,{$userContainer:null,$signInForm:null,$signOutForm:null});a.user={};b.extend(a.user,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$userContainer=b("#userContainer");a.view.$signInForm=b("#signInForm");a.view.$signOutForm=b("#signOutForm");if(a.view.$userContainer.hasClass("inner")){a.viewmodel.isAuth=true}},bindEvents:function(){var c=this;b("#signOutForm div.log").off("click").on("click",function(){c.renderLogs()})},renderLogs:function(){var c=document.url_root+"logs";a.view.$document.trigger("/sm/common/setMainLoad");b.ajax({type:"GET",url:c,dataType:"json",success:function(e){var d=a.templates.userLogsTemplate({user_logs:e.uiks_by_users,count_all:e.count.all,count_editable:e.count.editable,percent:(e.count.editable/e.count.all*100).toFixed(2)});a.view.$body.removeClass("loader");a.view.$document.trigger("/sm/common/openPopup",["Статистика пользователей",d])}})}})})(jQuery,UIK);(function(b,a){b.extend(a.view,{$permalink:null,$fb_link:null});a.permalink={};b.extend(a.permalink,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$permalink=b("#permalink");a.view.$fb_link=b("#rightPanel a.facebook")},bindEvents:function(){a.view.$document.on("/uik/permalink/update",function(f,g,e){var c=a.view,d=document.url_root+"?lat="+g.lat+"&lon="+g.lng+"&zoom="+e;c.$permalink.prop("href",d);c.$fb_link.prop("href","https://www.facebook.com/sharer/sharer.php?u="+d)})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{$josmLink:null});a.josm={};b.extend(a.josm,{init:function(){this.bindEvents();this.setDomOptions()},setDomOptions:function(){a.view.$josmLink=b("#josm-link")},bindEvents:function(){b("#json_link").on("mouseover",function(){var d=a.viewmodel.map.getBounds(),c=("http://127.0.0.1:8111/load_and_zoom?left="+d.getNorthWest().lng+"&top="+d.getNorthWest().lat+"&right="+d.getSouthEast().lng+"&bottom="+d.getSouthEast().lat);b(this).attr("href",c)})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{version:null});b.extend(a.view,{$document:null});a.uiks.versions={};b.extend(a.uiks.versions,{init:function(){this.setDomOptions()},showVersions:function(){var d=b("#versionsUIK");d.empty();if(typeof a.viewmodel.uikSelected.versions=="object"&&a.viewmodel.uikSelected.versions.length>0){for(var f in a.viewmodel.uikSelected.versions){var c=a.viewmodel.uikSelected.versions[f];var e=a.templates.versionsTemplate({num:+f+1,name:c.display_name,time:c.time});d.append(e)}}else{d.append("У этого УИКа нет сохраненных версий")}}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{$activatedEditorTab:null});a.editor.tab={};b.extend(a.editor.tab,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$activatedEditorTab=a.view.$editorContainer.find("ul.nav li.active")},bindEvents:function(){var c=this,d;a.view.$editorContainer.find("ul.nav li").off("click").on("click",function(f){d=b(this);if(d.data("id")!==a.view.$activatedEditorTab.data("id")){c.activateTab(d)}})},activateTab:function(d){var c=a.view;c.$activatedEditorTab.removeClass("active");c.$activatedEditorTab=d.addClass("active");c.$editorContainer.attr("class",d.data("id"))}})})(jQuery,UIK);UIK.templates={};UIK.templates.uikPopupTemplate=Mustache.compile('<div id="uik-popup" class="{{css}} loader"></div>');UIK.templates.userLogsTemplate=Mustache.compile('<table class="table table-striped logs"> <caption>Общая статистика</caption> <tr> <th>Показатель</th> <th>Значение</th> </tr> <tr> <td>Всего УИКов</td> <td class="stop">{{count_all}}</td> </tr> <tr> <td>Отредактировано УИКов</td> <td class="stop">{{count_editable}}</td> </tr> <tr> <td>Отредактировано, %</td> <td class="stop">{{percent}}</td> </tr> </table> <table class="table table-striped logs"> <caption>Статистика по пользователям</caption> <tr> <th>Пользователь</th> <th>Кол-во УИКов</th> </tr> {{#user_logs}} <tr> <td>{{user_name}}</td> <td class="stop">{{count_uiks}}</td> </tr> {{/user_logs}} </table>');UIK.templates.versionsTemplate=Mustache.compile("<ul> <li> <b>v{{num}}</b> {{time}}, {{name}} </li> </ul>");UIK.templates.searchResultsTemplate=Mustache.compile('<ul class="{{cssClass}}"> {{#uiks}} <li data-lat={{lat}} data-lon={{lon}} data-id={{id}}> <span>{{name}}</span> {{addr}} <a class="target" title="Перейти к УИКу"></a> {{#isAuth}}<a class="edit" title="Редактировать УИК"></a>{{/isAuth}} </li> {{/uiks}} </ul>');UIK.templates.uikPopupInfoTemplate=Mustache.compile('<table class="table table-striped"> <tr> <td>Номер УИКа</td> <td>{{uik.number_official}}</td> </tr> <tr> <td>ТИК</td> <td>{{tik.name}}</td> </tr> <tr> <td>Регион</td> <td>{{region.name}}</td> </tr> <tr> <td>Адрес голосования</td> <td>{{uik.address_voting}}</td> </tr> <tr> <td>Место помещения голосования</td> <td>{{uik.place_voting}}</td> </tr> <tr> <td>Точность геокодирования</td> <td>{{geo_precision.name_ru}}</td> </tr> <tr> <td>Комментарий</td> <td>{{uik.comment}}</td> </tr> <tr> <td>Проверен</td> <td> {{#uik.is_applied}}Да{{/uik.is_applied}} {{^uik.is_applied}}Нет{{/uik.is_applied}} </td> </tr> {{#isBlocked}} <tr class="block"> {{#isUnBlocked}} <td>Заблокирована вами</td> <td> <button class="btn btn-small btn-primary block" id="unblock" type="button">Разблокировать</button> </td> {{/isUnBlocked}} {{^isUnBlocked}} <td>Заблокировал</td> <td>{{userBlocked}}</td> {{/isUnBlocked}} </tr> {{/isBlocked}} </table> {{#isUserEditor}} <div class="edit"> <button class="btn btn-small btn-primary {{#isBlock}}block{{/isBlock}}" id="edit" type="button" {{#editDenied}}disabled="disabled"{{/editDenied}}>Редактировать</button> </div> {{/isUserEditor}} ');UIK.templates.osmPopupTemplate=Mustache.compile('<div class="osm-popup"> <div class="caption"> <span>{{id}}</span> <a href="{{link}}" target="_blank" title="Посмотреть на OpenStreetMaps" class="osm"></a> </div> <table class="table table-striped"> {{#tags}} <tr> <td>{{key}}</td> <td>{{val}}</td> </tr> {{/tags}} </table> </div>');UIK.templates.alertsTemplate=Mustache.compile('<div id="alert_{{id}}" class="alert alert-{{type}}" style="display: none;"> <button type="button" class="close" data-dismiss="alert">&times;</button> <strong>{{statusText}}</strong> {{text}} </div>');UIK.templates.uik2012PopupInfoTemplate=Mustache.compile('<table class="table table-striped"> <tr> <td>Номер УИКа</td> <td>{{uikp.name}}</td> </tr> <tr> <td>Адрес</td> <td>{{uikp.address}}</td> </tr> <tr> <td>Комментарий</td> <td>{{uikp.comment}}</td> </tr> </table> ');UIK.templates.addressSearchTemplate=Mustache.compile('<ul class="{{cssClass}}"> {{#matches}} <li data-lat={{lat}} data-lon={{lon}} data-id={{id}}> {{display_name}} <a class="target" title="Перейти к объекту"></a> </li> {{/matches}} </ul>');