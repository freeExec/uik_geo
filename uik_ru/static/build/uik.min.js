(function(a,b){L.MarkerClusterGroup=L.FeatureGroup.extend({options:{maxClusterRadius:80,iconCreateFunction:null,spiderfyOnMaxZoom:true,showCoverageOnHover:true,zoomToBoundsOnClick:true,singleMarkerMode:false,disableClusteringAtZoom:null,animateAddingMarkers:false,spiderfyDistanceMultiplier:1,polygonOptions:{}},initialize:function(c){L.Util.setOptions(this,c);if(!this.options.iconCreateFunction){this.options.iconCreateFunction=this._defaultIconCreateFunction}L.FeatureGroup.prototype.initialize.call(this,[]);this._inZoomAnimation=0;this._needsClustering=[];this._currentShownBounds=null},addLayer:function(e){if(e instanceof L.LayerGroup){var g=[];for(var d in e._layers){if(e._layers.hasOwnProperty(d)){g.push(e._layers[d])}}return this.addLayers(g)}if(!this._map){this._needsClustering.push(e);return this}if(this.hasLayer(e)){return this}if(this._unspiderfy){this._unspiderfy()}this._addLayer(e,this._maxZoom);var f=e,c=this._map.getZoom();if(e.__parent){while(f.__parent._zoom>=c){f=f.__parent}}if(this._currentShownBounds.contains(f.getLatLng())){if(this.options.animateAddingMarkers){this._animationAddLayer(e,f)}else{this._animationAddLayerNonAnimated(e,f)}}return this},removeLayer:function(c){if(!this._map){this._arraySplice(this._needsClustering,c);return this}if(!c.__parent){return this}if(this._unspiderfy){this._unspiderfy();this._unspiderfyLayer(c)}this._removeLayer(c,true);if(c._icon){L.FeatureGroup.prototype.removeLayer.call(this,c);c.setOpacity(1)}return this},addLayers:function(f){var g,e,c;if(!this._map){this._needsClustering=this._needsClustering.concat(f);return this}for(g=0,e=f.length;g<e;g++){c=f[g];if(this.hasLayer(c)){continue}this._addLayer(c,this._maxZoom);if(c.__parent){if(c.__parent.getChildCount()===2){var h=c.__parent.getAllChildMarkers(),d=h[0]===c?h[1]:h[0];L.FeatureGroup.prototype.removeLayer.call(this,d)}}}for(g in this._layers){if(this._layers.hasOwnProperty(g)){c=this._layers[g];if(c instanceof L.MarkerCluster&&c._iconNeedsUpdate){c._updateIcon()}}}this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds);return this},removeLayers:function(e){var f,d,c;if(!this._map){for(f=0,d=e.length;f<d;f++){this._arraySplice(this._needsClustering,e[f])}return this}for(f=0,d=e.length;f<d;f++){c=e[f];if(!c.__parent){continue}this._removeLayer(c,true,true);if(c._icon){L.FeatureGroup.prototype.removeLayer.call(this,c);c.setOpacity(1)}}this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds);for(f in this._layers){if(this._layers.hasOwnProperty(f)){c=this._layers[f];if(c instanceof L.MarkerCluster){c._updateIcon()}}}return this},clearLayers:function(){if(!this._map){this._needsClustering=[];delete this._gridClusters;delete this._gridUnclustered}if(this._unspiderfy){this._unspiderfy()}for(var c in this._layers){if(this._layers.hasOwnProperty(c)){L.FeatureGroup.prototype.removeLayer.call(this,this._layers[c])}}this.eachLayer(function(d){delete d.__parent});if(this._map){this._generateInitialClusters()}return this},getBounds:function(){var c=new L.LatLngBounds();if(this._topClusterLevel){c.extend(this._topClusterLevel._bounds)}else{for(var d=this._needsClustering.length-1;d>=0;d--){c.extend(this._needsClustering[d].getLatLng())}}return c},eachLayer:function(e,d){var f=this._needsClustering.slice(),c;if(this._topClusterLevel){this._topClusterLevel.getAllChildMarkers(f)}for(c=f.length-1;c>=0;c--){e.call(d,f[c])}},hasLayer:function(e){if(this._needsClustering.length>0){var c=this._needsClustering;for(var d=c.length-1;d>=0;d--){if(c[d]===e){return true}}}return !!(e.__parent&&e.__parent._group===this)},zoomToShowLayer:function(c,d){var e=function(){if((c._icon||c.__parent._icon)&&!this._inZoomAnimation){this._map.off("moveend",e,this);this.off("animationend",e,this);if(c._icon){d()}else{if(c.__parent._icon){var f=function(){this.off("spiderfied",f,this);d()};this.on("spiderfied",f,this);c.__parent.spiderfy()}}}};if(c._icon){d()}else{if(c.__parent._zoom<this._map.getZoom()){this._map.on("moveend",e,this);if(!c._icon){this._map.panTo(c.getLatLng())}}else{this._map.on("moveend",e,this);this.on("animationend",e,this);this._map.setView(c.getLatLng(),c.__parent._zoom+1);c.__parent.zoomToBounds()}}},onAdd:function(f){this._map=f;if(!this._gridClusters){this._generateInitialClusters()}for(var e=0,c=this._needsClustering.length;e<c;e++){var d=this._needsClustering[e];if(d.__parent){continue}this._addLayer(d,this._maxZoom)}this._needsClustering=[];this._map.on("zoomend",this._zoomEnd,this);this._map.on("moveend",this._moveEnd,this);if(this._spiderfierOnAdd){this._spiderfierOnAdd()}this._bindEvents();this._zoom=this._map.getZoom();this._currentShownBounds=this._getExpandedVisibleBounds();this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds)},onRemove:function(d){this._map.off("zoomend",this._zoomEnd,this);this._map.off("moveend",this._moveEnd,this);this._unbindEvents();this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim","");if(this._spiderfierOnRemove){this._spiderfierOnRemove()}for(var c in this._layers){if(this._layers.hasOwnProperty(c)){L.FeatureGroup.prototype.removeLayer.call(this,this._layers[c])}}this._map=null},_arraySplice:function(c,e){for(var d=c.length-1;d>=0;d--){if(c[d]===e){c.splice(d,1);return}}},_removeLayer:function(f,e,k){var h=this._gridClusters,c=this._gridUnclustered,d=this._map;if(e){for(var i=this._maxZoom;i>=0;i--){if(!c[i].removeObject(f,d.project(f.getLatLng(),i))){break}}}var l=f.__parent,g=l._markers,j;this._arraySplice(g,f);while(l){l._childCount--;if(l._zoom<0){break}else{if(e&&l._childCount<=1){j=l._markers[0]===f?l._markers[1]:l._markers[0];h[l._zoom].removeObject(l,d.project(l._cLatLng,l._zoom));c[l._zoom].addObject(j,d.project(j.getLatLng(),l._zoom));this._arraySplice(l.__parent._childClusters,l);l.__parent._markers.push(j);j.__parent=l.__parent;if(l._icon){L.FeatureGroup.prototype.removeLayer.call(this,l);if(!k){L.FeatureGroup.prototype.addLayer.call(this,j)}}}else{l._recalculateBounds();if(!k||!l._icon){l._updateIcon()}}}l=l.__parent}delete f.__parent},_propagateEvent:function(c){if(c.target instanceof L.MarkerCluster){c.type="cluster"+c.type}L.FeatureGroup.prototype._propagateEvent.call(this,c)},_defaultIconCreateFunction:function(d){var e=d.getChildCount();var f=" marker-cluster-";if(e<10){f+="small"}else{if(e<100){f+="medium"}else{f+="large"}}return new L.DivIcon({html:"<div><span>"+e+"</span></div>",className:"marker-cluster"+f,iconSize:new L.Point(40,40)})},_bindEvents:function(){var g=null,f=this._map,d=this.options.spiderfyOnMaxZoom,c=this.options.showCoverageOnHover,e=this.options.zoomToBoundsOnClick;if(d||e){this.on("clusterclick",function(h){if(f.getMaxZoom()===f.getZoom()){if(d){h.layer.spiderfy()}}else{if(e){h.layer.zoomToBounds()}}},this)}if(c){this.on("clustermouseover",function(h){if(this._inZoomAnimation){return}if(g){f.removeLayer(g)}if(h.layer.getChildCount()>2){g=new L.Polygon(h.layer.getConvexHull(),this.options.polygonOptions);f.addLayer(g)}},this);this.on("clustermouseout",function(){if(g){f.removeLayer(g);g=null}},this);f.on("zoomend",function(){if(g){f.removeLayer(g);g=null}},this);f.on("layerremove",function(h){if(g&&h.layer===this){f.removeLayer(g);g=null}},this)}},_unbindEvents:function(){var d=this.options.spiderfyOnMaxZoom,c=this.options.showCoverageOnHover,f=this.options.zoomToBoundsOnClick,e=this._map;if(d||f){this.off("clusterclick",null,this)}if(c){this.off("clustermouseover",null,this);this.off("clustermouseout",null,this);e.off("zoomend",null,this);e.off("layerremove",null,this)}},_zoomEnd:function(){if(!this._map){return}this._mergeSplitClusters();this._zoom=this._map._zoom;this._currentShownBounds=this._getExpandedVisibleBounds()},_moveEnd:function(){if(this._inZoomAnimation){return}var c=this._getExpandedVisibleBounds();this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,this._zoom,c);this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,c);this._currentShownBounds=c;return},_generateInitialClusters:function(){var c=this._map.getMaxZoom(),e=this.options.maxClusterRadius;if(this.options.disableClusteringAtZoom){c=this.options.disableClusteringAtZoom-1}this._maxZoom=c;this._gridClusters={};this._gridUnclustered={};for(var d=c;d>=0;d--){this._gridClusters[d]=new L.DistanceGrid(e);this._gridUnclustered[d]=new L.DistanceGrid(e)}this._topClusterLevel=new L.MarkerCluster(this,-1)},_addLayer:function(f,l){var g=this._gridClusters,c=this._gridUnclustered,k,h;if(this.options.singleMarkerMode){f.options.icon=this.options.iconCreateFunction({getChildCount:function(){return 1},getAllChildMarkers:function(){return[f]}})}for(;l>=0;l--){k=this._map.project(f.getLatLng(),l);var d=g[l].getNearObject(k);if(d){d._addChild(f);f.__parent=d;return}d=c[l].getNearObject(k);if(d){var j=d.__parent;if(j){this._removeLayer(d,false)}var i=new L.MarkerCluster(this,l,d,f);g[l].addObject(i,this._map.project(i._cLatLng,l));d.__parent=i;f.__parent=i;var e=i;for(h=l-1;h>j._zoom;h--){e=new L.MarkerCluster(this,h,e);g[h].addObject(e,this._map.project(d.getLatLng(),h))}j._addChild(e);for(h=l;h>=0;h--){if(!c[h].removeObject(d,this._map.project(d.getLatLng(),h))){break}}return}c[l].addObject(f,k)}this._topClusterLevel._addChild(f);f.__parent=this._topClusterLevel;return},_mergeSplitClusters:function(){if(this._zoom<this._map._zoom){this._animationStart();this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,this._zoom,this._getExpandedVisibleBounds());this._animationZoomIn(this._zoom,this._map._zoom)}else{if(this._zoom>this._map._zoom){this._animationStart();this._animationZoomOut(this._zoom,this._map._zoom)}else{this._moveEnd()}}},_getExpandedVisibleBounds:function(){var g=this._map,d=g.getBounds(),c=d._southWest,f=d._northEast,h=L.Browser.mobile?0:Math.abs(c.lat-f.lat),e=L.Browser.mobile?0:Math.abs(c.lng-f.lng);return new L.LatLngBounds(new L.LatLng(c.lat-h,c.lng-e,true),new L.LatLng(f.lat+h,f.lng+e,true))},_animationAddLayerNonAnimated:function(c,d){if(d===c){L.FeatureGroup.prototype.addLayer.call(this,c)}else{if(d._childCount===2){d._addToMap();var e=d.getAllChildMarkers();L.FeatureGroup.prototype.removeLayer.call(this,e[0]);L.FeatureGroup.prototype.removeLayer.call(this,e[1])}else{d._updateIcon()}}}});L.MarkerClusterGroup.include(!L.DomUtil.TRANSITION?{_animationStart:function(){},_animationZoomIn:function(d,c){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,d);this._topClusterLevel._recursivelyAddChildrenToMap(null,c,this._getExpandedVisibleBounds())},_animationZoomOut:function(d,c){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,d);this._topClusterLevel._recursivelyAddChildrenToMap(null,c,this._getExpandedVisibleBounds())},_animationAddLayer:function(c,d){this._animationAddLayerNonAnimated(c,d)}}:{_animationStart:function(){this._map._mapPane.className+=" leaflet-cluster-anim";this._inZoomAnimation++},_animationEnd:function(){if(this._map){this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim","")}this._inZoomAnimation--;this.fire("animationend")},_animationZoomIn:function(h,f){var g=this,c=this._getExpandedVisibleBounds(),e;this._topClusterLevel._recursively(c,h,0,function(n){var j=n._latlng,l=n._markers,i;if(n._isSingleParent()&&h+1===f){L.FeatureGroup.prototype.removeLayer.call(g,n);n._recursivelyAddChildrenToMap(null,f,c)}else{n.setOpacity(0);n._recursivelyAddChildrenToMap(j,f,c)}for(e=l.length-1;e>=0;e--){i=l[e];if(!c.contains(i._latlng)){L.FeatureGroup.prototype.removeLayer.call(g,i)}}});this._forceLayout();var d,k;g._topClusterLevel._recursivelyBecomeVisible(c,f);for(d in g._layers){if(g._layers.hasOwnProperty(d)){k=g._layers[d];if(!(k instanceof L.MarkerCluster)&&k._icon){k.setOpacity(1)}}}g._topClusterLevel._recursively(c,h,f,function(i){i._recursivelyRestoreChildPositions(f)});setTimeout(function(){g._topClusterLevel._recursively(c,h,0,function(i){L.FeatureGroup.prototype.removeLayer.call(g,i);i.setOpacity(1)});g._animationEnd()},250)},_animationZoomOut:function(d,c){this._animationZoomOutSingle(this._topClusterLevel,d-1,c);this._topClusterLevel._recursivelyAddChildrenToMap(null,c,this._getExpandedVisibleBounds());this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,d,this._getExpandedVisibleBounds())},_animationZoomOutSingle:function(c,g,e){var d=this._getExpandedVisibleBounds();c._recursivelyAnimateChildrenInAndAddSelfToMap(d,g+1,e);var f=this;this._forceLayout();c._recursivelyBecomeVisible(d,e);setTimeout(function(){if(c._childCount===1){var h=c._markers[0];h.setLatLng(h.getLatLng());h.setOpacity(1);return}c._recursively(d,e,0,function(i){i._recursivelyRemoveChildrenFromMap(d,g+1)});f._animationEnd()},250)},_animationAddLayer:function(c,e){var d=this;L.FeatureGroup.prototype.addLayer.call(this,c);if(e!==c){if(e._childCount>2){e._updateIcon();this._forceLayout();this._animationStart();c._setPos(this._map.latLngToLayerPoint(e.getLatLng()));c.setOpacity(0);setTimeout(function(){L.FeatureGroup.prototype.removeLayer.call(d,c);c.setOpacity(1);d._animationEnd()},250)}else{this._forceLayout();d._animationStart();d._animationZoomOutSingle(e,this._map.getMaxZoom(),this._map.getZoom())}}},_forceLayout:function(){L.Util.falseFn(document.body.offsetWidth)}});L.MarkerCluster=L.Marker.extend({initialize:function(f,e,d,c){L.Marker.prototype.initialize.call(this,d?(d._cLatLng||d.getLatLng()):new L.LatLng(0,0),{icon:this});this._group=f;this._zoom=e;this._markers=[];this._childClusters=[];this._childCount=0;this._iconNeedsUpdate=true;this._bounds=new L.LatLngBounds();if(d){this._addChild(d)}if(c){this._addChild(c)}},getAllChildMarkers:function(e){e=e||[];for(var d=this._childClusters.length-1;d>=0;d--){this._childClusters[d].getAllChildMarkers(e)}for(var c=this._markers.length-1;c>=0;c--){e.push(this._markers[c])}return e},getChildCount:function(){return this._childCount},zoomToBounds:function(){this._group._map.fitBounds(this._bounds)},_updateIcon:function(){this._iconNeedsUpdate=true;if(this._icon){this.setIcon(this)}},createIcon:function(){if(this._iconNeedsUpdate){this._iconObj=this._group.options.iconCreateFunction(this);this._iconNeedsUpdate=false}return this._iconObj.createIcon()},createShadow:function(){return this._iconObj.createShadow()},_addChild:function(c,d){this._iconNeedsUpdate=true;this._expandBounds(c);if(c instanceof L.MarkerCluster){if(!d){this._childClusters.push(c);c.__parent=this}this._childCount+=c._childCount}else{if(!d){this._markers.push(c)}this._childCount++}if(this.__parent){this.__parent._addChild(c,true)}},_expandBounds:function(e){var f,d=e._wLatLng||e._latlng;if(e instanceof L.MarkerCluster){this._bounds.extend(e._bounds);f=e._childCount}else{this._bounds.extend(d);f=1}if(!this._cLatLng){this._cLatLng=e._cLatLng||d}var c=this._childCount+f;if(!this._wLatLng){this._latlng=this._wLatLng=new L.LatLng(d.lat,d.lng)}else{this._wLatLng.lat=(d.lat*f+this._wLatLng.lat*this._childCount)/c;this._wLatLng.lng=(d.lng*f+this._wLatLng.lng*this._childCount)/c}},_addToMap:function(c){if(c){this._backupLatlng=this._latlng;this.setLatLng(c)}L.FeatureGroup.prototype.addLayer.call(this._group,this)},_recursivelyAnimateChildrenIn:function(d,e,c){this._recursively(d,0,c-1,function(j){var h=j._markers,g,f;for(g=h.length-1;g>=0;g--){f=h[g];if(f._icon){f._setPos(e);f.setOpacity(0)}}},function(i){var g=i._childClusters,h,f;for(h=g.length-1;h>=0;h--){f=g[h];if(f._icon){f._setPos(e);f.setOpacity(0)}}})},_recursivelyAnimateChildrenInAndAddSelfToMap:function(c,e,d){this._recursively(c,d,0,function(f){f._recursivelyAnimateChildrenIn(c,f._group._map.latLngToLayerPoint(f.getLatLng()).round(),e);if(f._isSingleParent()&&e-1===d){f.setOpacity(1);f._recursivelyRemoveChildrenFromMap(c,e)}else{f.setOpacity(0)}f._addToMap()})},_recursivelyBecomeVisible:function(c,d){this._recursively(c,0,d,null,function(e){e.setOpacity(1)})},_recursivelyAddChildrenToMap:function(d,e,c){this._recursively(c,-1,e,function(h){if(e===h._zoom){return}for(var g=h._markers.length-1;g>=0;g--){var f=h._markers[g];if(!c.contains(f._latlng)){continue}if(d){f._backupLatlng=f.getLatLng();f.setLatLng(d);f.setOpacity(0)}L.FeatureGroup.prototype.addLayer.call(h._group,f)}},function(f){f._addToMap(d)})},_recursivelyRestoreChildPositions:function(g){for(var f=this._markers.length-1;f>=0;f--){var c=this._markers[f];if(c._backupLatlng){c.setLatLng(c._backupLatlng);delete c._backupLatlng}}if(g-1===this._zoom){for(var e=this._childClusters.length-1;e>=0;e--){this._childClusters[e]._restorePosition()}}else{for(var d=this._childClusters.length-1;d>=0;d--){this._childClusters[d]._recursivelyRestoreChildPositions(g)}}},_restorePosition:function(){if(this._backupLatlng){this.setLatLng(this._backupLatlng);delete this._backupLatlng}},_recursivelyRemoveChildrenFromMap:function(f,g,d){var c,e;this._recursively(f,-1,g-1,function(h){for(e=h._markers.length-1;e>=0;e--){c=h._markers[e];if(!d||!d.contains(c._latlng)){L.FeatureGroup.prototype.removeLayer.call(h._group,c);c.setOpacity(1)}}},function(h){for(e=h._childClusters.length-1;e>=0;e--){c=h._childClusters[e];if(!d||!d.contains(c._latlng)){L.FeatureGroup.prototype.removeLayer.call(h._group,c);c.setOpacity(1)}}})},_recursively:function(h,j,g,k,e){var d=this._childClusters,m=this._zoom,f,l;if(j>m){for(f=d.length-1;f>=0;f--){l=d[f];if(h.intersects(l._bounds)){l._recursively(h,j,g,k,e)}}}else{if(k){k(this)}if(e&&this._zoom===g){e(this)}if(g>m){for(f=d.length-1;f>=0;f--){l=d[f];if(h.intersects(l._bounds)){l._recursively(h,j,g,k,e)}}}}},_recalculateBounds:function(){var e=this._markers,c=this._childClusters,d;this._bounds=new L.LatLngBounds();delete this._wLatLng;for(d=e.length-1;d>=0;d--){this._expandBounds(e[d])}for(d=c.length-1;d>=0;d--){this._expandBounds(c[d])}},_isSingleParent:function(){return this._childClusters.length>0&&this._childClusters[0]._childCount===this._childCount}});L.DistanceGrid=function(c){this._cellSize=c;this._sqCellSize=c*c;this._grid={};this._objectPoint={}};L.DistanceGrid.prototype={addObject:function(h,e){var d=this._getCoord(e.x),j=this._getCoord(e.y),g=this._grid,i=g[j]=g[j]||{},c=i[d]=i[d]||[],f=L.Util.stamp(h);this._objectPoint[f]=e;c.push(h)},updateObject:function(d,c){this.removeObject(d);this.addObject(d,c)},removeObject:function(e,j){var h=this._getCoord(j.x),g=this._getCoord(j.y),c=this._grid,l=c[g]=c[g]||{},k=l[h]=l[h]||[],d,f;delete this._objectPoint[L.Util.stamp(e)];for(d=0,f=k.length;d<f;d++){if(k[d]===e){k.splice(d,1);if(f===1){delete l[h]}return true}}},eachObject:function(m,d){var g,f,e,l,o,n,h,c=this._grid;for(g in c){if(c.hasOwnProperty(g)){o=c[g];for(f in o){if(o.hasOwnProperty(f)){n=o[f];for(e=0,l=n.length;e<l;e++){h=m.call(d,n[e]);if(h){e--;l--}}}}}}},getNearObject:function(p){var o=this._getCoord(p.x),n=this._getCoord(p.y),g,e,d,s,r,h,f,m,q=this._objectPoint,l=this._sqCellSize,c=null;for(g=n-1;g<=n+1;g++){s=this._grid[g];if(s){for(e=o-1;e<=o+1;e++){r=s[e];if(r){for(d=0,h=r.length;d<h;d++){f=r[d];m=this._sqDist(q[L.Util.stamp(f)],p);if(m<l){l=m;c=f}}}}}}return c},_getCoord:function(c){return Math.floor(c/this._cellSize)},_sqDist:function(f,e){var d=e.x-f.x,c=e.y-f.y;return d*d+c*c}};(function(){L.QuickHull={getDistant:function(e,f){var c=f[1].lat-f[0].lat,d=f[0].lng-f[1].lng;return(d*(e.lat-f[0].lat)+c*(e.lng-f[0].lng))},findMostDistantPointFromBaseLine:function(g,l){var h=0,e=null,c=[],f,j,k;for(f=l.length-1;f>=0;f--){j=l[f];k=this.getDistant(j,g);if(k>0){c.push(j)}else{continue}if(k>h){h=k;e=j}}return{maxPoint:e,newPoints:c}},buildConvexHull:function(d,f){var e=[],c=this.findMostDistantPointFromBaseLine(d,f);if(c.maxPoint){e=e.concat(this.buildConvexHull([d[0],c.maxPoint],c.newPoints));e=e.concat(this.buildConvexHull([c.maxPoint,d[1]],c.newPoints));return e}else{return[d]}},getConvexHull:function(k){var j=false,h=false,c=null,g=null,d;for(d=k.length-1;d>=0;d--){var f=k[d];if(j===false||f.lat>j){c=f;j=f.lat}if(h===false||f.lat<h){g=f;h=f.lat}}var e=[].concat(this.buildConvexHull([g,c],k),this.buildConvexHull([c,g],k));return e}}}());L.MarkerCluster.include({getConvexHull:function(){var g=this.getAllChildMarkers(),c=[],f=[],h,e,d;for(d=g.length-1;d>=0;d--){e=g[d].getLatLng();c.push(e)}h=L.QuickHull.getConvexHull(c);for(d=h.length-1;d>=0;d--){f.push(h[d][0])}return f}});L.MarkerCluster.include({_2PI:Math.PI*2,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_circleSpiralSwitchover:9,spiderfy:function(){if(this._group._spiderfied===this||this._group._inZoomAnimation){return}var g=this.getAllChildMarkers(),f=this._group,e=f._map,d=e.latLngToLayerPoint(this._latlng),c;this._group._unspiderfy();this._group._spiderfied=this;if(g.length>=this._circleSpiralSwitchover){c=this._generatePointsSpiral(g.length,d)}else{d.y+=10;c=this._generatePointsCircle(g.length,d)}this._animationSpiderfy(g,c)},unspiderfy:function(c){if(this._group._inZoomAnimation){return}this._animationUnspiderfy(c);this._group._spiderfied=null},_generatePointsCircle:function(g,j){var f=this._group.options.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+g),h=f/this._2PI,c=this._2PI/g,e=[],d,k;e.length=g;for(d=g-1;d>=0;d--){k=this._circleStartAngle+d*c;e[d]=new L.Point(j.x+h*Math.cos(k),j.y+h*Math.sin(k))._round()}return e},_generatePointsSpiral:function(f,h){var g=this._group.options.spiderfyDistanceMultiplier*this._spiralLengthStart,c=this._group.options.spiderfyDistanceMultiplier*this._spiralFootSeparation,k=this._group.options.spiderfyDistanceMultiplier*this._spiralLengthFactor,j=0,e=[],d;e.length=f;for(d=f-1;d>=0;d--){j+=c/g+d*0.0005;e[d]=new L.Point(h.x+g*Math.cos(j),h.y+g*Math.sin(j))._round();g+=this._2PI*k/j}return e}});L.MarkerCluster.include(!L.DomUtil.TRANSITION?{_animationSpiderfy:function(k,d){var j=this._group,h=j._map,f,c,g,e;for(f=k.length-1;f>=0;f--){e=h.layerPointToLatLng(d[f]);c=k[f];c._preSpiderfyLatlng=c._latlng;c.setLatLng(e);c.setZIndexOffset(1000000);L.FeatureGroup.prototype.addLayer.call(j,c);g=new L.Polyline([this._latlng,e],{weight:1.5,color:"#222"});h.addLayer(g);c._spiderLeg=g}this.setOpacity(0.3);j.fire("spiderfied")},_animationUnspiderfy:function(){var g=this._group,f=g._map,e=this.getAllChildMarkers(),c,d;this.setOpacity(1);for(d=e.length-1;d>=0;d--){c=e[d];L.FeatureGroup.prototype.removeLayer.call(g,c);c.setLatLng(c._preSpiderfyLatlng);delete c._preSpiderfyLatlng;c.setZIndexOffset(0);f.removeLayer(c._spiderLeg);delete c._spiderLeg}}}:{SVG_ANIMATION:(function(){return document.createElementNS("http://www.w3.org/2000/svg","animate").toString().indexOf("SVGAnimate")>-1}()),_animationSpiderfy:function(f,j){var p=this,r=this._group,d=r._map,n=d.latLngToLayerPoint(this._latlng),k,e,q,c;for(k=f.length-1;k>=0;k--){e=f[k];e.setZIndexOffset(1000000);e.setOpacity(0);L.FeatureGroup.prototype.addLayer.call(r,e);e._setPos(n)}r._forceLayout();r._animationStart();var o=L.Path.SVG?0:0.3,h=L.Path.SVG_NS;for(k=f.length-1;k>=0;k--){c=d.layerPointToLatLng(j[k]);e=f[k];e._preSpiderfyLatlng=e._latlng;e.setLatLng(c);e.setOpacity(1);q=new L.Polyline([p._latlng,c],{weight:1.5,color:"#222",opacity:o});d.addLayer(q);e._spiderLeg=q;if(!L.Path.SVG||!this.SVG_ANIMATION){continue}var l=q._path.getTotalLength();q._path.setAttribute("stroke-dasharray",l+","+l);var g=document.createElementNS(h,"animate");g.setAttribute("attributeName","stroke-dashoffset");g.setAttribute("begin","indefinite");g.setAttribute("from",l);g.setAttribute("to",0);g.setAttribute("dur",0.25);q._path.appendChild(g);g.beginElement();g=document.createElementNS(h,"animate");g.setAttribute("attributeName","stroke-opacity");g.setAttribute("attributeName","stroke-opacity");g.setAttribute("begin","indefinite");g.setAttribute("from",0);g.setAttribute("to",0.5);g.setAttribute("dur",0.25);q._path.appendChild(g);g.beginElement()}p.setOpacity(0.3);if(L.Path.SVG){this._group._forceLayout();for(k=f.length-1;k>=0;k--){e=f[k]._spiderLeg;e.options.opacity=0.5;e._path.setAttribute("stroke-opacity",0.5)}}setTimeout(function(){r._animationEnd();r.fire("spiderfied")},250)},_animationUnspiderfy:function(l){var k=this._group,c=k._map,h=l?c._latLngToNewLayerPoint(this._latlng,l.zoom,l.center):c.latLngToLayerPoint(this._latlng),e=this.getAllChildMarkers(),g=L.Path.SVG&&this.SVG_ANIMATION,d,f,j;k._animationStart();this.setOpacity(1);for(f=e.length-1;f>=0;f--){d=e[f];if(!d._preSpiderfyLatlng){continue}d.setLatLng(d._preSpiderfyLatlng);delete d._preSpiderfyLatlng;d._setPos(h);d.setOpacity(0);if(g){j=d._spiderLeg._path.childNodes[0];j.setAttribute("to",j.getAttribute("from"));j.setAttribute("from",0);j.beginElement();j=d._spiderLeg._path.childNodes[1];j.setAttribute("from",0.5);j.setAttribute("to",0);j.setAttribute("stroke-opacity",0);j.beginElement();d._spiderLeg._path.setAttribute("stroke-opacity",0)}}setTimeout(function(){var i=0;for(f=e.length-1;f>=0;f--){d=e[f];if(d._spiderLeg){i++}}for(f=e.length-1;f>=0;f--){d=e[f];if(!d._spiderLeg){continue}d.setOpacity(1);d.setZIndexOffset(0);if(i>1){L.FeatureGroup.prototype.removeLayer.call(k,d)}c.removeLayer(d._spiderLeg);delete d._spiderLeg}k._animationEnd()},250)}});L.MarkerClusterGroup.include({_spiderfied:null,_spiderfierOnAdd:function(){this._map.on("click",this._unspiderfyWrapper,this);if(this._map.options.zoomAnimation){this._map.on("zoomstart",this._unspiderfyZoomStart,this)}else{this._map.on("zoomend",this._unspiderfyWrapper,this)}if(L.Path.SVG&&!L.Browser.touch){this._map._initPathRoot()}},_spiderfierOnRemove:function(){this._map.off("click",this._unspiderfyWrapper,this);this._map.off("zoomstart",this._unspiderfyZoomStart,this);this._map.off("zoomanim",this._unspiderfyZoomAnim,this);this._unspiderfy()},_unspiderfyZoomStart:function(){if(!this._map){return}this._map.on("zoomanim",this._unspiderfyZoomAnim,this)},_unspiderfyZoomAnim:function(c){if(L.DomUtil.hasClass(this._map._mapPane,"leaflet-touching")){return}this._map.off("zoomanim",this._unspiderfyZoomAnim,this);this._unspiderfy(c)},_unspiderfyWrapper:function(){this._unspiderfy()},_unspiderfy:function(c){if(this._spiderfied){this._spiderfied.unspiderfy(c)}},_unspiderfyLayer:function(c){if(c._spiderLeg){L.FeatureGroup.prototype.removeLayer.call(this,c);c.setOpacity(1);c.setZIndexOffset(0);this._map.removeLayer(c._spiderLeg);delete c._spiderLeg}}})}(this));
/*
 * jQuery Cookie Plugin v1.3.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2013 Klaus Hartl
 * Released under the MIT license
 */
(function(a){if(typeof define==="function"&&define.amd){define(["jquery"],a)}else{a(jQuery)}}(function(e){var d=/\+/g;function b(g){return g}function a(g){return decodeURIComponent(g.replace(d," "))}function f(g){if(g.indexOf('"')===0){g=g.slice(1,-1).replace(/\\"/g,'"').replace(/\\\\/g,"\\")}try{return c.json?JSON.parse(g):g}catch(h){}}var c=e.cookie=function(r,q,o){if(q!==undefined){o=e.extend({},c.defaults,o);if(typeof o.expires==="number"){var u=o.expires,v=o.expires=new Date();v.setDate(v.getDate()+u)}q=c.json?JSON.stringify(q):String(q);return(document.cookie=[c.raw?r:encodeURIComponent(r),"=",c.raw?q:encodeURIComponent(q),o.expires?"; expires="+o.expires.toUTCString():"",o.path?"; path="+o.path:"",o.domain?"; domain="+o.domain:"",o.secure?"; secure":""].join(""))}var n=c.raw?b:a;var s=document.cookie.split("; ");var p=r?undefined:{};for(var k=0,h=s.length;k<h;k++){var j=s[k].split("=");var g=n(j.shift());var m=n(j.join("="));if(r&&r===g){p=f(m);break}if(!r){p[g]=f(m)}}return p};c.defaults={};e.removeCookie=function(h,g){if(e.cookie(h)!==undefined){e.cookie(h,"",e.extend(g,{expires:-1}));return true}return false}}));
/*
 * jQuery imagesLoaded plugin v2.1.1
 * http://github.com/desandro/imagesloaded
 *
 * MIT License. by Paul Irish et al.
 */
(function(a,b){var c="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";a.fn.imagesLoaded=function(l){var i=this,m=a.isFunction(a.Deferred)?a.Deferred():0,k=a.isFunction(m.notify),f=i.find("img").add(i.filter("img")),g=[],n=[],d=[];if(a.isPlainObject(l)){a.each(l,function(o,p){if(o==="callback"){l=p}else{if(m){m[o](p)}}})}function j(){var o=a(n),p=a(d);if(m){if(d.length){m.reject(f,o,p)}else{m.resolve(f)}}if(a.isFunction(l)){l.call(i,f,o,p)}}function e(o){h(o.target,o.type==="error")}function h(o,p){if(o.src===c||a.inArray(o,g)!==-1){return}g.push(o);if(p){d.push(o)}else{n.push(o)}a.data(o,"imagesLoaded",{isBroken:p,src:o.src});if(k){m.notifyWith(a(o),[p,f,a(n),a(d)])}if(f.length===g.length){setTimeout(j);f.unbind(".imagesLoaded",e)}}if(!f.length){j()}else{f.bind("load.imagesLoaded error.imagesLoaded",e).each(function(p,q){var r=q.src;var o=a.data(q,"imagesLoaded");if(o&&o.src===r){h(q,o.isBroken);return}if(q.complete&&q.naturalWidth!==b){h(q,q.naturalWidth===0||q.naturalHeight===0);return}if(q.readyState||q.complete){q.src=c;q.src=r}})}return m?m.promise(i):i}})(jQuery);L.BingLayer=L.TileLayer.extend({options:{subdomains:[0,1,2,3],type:"Aerial",attribution:"Bing",culture:""},initialize:function(b,a){L.Util.setOptions(this,a);this._key=b;this._url=null;this.meta={};this.loadMetadata()},tile2quad:function(a,g,e){var c="";for(var d=e;d>0;d--){var f=0;var b=1<<(d-1);if((a&b)!=0){f+=1}if((g&b)!=0){f+=2}c=c+f}return c},getTileUrl:function(c,d){var d=this._getZoomForUrl();var b=this.options.subdomains,a=this.options.subdomains[Math.abs((c.x+c.y)%b.length)];return this._url.replace("{subdomain}",a).replace("{quadkey}",this.tile2quad(c.x,c.y,d)).replace("{culture}",this.options.culture)},loadMetadata:function(){var d=this;var b="_bing_metadata_"+L.Util.stamp(this);window[b]=function(g){d.meta=g;window[b]=undefined;var f=document.getElementById(b);f.parentNode.removeChild(f);if(g.errorDetails){alert("Got metadata"+g.errorDetails);return}d.initMetadata()};var a="http://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.options.type+"?include=ImageryProviders&jsonp="+b+"&key="+this._key;var c=document.createElement("script");c.type="text/javascript";c.src=a;c.id=b;document.getElementsByTagName("head")[0].appendChild(c)},initMetadata:function(){var e=this.meta.resourceSets[0].resources[0];this.options.subdomains=e.imageUrlSubdomains;this._url=e.imageUrl;this._providers=[];for(var d=0;d<e.imageryProviders.length;d++){var f=e.imageryProviders[d];for(var b=0;b<f.coverageAreas.length;b++){var h=f.coverageAreas[b];var g={zoomMin:h.zoomMin,zoomMax:h.zoomMax,active:false};var a=new L.LatLngBounds(new L.LatLng(h.bbox[0]+0.01,h.bbox[1]+0.01),new L.LatLng(h.bbox[2]-0.01,h.bbox[3]-0.01));g.bounds=a;g.attrib=f.attribution;this._providers.push(g)}}this._update()},_update:function(){if(this._url==null||!this._map){return}this._update_attribution();L.TileLayer.prototype._update.apply(this,[])},_update_attribution:function(){var a=this._map.getBounds();var c=this._map.getZoom();for(var b=0;b<this._providers.length;b++){var d=this._providers[b];if((c<=d.zoomMax&&c>=d.zoomMin)&&a.intersects(d.bounds)){if(!d.active){this._map.attributionControl.addAttribution(d.attrib)}d.active=true}else{if(d.active){this._map.attributionControl.removeAttribution(d.attrib)}d.active=false}}},onRemove:function(c){for(var a=0;a<this._providers.length;a++){var b=this._providers[a];if(b.active){this._map.attributionControl.removeAttribution(b.attrib);b.active=false}}L.TileLayer.prototype.onRemove.apply(this,[c])}});
/*
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */
(function(a,b){if(typeof exports==="object"&&exports){module.exports=b}else{if(typeof define==="function"&&define.amd){define(b)}else{a.Mustache=b}}}(this,(function(){var m={};m.name="mustache.js";m.version="0.7.2";m.tags=["{{","}}"];m.Scanner=r;m.Context=t;m.Writer=u;var d=/\s*/;var a=/\s+/;var b=/\S/;var g=/\s*=/;var n=/\s*\}/;var q=/#|\^|\/|>|\{|&|=|!/;var i=RegExp.prototype.test;var p=Object.prototype.toString;function v(y,x){return i.call(y,x)}function e(x){return !v(b,x)}var k=Array.isArray||function(x){return p.call(x)==="[object Array]"};function f(x){return x.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var h={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function w(x){return String(x).replace(/[&<>"'\/]/g,function(y){return h[y]})}m.escape=w;function r(x){this.string=x;this.tail=x;this.pos=0}r.prototype.eos=function(){return this.tail===""};r.prototype.scan=function(y){var x=this.tail.match(y);if(x&&x.index===0){this.tail=this.tail.substring(x[0].length);this.pos+=x[0].length;return x[0]}return""};r.prototype.scanUntil=function(y){var x,z=this.tail.search(y);switch(z){case -1:x=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:x="";break;default:x=this.tail.substring(0,z);this.tail=this.tail.substring(z);this.pos+=z}return x};function t(x,y){this.view=x;this.parent=y;this._cache={}}t.make=function(x){return(x instanceof t)?x:new t(x)};t.prototype.push=function(x){return new t(x,this)};t.prototype.lookup=function(x){var A=this._cache[x];if(!A){if(x=="."){A=this.view}else{var z=this;while(z){if(x.indexOf(".")>0){A=z.view;var B=x.split("."),y=0;while(A&&y<B.length){A=A[B[y++]]}}else{A=z.view[x]}if(A!=null){break}z=z.parent}}this._cache[x]=A}if(typeof A==="function"){A=A.call(this.view)}return A};function u(){this.clearCache()}u.prototype.clearCache=function(){this._cache={};this._partialCache={}};u.prototype.compile=function(x,y){var z=this._cache[x];if(!z){var A=m.parse(x,y);z=this._cache[x]=this.compileTokens(A,x)}return z};u.prototype.compilePartial=function(z,x,y){var A=this.compile(x,y);this._partialCache[z]=A;return A};u.prototype.getPartial=function(x){if(!(x in this._partialCache)&&this._loadPartial){this.compilePartial(x,this._loadPartial(x))}return this._partialCache[x]};u.prototype.compileTokens=function(z,y){var x=this;return function(A,C){if(C){if(typeof C==="function"){x._loadPartial=C}else{for(var B in C){x.compilePartial(B,C[B])}}}return o(z,x,t.make(A),y)}};u.prototype.render=function(y,x,z){return this.compile(y)(x,z)};function o(x,D,y,H){var A="";var z,F,G;for(var C=0,E=x.length;C<E;++C){z=x[C];F=z[1];switch(z[0]){case"#":G=y.lookup(F);if(typeof G==="object"){if(k(G)){for(var B=0,J=G.length;B<J;++B){A+=o(z[4],D,y.push(G[B]),H)}}else{if(G){A+=o(z[4],D,y.push(G),H)}}}else{if(typeof G==="function"){var I=H==null?null:H.slice(z[3],z[5]);G=G.call(y.view,I,function(K){return D.render(K,y)});if(G!=null){A+=G}}else{if(G){A+=o(z[4],D,y,H)}}}break;case"^":G=y.lookup(F);if(!G||(k(G)&&G.length===0)){A+=o(z[4],D,y,H)}break;case">":G=D.getPartial(F);if(typeof G==="function"){A+=G(y)}break;case"&":G=y.lookup(F);if(G!=null){A+=G}break;case"name":G=y.lookup(F);if(G!=null){A+=m.escape(G)}break;case"text":A+=F;break}}return A}function l(E){var y=[];var C=y;var D=[];var A;for(var z=0,x=E.length;z<x;++z){A=E[z];switch(A[0]){case"#":case"^":D.push(A);C.push(A);C=A[4]=[];break;case"/":var B=D.pop();B[5]=A[2];C=D.length>0?D[D.length-1][4]:y;break;default:C.push(A)}}return y}function j(C){var B=[];var A,y;for(var z=0,x=C.length;z<x;++z){A=C[z];if(A){if(A[0]==="text"&&y&&y[0]==="text"){y[1]+=A[1];y[3]=A[3]}else{y=A;B.push(A)}}}return B}function s(x){return[new RegExp(f(x[0])+"\\s*"),new RegExp("\\s*"+f(x[1]))]}m.parse=function(F,E){F=F||"";E=E||m.tags;if(typeof E==="string"){E=E.split(a)}if(E.length!==2){throw new Error("Invalid tags: "+E.join(", "))}var N=s(E);var B=new r(F);var G=[];var P=[];var y=[];var D=false;var O=false;function I(){if(D&&!O){while(y.length){delete P[y.pop()]}}else{y=[]}D=false;O=false}var A,z,H,J,C;while(!B.eos()){A=B.pos;H=B.scanUntil(N[0]);if(H){for(var K=0,M=H.length;K<M;++K){J=H.charAt(K);if(e(J)){y.push(P.length)}else{O=true}P.push(["text",J,A,A+1]);A+=1;if(J=="\n"){I()}}}if(!B.scan(N[0])){break}D=true;z=B.scan(q)||"name";B.scan(d);if(z==="="){H=B.scanUntil(g);B.scan(g);B.scanUntil(N[1])}else{if(z==="{"){H=B.scanUntil(new RegExp("\\s*"+f("}"+E[1])));B.scan(n);B.scanUntil(N[1]);z="&"}else{H=B.scanUntil(N[1])}}if(!B.scan(N[1])){throw new Error("Unclosed tag at "+B.pos)}C=[z,H,A,B.pos];P.push(C);if(z==="#"||z==="^"){G.push(C)}else{if(z==="/"){if(G.length===0){throw new Error('Unopened section "'+H+'" at '+A)}var x=G.pop();if(x[1]!==H){throw new Error('Unclosed section "'+x[1]+'" at '+A)}}else{if(z==="name"||z==="{"||z==="&"){O=true}else{if(z==="="){E=H.split(a);if(E.length!==2){throw new Error("Invalid tags at "+A+": "+E.join(", "))}N=s(E)}}}}}var x=G.pop();if(x){throw new Error('Unclosed section "'+x[1]+'" at '+B.pos)}P=j(P);return l(P)};var c=new u();m.clearCache=function(){return c.clearCache()};m.compile=function(x,y){return c.compile(x,y)};m.compilePartial=function(z,x,y){return c.compilePartial(z,x,y)};m.compileTokens=function(y,x){return c.compileTokens(y,x)};m.render=function(y,x,z){return c.render(y,x,z)};m.to_html=function(y,x,z,B){var A=m.render(y,x,z);if(typeof B==="function"){B(A)}else{return A}};return m}())));var UIK={};UIK.viewmodel={};UIK.view={};UIK.templates={};(function(b,a){a.config={};b.extend(a.config,{data:{points:{checked:{name:"Проверенные",createIcon:function(){return a.map.getIcon("uik-checked",20)},createLayer:function(){return new L.MarkerClusterGroup({disableClusteringAtZoom:17,iconCreateFunction:function(c){return new L.DivIcon({html:"<div><span>"+c.getChildCount()+"</span></div>",className:"marker-cluster marker-cluster-small",iconSize:new L.Point(40,40)})}})},searchCssClass:"checked",z:1},unchecked:{name:"Непроверенные",createIcon:function(){return a.map.getIcon("uik-unchecked",20)},createLayer:function(){return new L.MarkerClusterGroup({disableClusteringAtZoom:17,iconCreateFunction:function(c){return new L.DivIcon({html:"<div><span>"+c.getChildCount()+"</span></div>",className:"marker-cluster marker-cluster-medium",iconSize:new L.Point(40,40)})}})},searchCssClass:"non-checked",z:2},blocked:{name:"Заблокированные",createIcon:function(){return a.map.getIcon("uik-blocked",20)},createLayer:function(){return new L.MarkerClusterGroup({disableClusteringAtZoom:17,iconCreateFunction:function(c){return new L.DivIcon({html:"<div><span>"+c.getChildCount()+"</span></div>",className:"marker-cluster marker-cluster-large",iconSize:new L.Point(40,40)})}})},searchCssClass:"blocked",z:3},uik_2012:{name:"УИК 2012",createIcon:function(){return a.map.getIcon("uik-2012",20)},createLayer:function(){return new L.MarkerClusterGroup({disableClusteringAtZoom:15,iconCreateFunction:function(c){return new L.DivIcon({html:"<div><span>"+c.getChildCount()+"</span></div>",className:"marker-cluster marker-cluster-large",iconSize:new L.Point(40,40)})}})},searchCssClass:"uik2012",z:4}}}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{version:null});b.extend(a.view,{$document:null});a.loader={};b.extend(a.loader,{templates:["uikPopupTemplate","uikPopupInfoTemplate","searchResultsTemplate","userLogsTemplate","alertsTemplate"],init:function(){var c=this;this.setDomOptions();window.setTimeout(function(){c.initModules();b("img").imagesLoaded(function(){a.view.$body.removeClass("loading")})},1000)},initModules:function(){a.common.init();a.popup.init();a.alerts.init();a.permalink.init();a.map.init();a.geocoder.init();a.searcher.init();a.searcher.address.init();a.searcher.tab.init();a.editor.init();a.user.init();a.uiks.init();a.uiks_2012.init();a.josm.init();a.editor.tab.init();a.versions.init()},setDomOptions:function(){a.view.$document=b(document)}});b(document).ready(function(){a.loader.init()})})(jQuery,UIK);(function(b,c){var a;UIK.subscriber={};a=UIK.subscriber;c.extend(UIK.subscriber,{isLog:false,routes:{},$document:c(document),subscribe:function(f,g,e){var d={callback:g,context:e};if(!a.routes[f]){a.routes[f]=[d]}else{a.routes[f].push(d)}},publish:function(g,f){var e,h=0,d;f=f||[];a.trigger(g,f);if(!a.routes.hasOwnProperty(g)){return false}for(h,d=a.routes[g].length;h<d;h+=1){e=a.routes[g][h];e.callback.apply(e.context,f)}},unsubscribe:function(d){delete a.routes[d]},call:function(f,e){e=e||[];if(!a.routes.hasOwnProperty(f)){return false}var d=a.routes[f][0];return d.callback.apply(d.context,e)},trigger:function(e,d){d=d||[];a.$document.trigger(e,d)}});UIK.subscribe=UIK.subscriber.subscribe;UIK.unsubscribe=UIK.subscriber.unsubscribe;UIK.publish=UIK.subscriber.publish;UIK.call=UIK.subscriber.call;UIK.trigger=UIK.subscriber.trigger})(UIK,jQuery);(function(b,a){a.helpers={};b.extend(a.helpers,{getIcon:function(c,d){return L.divIcon({className:c,iconSize:[d,d],iconAnchor:[d/2,d/2],popupAnchor:[0,2-(d/2)]})},hashToArrayKeyValues:function(d){var c=[];if(Object.prototype.toString.call(d)==="[object Array]"){return d}for(var e in d){if(!d.hasOwnProperty(e)){continue}c.push({key:e,val:d[e]})}return c},boolToString:function(d,c){switch(d){case null:return c?"null":"";break;case true:return c?"true":"Да";break;case false:return c?"false":"Нет";break}throw"The bool value is not convertible to string"},valueNullToString:function(c){if(c===null){return""}return c},sortByFields:function(){var d=arguments,c=this;return function(j,h){var e=0,g=0,f=d.length;while(g===0&&e<f){g=c.dynamicSort(d[e])(j,h);e++}return g}},dynamicSort:function(c){var d=1;if(c[0]==="-"){d=-1;c=c.substr(1,c.length-1)}return function(f,e){var g=(f[c]<e[c])?-1:(f[c]>e[c])?1:0;return g*d}},getURLParameter:function(c){return decodeURI((RegExp(c+"=(.+?)(&|$)").exec(location.search)||[,null])[1])}})})(jQuery,UIK);(function(b,a){b.extend(a.view,{$body:null});a.common={};b.extend(a.common,{init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){a.view.$document.on("/uik/common/setMainLoad",function(){a.view.$body.addClass("loader")});b("div.help-panel div.help").off("click").on("click",function(){a.view.$document.trigger("/uik/popup/openPopup",["Добро пожаловать в проект УИК ГЕО!",a.templates.welcomeTemplate({rootUrl:document.url_root})])})},setDomOptions:function(){a.view.$body=b("body")}})})(jQuery,UIK);(function(b,a){b.extend(a.view,{$popup:null});a.popup={};b.extend(a.popup,{$header:null,$content:null,init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){var c=a.view;c.$popup=b("#popup");this.$header=c.$popup.find("div.header");this.$content=c.$popup.find("div.content")},bindEvents:function(){var c=a.view,d=this;c.$document.on("/uik/popup/openPopup",function(i,h,g,f){d.openPopup(h,g,f)});c.$document.on("/uik/popup/closePopup",function(){d.closePopup()});c.$popup.find("a.close").off("click").on("click",function(){d.closePopup()})},openPopup:function(h,f,d){var e=a.view,i=e.$popup,g,c;this.$header.text(h);this.$content.html(f);g=i.width()/2;c=i.height()/2;i.css({"margin-left":-g+"px","margin-top":-c+"px"});e.$body.addClass("popup");e.$document.trigger("/uik/popup/"+d+"/opened")},closePopup:function(){a.view.$body.removeClass("popup")}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{map:null,mapLayers:{},isPopupOpened:false});b.extend(a.view,{$map:null});a.map={};b.extend(a.map,{init:function(){this.bindTriggers();this.buildMap();this.buildLayerManager();this.buildLayers();this.bindMapEvents()},bindTriggers:function(){var d=this,c=a.view,e=a.viewmodel;a.subscribe("/uik/map/setView",function(g,f){e.map.setView(g,f);d.setLastExtentToCookie(g,f);c.$document.trigger("/uik/permalink/update",[e.map.getCenter(),e.map.getZoom()])});c.$document.on("/uik/map/updateAllLayers",function(){a.view.$document.trigger("/uik/uiks_2012/updateUiks");a.view.$document.trigger("/uik/uiks/updateUiks")});a.subscribe("/uik/map/openPopup",function(h,f){var g=a.viewmodel.map;g.panTo(h);g.openPopup(L.popup().setLatLng(h).setContent(f))})},buildMap:function(){var d=a.viewmodel,c;a.view.$map=b("#map");d.map=new L.Map("map");this.initUrlModule();this.initHistoryModule();L.control.scale().addTo(d.map);c=L.layerGroup();d.map.addLayer(c);d.mapLayers.select=c},buildLayers:function(){var g=a.config.data.points,e,f,d,c={},h=[];a.viewmodel.mapLayers.points={};for(e in g){if(g.hasOwnProperty(e)){f=g[e].createLayer();a.viewmodel.map.addLayer(f);a.viewmodel.mapLayers.points[e]=f;c[g[e].z]=e;h.push(g[e].z)}}h.sort(function(j,i){return i-j});b.each(h,function(j,k){a.viewmodel.mapLayers.points[c[k]].bringToFront()})},bindMapEvents:function(){var d=this,c=a.view,e=a.viewmodel;e.map.on("moveend",function(i){var h=i.target,g=h.getCenter(),f=h.getZoom();d.setLastExtentToCookie(g,f);a.map.pushCurrentExtent();a.view.$document.trigger("/uik/permalink/update",[g,f]);a.view.$document.trigger("/uik/map/updateAllLayers")});e.map.on("popupclose",function(){var f=a.viewmodel;f.isPopupOpened=false;f.mapLayers.select.clearLayers()})},setLastExtentToCookie:function(c,d){b.cookie("map.lat",c.lat,{expires:7,path:"/"});b.cookie("map.lng",c.lng,{expires:7,path:"/"});b.cookie("map.zoom",d,{expires:7,path:"/"})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{});b.extend(a.map,{defaultExtent:{latlng:new L.LatLng(55.742,37.658),zoom:17},initUrlModule:function(){var c=this.getExtentFromUrl();if(c){a.call("/uik/map/setView",[c.latlng,c.zoom])}else{lastExtent=this.getLastExtentFromCookie();if(lastExtent){a.call("/uik/map/setView",[lastExtent.latlng,lastExtent.zoom])}else{a.call("/uik/map/setView",[this.defaultExtent.latlng,this.defaultExtent.zoom])}}},getExtentFromUrl:function(){var e=a.helpers,f=parseFloat(e.getURLParameter("lat")),c=parseFloat(e.getURLParameter("lon")),d=parseFloat(e.getURLParameter("zoom"));if(f&&c&&d){return{latlng:new L.LatLng(f,c),zoom:d}}return null},getLastExtentFromCookie:function(){var e=parseFloat(b.cookie("map.lat"),10),c=parseFloat(b.cookie("map.lng"),10),d=parseInt(b.cookie("map.zoom"),10);if(e&&c&&d){return{latlng:new L.LatLng(e,c),zoom:d}}else{return null}}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{});b.extend(a.map,{lockHistory:false,extentHistory:[],extentHistoryPointer:-1,initHistoryModule:function(){this.bindEvents();this.pushCurrentExtent();a.alerts.showAlert("historyShortcuts")},bindEvents:function(){var c=this;a.view.$map.keydown(function(d){if(d.keyCode===80){c.backwardExtentHistory()}if(d.keyCode===78){c.forwardExtentHistory()}})},pushCurrentExtent:function(){var c=[a.viewmodel.map.getCenter(),a.viewmodel.map.getZoom()];if(this.extentHistoryPointer>=0&&this.extentHistory[this.extentHistoryPointer][0].lat===c[0].lat&&this.extentHistory[this.extentHistoryPointer][0].lng===c[0].lng&&this.extentHistory[this.extentHistoryPointer][1]===c[1]){return false}while(this.extentHistory.length-1>this.extentHistoryPointer){this.extentHistory.pop()}this.extentHistory.push(c);this.extentHistoryPointer++},backwardExtentHistory:function(){var c;if(this.extentHistoryPointer>0){this.extentHistoryPointer-=1;c=this.extentHistory[this.extentHistoryPointer];this.lockHistory=true;a.viewmodel.map.setView(c[0],c[1]);this.lockHistory=false}},forwardExtentHistory:function(){var c;if(this.extentHistoryPointer+1<this.extentHistory.length){this.extentHistoryPointer+=1;c=this.extentHistory[this.extentHistoryPointer];this.lockHistory=true;a.viewmodel.map.setView(c[0],c[1]);this.lockHistory=false}}})})(jQuery,UIK);(function(b,a){b.extend(a.map,{getIcon:function(c,d){return L.divIcon({className:c,iconSize:[d,d],iconAnchor:[d/2,d/2],popupAnchor:[0,2-(d/2)]})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{currentTileLayer:null});b.extend(a.view,{$tileLayers:null,$manager:null});b.extend(a.map,{_layers:{},_lastIndex:0,buildLayerManager:function(){var c=a.view;a.view.$manager=b("#manager");this.addTileLayer("osm","http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png","© OpenStreetMap contributors");this.addBingLayer("AujH--7B6FRTK8b81QgPhuvw_Sb3kc8hBO-Lp5OLNyhCD4ZQoGGW4cQS6zBgaeEh");a.view.$tileLayers=c.$map.find("div.leaflet-tile-pane div.leaflet-layer");this.bindLayerManagerEvents();this.onLayer("osm")},bindLayerManagerEvents:function(){var c=this;a.viewmodel.map.off("zoomend").on("zoomend",function(){c.onLayer()});a.view.$manager.find("div.tile-layers div.icon").off("click").on("click",function(d){c.onLayer(b(this).data("layer"))})},onLayer:function(e){var d=a.viewmodel,c=a.view,f=b(a.viewmodel.map.getPanes().tilePane).find("div.leaflet-layer");if(e){c.$body.removeClass(d.currentTileLayer).addClass(e);d.currentTileLayer=e;f.hide().eq(this._layers[e].index).show()}else{f.hide().eq(this._layers[d.currentTileLayer].index).show()}},addTileLayer:function(f,c,e){var d=new L.TileLayer(c,{minZoom:8,maxZoom:18,attribution:e});this._layers[f]={layer:a.viewmodel.map.addLayer(d,true),index:this._lastIndex};this._lastIndex=+1},addBingLayer:function(d){var c=new L.BingLayer(d,{minZoom:8,maxZoom:18});this._layers.bing={layer:a.viewmodel.map.addLayer(c,true),index:this._lastIndex};this._lastIndex=+1}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{});a.geocoder={};b.extend(a.geocoder,{init:function(){this.bindEvents()},bindEvents:function(){},directGeocode:function(d,e){var c="http://beta.openstreetmap.ru/api/search?callback=?&q="+d;b.ajax({type:"GET",url:c,async:false,jsonpCallback:"jsonCallback",contentType:"application/json",dataType:"jsonp",success:function(f){e(f)}})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{searcherCollapsed:false,filter:{},isFilterValidated:true});b.extend(a.view,{$searchContainer:null,$filterName:null,$$filterAddr:null,$searchButton:null,$uiksSearchResults:null,$uikspSearchResults:null,$clearSearch:null});a.searcher={};b.extend(a.searcher,{min_characters_count:3,init:function(){this.setDomOptions();this.initFilter();this.bindEvents()},setDomOptions:function(){var c=a.view;c.$searchContainer=b("#searchContainer");c.$filterName=b("#filter_name");c.$filterAddr=b("#filter_address");c.$searchButton=b("#search");c.$uiksSearchResults=b("#searchUIK").find("div.searchResults");c.$uikspSearchResults=b("#searchUIK_2012").find("div.searchResults");c.$clearSearch=c.$searchContainer.find("a.clear-search")},initFilter:function(){var g=this,d=a.view,f,i,c,h,j,e;d.$searchContainer.find("div.search-block").each(function(k){f=b(this);i=f.data("filter");e=a.viewmodel.filter;e[i]={};e[i].json={};e[i].is_valid=true;e[i].trigger=f.data("trigger");e[i].btn_search=f.find("div.search");e[i].clear_search=f.find("a.clear-search");e[i].elements={};f.find("input.filterable").each(function(){(function(m,n,l){c=b(m);h=c.data("filter");a.viewmodel.filter[n].elements[h]={element:c,is_valid:true};l[n].json[h]=""})(this,i,e)})})},bindEvents:function(){var c=a.view,d=this;this.bindKeyUpHandlers();c.$searchContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){a.viewmodel.searcherCollapsed=!a.viewmodel.searcherCollapsed;a.view.$body.toggleClass("searcher-collapsed",d.searcherCollapsed)});c.$document.on("/sm/searcher/update",function(){d.updateSearch()})},bindKeyUpHandlers:function(){var d=this,g=a.viewmodel.filter,f,i,e,k,j,c,h;for(i in g){if(g.hasOwnProperty(i)){f=g[i];for(k in f.elements){if(f.elements.hasOwnProperty(k)){e=f.elements[k].element;(function(l,n,m){l.off("keyup").on("keyup",function(o){h=b(this);if(o.keyCode===13){if(m.validateFilter(n)){m.applyFilter(n)}}else{j=m[h.data("validate")](h.val());h.toggleClass("invalid",!j);n.elements[k].is_valid=j;c=m.validateFilter(n);n.btn_search.toggleClass("active",c);if(c){m.buildFilterJson(n)}if(c&&m.isEmptyFilters(n)){n.btn_search.removeClass("active")}}});n.clear_search.off("click").on("click",function(){b.each(n.elements,function(){this.element.val("")});m.applyFilter(n)});n.btn_search.off("click").on("click",function(){if(b(this).hasClass("active")){m.applyFilter(n)}})})(e,f,d)}}}}},validateFilter:function(e){var d=e.elements,c;for(c in d){if(d.hasOwnProperty(c)&&!d[c].is_valid){e.is_valid=false;return false}}e.is_valid=true;return true},isEmptyFilters:function(e){var d=e.elements,c;for(c in d){if(d.hasOwnProperty(c)){if(b.trim(d[c].element.val())!==""){return false}}}return true},validateDefault:function(d){var c=b.trim(d);return c.length>this.min_characters_count||c===""},validateNumber:function(c){return true},applyFilter:function(c){this.buildFilterJson(c);this.search(c)},buildFilterJson:function(e){var d=e.elements,c;for(c in d){if(d.hasOwnProperty(c)){e.json[c]=b.trim(d[c].element.val())}}},search:function(c){a.view.$document.trigger(c.trigger)},updateSearch:function(){var d=a.viewmodel.pointLayers.uiks,c=a.config.data.points,g,f=a.view.$uiksSearchResults.find("div"),e;f.empty();for(g in d){if(d.hasOwnProperty(g)){e=this.getHtmlForSearchResults(c[g].searchCssClass,d[g].elements);f.append(e)}}f.find("a.target").on("click",function(){var h=b(this).parent();a.viewmodel.map.setView(new L.LatLng(h.data("lat"),h.data("lon")),18);b("#target").show().delay(1000).fadeOut(1000)});f.find("a.edit").on("click",function(){if(a.viewmodel.editable){return false}var i=b(this).parent(),h;a.viewmodel.map.setView(new L.LatLng(i.data("lat"),i.data("lon")),18);b("#target").show().delay(1000).fadeOut(1000);h=i.data("id");b.getJSON(document.url_root+"uik/"+h,function(j){if(!a.viewmodel.editable){a.viewmodel.uikSelected=j;a.view.$document.trigger("/uik/editor/startEdit")}})});f.prop("class","active");f=a.view.$uikspSearchResults.find("div");d=a.viewmodel.pointLayers.uiksp;f.empty();for(g in d){if(d.hasOwnProperty(g)){e=a.templates.searchResultsTemplate({cssClass:c[g].searchCssClass,uiks:d[g].elements,isAuth:false});f.append(e)}}f.find("a.target").on("click",function(){var h=b(this).parent();a.viewmodel.map.setView(new L.LatLng(h.data("lat"),h.data("lon")),18);b("#target").show().delay(1000).fadeOut(1000)});f.prop("class","active")},getHtmlForSearchResults:function(c,d){return a.templates.searchResultsTemplate({cssClass:c,uiks:d,isAuth:a.viewmodel.isAuth})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{$divAddressSearchResults:null});a.searcher.address={};b.extend(a.searcher.address,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$divAddressSearchResults=b("#searchAddress").find("div.searchResults div")},bindEvents:function(){var c=this;a.view.$document.on("/uik/search/address",function(){c.searchAddress()})},searchAddress:function(){var d=this,c=a.view.$divAddressSearchResults,e;c.empty();a.geocoder.directGeocode(a.viewmodel.filter.address.json.address,function(f){e=f.matches;c.append(d.getHtmlForSearchResults("",e));c.find("a.target").on("click",function(){var g=b(this).parent();a.viewmodel.map.setView(new L.LatLng(g.data("lat"),g.data("lon")),16);b("#target").show().delay(1000).fadeOut(1000)})})},getHtmlForSearchResults:function(c,d){return a.templates.addressSearchTemplate({cssClass:c,matches:d})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{$activatedSearchTab:null});a.searcher.tab={};b.extend(a.searcher.tab,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$activatedSearchTab=a.view.$searchContainer.find("ul.nav li.active")},bindEvents:function(){var c=this,d;a.view.$searchContainer.find("ul.nav li").off("click").on("click",function(f){d=b(this);if(d.data("id")!==a.view.$activatedSearchTab.data("id")){c.activateTab(d)}})},activateTab:function(d){var c=a.view;c.$activatedSearchTab.removeClass("active");c.$activatedSearchTab=d.addClass("active");c.$searchContainer.attr("class",d.data("id"))}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{editorCollapsed:false,editable:false,latlngEditable:{lat:{validated:null,marker:null,editor:null},lng:{validated:null,marker:null,editor:null},isNeedApplied:false,sourceCoordinates:null},markerEditable:null});b.extend(a.view,{$editorContainer:null});a.editor={};b.extend(a.editor,{regex:{url:new RegExp("(https?)://[-A-Za-z0-9+&@#/%?=~_|!:,.;]*[-A-Za-z0-9+&@#/%=~_|]")},precisionDegree:6,templates:{notEditableValue:Mustache.compile("<p>{{value}}</p>"),uikNumber:Mustache.compile('<p>{{uikNumber}}<a title="УИК на сайте wikiuiki.org" target="_blank" href="http://www.wikiuiki.org/ik/{{regionId}}-uik-{{uikNumber}}"></a></p>')},init:function(){this.setDomOptions();this.buildEditLayer();this.bindEvents()},setDomOptions:function(){a.view.$editorContainer=b("#editorContainer");a.viewmodel.editorCollapsed=a.view.$body.hasClass("editor-collapsed")},buildEditLayer:function(){var c=L.layerGroup();a.viewmodel.mapLayers.edit=c;a.viewmodel.map.addLayer(c)},bindEvents:function(){var c=this;a.view.$editorContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){c.toggleEditor()});a.view.$document.on("/uik/editor/startEdit",function(d){c.startAjaxEdition()});b("#save").off("click").on("click",function(d){d.stopPropagation();c.save()});b("#discard").off("click").on("click",function(d){var f=a.viewmodel;d.stopPropagation();if(!f.latlngEditable.sourceCoordinates.equals(f.markerEditable.getLatLng())){f.map.setView(f.latlngEditable.sourceCoordinates,18);b("#target").show().delay(1000).fadeOut(1000)}c.finishAjaxEdition()});b("#editorForm").find(":checkbox").off("click").on("click",function(){var e=b(this),d=b("#"+e.data("id"));if(e.is(":checked")){d.val(1)}else{d.val(0)}});b("#lat, #lng").off("keyup").on("keyup",function(d){c.coordinatesInputHandler(d,b(this))});b("#applyCoordinates").off("click").on("click",function(){c.applyCoordinates(a.viewmodel.latlngEditable)});b("#undoCoordinates").off("click").on("click",function(){c.undoCoordinates()});b("#resetCenter").off("click").on("click",function(){c.resetCenter()});b("#regeocode").off("click").on("click",function(){c.regeocode()})},toggleEditor:function(){var c=!a.viewmodel.editorCollapsed;a.viewmodel.editorCollapsed=c;a.view.$body.toggleClass("editor-collapsed",c)},coordinatesInputHandler:function(g,h){var d=h.attr("id"),j=h.val(),i=a.viewmodel.latlngEditable,l=i[d],c=l.validated,k=l.editor!==l.marker,f=i.isNeedApplied;if(g.keyCode===13){if(i.isNeedApplied){this.applyCoordinates(i)}}else{l.validated=this.verifyDecimalDegree(j);if(l.validated){j=parseFloat(j.replace(",",".")).toFixed(this.precisionDegree);l.editor=j}else{a.alerts.showAlert("validateCoordinatesError")}i.isNeedApplied=this.getIsCanApplied(i);if(f!==i.isNeedApplied){b("#applyCoordinates").prop("disabled",!i.isNeedApplied)}if(i.isNeedApplied){a.alerts.showAlert("changeCoordinates")}if(c!==l.validated){h.toggleClass("invalid",!l.validated)}else{if(k!==(l.editor!==l.marker)){h.toggleClass("need-apply",l.editor!==l.marker)}}}},getIsCanApplied:function(c){if(!c.lat.validated||!c.lng.validated){return false}return c.lat.editor!==c.lat.marker||c.lng.editor!==c.lng.marker},verifyDecimalDegree:function(c){return !/^\s*$/.test(c)&&!isNaN(c)},applyCoordinates:function(c){var e=a.viewmodel,d=new L.LatLng(parseFloat(c.lat.editor),parseFloat(c.lng.editor));this.updateCoordinates(d);e.markerEditable.setLatLng(d);e.map.setView(d,18);b("#target").show().delay(1000).fadeOut(1000);b("#lat, #lng").removeClass("need-apply");b("#undoCoordinates").prop("disabled",false)},undoCoordinates:function(){var d=a.viewmodel,c=new L.LatLng(d.uikSelected.uik.old_geom.lat,d.uikSelected.uik.old_geom.lng);this.updateCoordinates(c);d.markerEditable.setLatLng(c);d.map.setView(c,d.map.getZoom());b("#undoCoordinates").prop("disabled",true)},resetCenter:function(){var c=a.viewmodel.map.getCenter();this.updateCoordinates(c);a.viewmodel.markerEditable.setLatLng(c);b("#undoCoordinates").prop("disabled",false)},regeocode:function(){var c=this,g=a.viewmodel,e=a.alerts,d=b("#address_voting").val(),f;a.geocoder.directGeocode(d,function(h){if(h.find){e.showAlert("regeocodeSuccess");f=new L.LatLng(h.matches[0].lat,h.matches[0].lon);c.updateCoordinates(f);g.markerEditable.setLatLng(f);g.map.setView(f,g.map.getZoom());b("#undoCoordinates").prop("disabled",false)}else{e.showAlert("regeocodeFail")}})},startAjaxEdition:function(){var c=this;b.ajax({type:"GET",url:document.url_root+"uik/block/"+a.viewmodel.uikSelected.uik.id}).done(function(){c.startEdit()})},startEdit:function(){var d=a.viewmodel,c=a.view;c.$body.addClass("editable");if(d.editorCollapsed){this.toggleEditor()}c.$editorContainer.find("input, select, textarea, button").removeAttr("disabled");c.$editorContainer.find("form").removeClass("disabled");d.editable=true;this.startEditingGeometry(d.uikSelected.uik.geom.lat,d.uikSelected.uik.geom.lng);this.fillEditor(d.uikSelected);d.uikSelected.uik.old_geom=jQuery.extend({},d.uikSelected.uik.geom);d.map.closePopup();b("#editUIK-link").click()},startEditingGeometry:function(h,d){var e=this,f=L.marker([h,d],{icon:a.helpers.getIcon("stop-editable",25),draggable:true}),g=h.toFixed(this.precisionDegree),c=d.toFixed(this.precisionDegree);f.on("dragend",function(i){e.updateCoordinates(i.target.getLatLng());b("#undoCoordinates").prop("disabled",false)});a.viewmodel.mapLayers.edit.addLayer(f);b("#applyCoordinates").prop("disabled",true);b("#undoCoordinates").prop("disabled",true);a.viewmodel.latlngEditable={lat:{validated:true,marker:g,editor:g},lng:{validated:true,marker:c,editor:c},isNeedApplied:false,sourceCoordinates:new L.LatLng(h,d)};a.viewmodel.markerEditable=f},updateCoordinates:function(d){var g=d.lat.toFixed(this.precisionDegree),f=d.lng.toFixed(this.precisionDegree),h=a.viewmodel,c=h.latlngEditable.isNeedApplied,e=h.latlngEditable.sourceCoordinates;h.uikSelected.uik.geom.lat=d.lat;h.uikSelected.uik.geom.lng=d.lng;if(c){b("#applyCoordinates").prop("disabled",true)}h.latlngEditable={lat:{validated:true,marker:g,editor:g},lng:{validated:true,marker:f,editor:f},isNeedApplied:false,sourceCoordinates:e};b("#lat").val(g);b("#lng").val(f)},fillEditor:function(d){var c=a.helpers;b("#name").html(this.templates.uikNumber({uikNumber:d.uik.number_official,regionId:d.region.id}));b("#region").html(this.templates.notEditableValue({value:d.region.name}));b("#tik").html(this.templates.notEditableValue({value:d.tik.name}));b("#address_voting").val(c.valueNullToString(d.uik.address_voting));b("#place_voting").val(c.valueNullToString(d.uik.place_voting));b("#geo_precision option:eq("+d.geo_precision.id+")").prop("selected",true);b("#lat").val(d.uik.geom.lat.toFixed(this.precisionDegree));b("#lng").val(d.uik.geom.lng.toFixed(this.precisionDegree));b("#comment").val(c.valueNullToString(d.uik.comment));if(d.uik.is_applied){b("#is_applied").val(1);b("#chb_is_applied").prop("checked",true)}else{b("#is_applied").val(0);b("#chb_is_applied").prop("checked",false)}a.view.$document.trigger("/uik/versions/build")},save:function(){if(!this.verifyEditor()){return}var f=this,j=b("#editorContainer form"),k=j.serializeArray(),h=k.length,g=a.viewmodel.uikSelected,d={id:g.uik.id},c=document.url_root+"uik/"+d.id,e=0;for(e;e<h;e+=1){d[k[e].name]=k[e].value}d.geom=g.uik.geom;b.ajax({type:"POST",url:c,data:{uik:JSON.stringify(d)}}).done(function(){a.alerts.showAlert("saveSuccessful");f.finishEditing()}).error(function(){a.alerts.showAlert("saveError")})},verifyEditor:function(){var d=true,c=a.viewmodel.latlngEditable;if(c.isNeedApplied){d=false;a.alerts.showAlert("notAppliedCoordinates")}if(!c.lat.validated||!c.lng.validated){d=false;a.alerts.showAlert("validateCoordinatesError")}return d},finishAjaxEdition:function(){var c=this;b.ajax({type:"GET",url:document.url_root+"uik/unblock/"+a.viewmodel.uikSelected.uik.id}).done(function(){c.finishEditing()})},finishEditing:function(){var d=a.viewmodel,c=a.view;d.map.closePopup();d.mapLayers.edit.clearLayers();d.editable=false;c.$body.addClass("editable");c.$editorContainer.find("input, textarea").val("");c.$editorContainer.find("input:checkbox").prop("checked",false);c.$editorContainer.find("input, select, textarea, button").attr("disabled","disabled").removeClass("invalid");c.$editorContainer.find("form").addClass("disabled");c.$editorContainer.find("span.value").empty();a.view.$document.trigger("/uik/versions/clearUI");a.view.$document.trigger("/uik/map/updateAllLayers")}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{uikSelected:null,uikSelectedId:null,pointLayers:{}});b.extend(a.view,{});a.uiks={};b.extend(a.uiks,{init:function(){this.updatePoints();this.bindEvents();this.handleUrl()},bindEvents:function(){var c=this;a.view.$document.on("/uik/uiks/updateUiks",function(){c.updatePoints()});a.subscribe("/uik/uiks/popup/openByUik",function(d){c.openUikPopupByUik(d)})},updatePoints:function(){var c=this.validateZoom();this.clearLayers();if(!c){return}a.view.$document.trigger("/uik/uiks/startUpdate");this.updateUiksByAjax()},clearLayers:function(){var c=a.viewmodel.mapLayers;c.points.checked.clearLayers();c.points.unchecked.clearLayers();c.points.blocked.clearLayers()},updateUiksByAjax:function(){var e=this,d=document.url_root+"uik/all",c=a.viewmodel.filter,f={uik:c.uik.json,uik_2012:c.uik_2012.json};b.ajax({type:"GET",url:d,data:{bbox:JSON.stringify(a.viewmodel.map.getBounds()),center:JSON.stringify(a.viewmodel.map.getCenter()),filter:JSON.stringify(f)},dataType:"json",success:function(g){e.renderUiks(g);a.view.$document.trigger("/sm/searcher/update");a.view.$document.trigger("/sm/stops/endUpdate")},context:e})},renderUiks:function(h){var k=a.viewmodel,q=k.mapLayers.points,n=a.config.data.points,o=h.data.points.layers,p,g,m,j,l,d,f,e=a.templates.uikPopupTemplate({css:"edit"}),c=this;k.pointLayers.uiks=h.data.points.layers;for(p in o){if(o.hasOwnProperty(p)){g=o[p].elements;m=o[p].count;if(m>0){l=n[p].createIcon()}for(f=0;f<m;f+=1){j=g[f];d=L.marker([j.lat,j.lon],{icon:l}).on("click",function(r){var i=r.target;a.call("/uik/map/openPopup",[i.getLatLng(),e]);c.buildUikPopupByClick(i.id)});d.id=j.id;q[p].addLayer(d)}}}},buildUikPopupByClick:function(d){var c=this;return b.getJSON(document.url_root+"uik/"+d,function(e){c.setUikSelected(e);c.buildUikPopup(e)}).error(function(){b("#uik-popup").removeClass("loader").empty().append("Error connection")})},setUikSelected:function(c){var d=a.viewmodel;if(!d.editable){d.uikSelected=c}},buildUikPopup:function(d){var c=a.templates.uikPopupInfoTemplate({uik:d.uik,tik:d.tik,region:d.region,geo_precision:d.geo_precision,isUserEditor:a.viewmodel.isAuth,editDenied:a.viewmodel.editable||d.uik.is_blocked,isBlocked:d.uik.is_blocked,userBlocked:d.uik.user_blocked,isUnBlocked:d.uik.is_unblocked});b("#uik-popup").removeClass("loader").empty().append(c);b("button#edit").off("click").on("click",function(){a.view.$document.trigger("/uik/editor/startEdit")});if(d.uik.is_unblocked){b("#unblock").off("click").on("click",function(){b.ajax({type:"GET",url:document.url_root+"uik/unblock/"+a.viewmodel.uikSelected.uik.id}).done(function(){a.viewmodel.map.closePopup();a.view.$document.trigger("/uik/map/updateAllLayers")})})}},openUikPopupByUik:function(d){var f=d.uik,e=[f.geom.lat,f.geom.lng],c=a.templates.uikPopupTemplate({css:"edit"});a.call("/uik/map/openPopup",[e,c]);this.setUikSelected(d);this.buildUikPopup(d)},validateZoom:function(){if(a.viewmodel.map.getZoom()<14){a.alerts.showAlert("zoom");return false}return true}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{});b.extend(a.uiks,{handleUrl:function(){var c=this.getUikFromUrl();if(c){b.when(this.getAjaxUik(c)).then(function(d){a.call("/uik/uiks/popup/openByUik",[d])})}},getUikFromUrl:function(){var f=a.helpers,c=f.getURLParameter("uik"),e=f.getURLParameter("reg"),d=f.getURLParameter("edit");if(c!=="null"&&e!=="null"){return{uikOfficialNumber:c,regionCode:e,editable:d==="True"||d==="true"}}return null},getAjaxUik:function(c){return b.getJSON(document.url_root+"uik/"+c.regionCode+"/"+c.uikOfficialNumber)}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{uikSelected:null,uikSelectedId:null});b.extend(a.view,{});a.uiks_2012={};b.extend(a.uiks_2012,{init:function(){this.updatePoints();this.bindEvents()},bindEvents:function(){var c=this;a.view.$document.on("/uik/uiks_2012/updateUiks",function(){c.updatePoints()})},updatePoints:function(){var c=this.validateZoom();this.clearLayers();if(!c){return}a.view.$document.trigger("/uik/uiks_2012/startUpdate");this.updateUiksByAjax()},clearLayers:function(){a.viewmodel.mapLayers.points.uik_2012.clearLayers()},updateUiksByAjax:function(){var e=this,d=document.url_root+"uikp/all",c=a.viewmodel.filter,f={uik:c.uik.json,uik_2012:c.uik_2012.json};b.ajax({type:"GET",url:d,data:{bbox:JSON.stringify(a.viewmodel.map.getBounds()),center:JSON.stringify(a.viewmodel.map.getCenter()),filter:JSON.stringify(f)},dataType:"json",success:function(g){e.renderUiks(g);a.view.$document.trigger("/sm/searcher/update");a.view.$document.trigger("/sm/stops/endUpdate")},context:e})},renderUiks:function(h){var k=a.viewmodel,q=k.mapLayers.points,n=a.config.data.points,o=h.points.layers,p,g,m,j,l,d,f,e=a.templates.uikPopupTemplate({css:"edit"}),c=this;k.pointLayers.uiksp=h.points.layers;for(p in o){if(o.hasOwnProperty(p)){g=o[p].elements;m=o[p].count;if(m>0){l=n[p].createIcon()}for(f=0;f<m;f+=1){j=g[f];d=L.marker([j.lat,j.lon],{icon:l}).on("click",function(r){var i=r.target;a.call("/uik/map/openPopup",[i.getLatLng(),e]);c.buildUikPopup(i.id)});d.id=j.id;q[p].addLayer(d)}}}},buildUikPopup:function(c){return b.getJSON(document.url_root+"uikp/"+c,function(e){var d=a.templates.uik2012PopupInfoTemplate({uikp:e.uikp});b("#uik-popup").removeClass("loader").empty().append(d)}).error(function(){b("#uik-popup").removeClass("loader").empty().append("Error connection")})},validateZoom:function(){if(a.viewmodel.map.getZoom()<14){a.alerts.showAlert("zoom");return false}return true}})})(jQuery,UIK);(function(b,a){a.alerts={};b.extend(a.view,{$alerts:null});b.extend(a.viewmodel,{alerts:{}});b.extend(a.alerts,{alerts:{historyShortcuts:{id:"historyShortcuts",type:"info",text:"Используйте клавиши p и n при работе с картой",statusText:"Можно перемещаться по истории экранов."},zoom:{id:"zoom",type:"alert",text:"Увеличьте масштаб для отображения УИКов",statusText:"Мелкий масштаб!"},saveSuccessful:{id:"saveSuccessful",type:"info",text:"УИК был успешно обновлен",statusText:""},saveError:{id:"saveError",type:"error",text:"УИК не был обновлен - произошла ошибка.",statusText:"Ошибка!"},changeCoordinates:{id:"coodrinateChanged",type:"info",text:"После изменения координаты должны быть применены.",statusText:"Внимание! "},notAppliedCoordinates:{id:"notAppliedCoordinates",type:"error",text:"Вы не применили координаты к редактируемому УИКу. ",statusText:"Ошибка сохранения:"},validateCoordinatesError:{id:"valCoordError",type:"error",text:"Десятичные градусы должны быть введены как 58.00000",statusText:"Неправильный формат ввода координат:"},regeocodeSuccess:{id:"regeocodeSuccess",type:"info",text:"координаты обновлены",statusText:"Геокодирование завершилось успешно:"},regeocodeFail:{id:"regeocodeFail",type:"error",text:"координаты не были обновлены",statusText:"Адрес не был геокодирован:"}},init:function(){a.view.$alerts=b("#alerts")},showAlert:function(d){if(!this.alerts[d]||a.viewmodel.alerts[d]){return false}a.viewmodel.alerts[d]=true;var c=a.templates.alertsTemplate(this.alerts[d]);a.view.$alerts.append(c);b("#alert_"+this.alerts[d].id).fadeIn().delay(2000).fadeOut("slow",function(){b(this).remove();a.viewmodel.alerts[d]=false})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{isAuth:false});b.extend(a.view,{$userContainer:null,$signInForm:null,$signOutForm:null});a.user={};b.extend(a.user,{init:function(){this.setDomOptions();this.handleFirstUser()},setDomOptions:function(){a.view.$userContainer=b("#userContainer");a.view.$signInForm=b("#signInForm");a.view.$signOutForm=b("#signOutForm");if(a.view.$userContainer.hasClass("inner")){a.viewmodel.isAuth=true}},handleFirstUser:function(){var c=b.cookie("uik.user.known");if(!c){b.cookie("uik.user.known","True",{expires:200,path:"/"});a.view.$document.on("/uik/popup/welcome/opened",function(){b("#welcomePopup div.start input").off("click").on("click",function(){a.view.$document.trigger("/uik/popup/closePopup");b(this).unbind("click")})});a.view.$document.trigger("/uik/popup/openPopup",["Добро пожаловать в проект УИК ГЕО!",a.templates.welcomeTemplate({rootUrl:document.url_root,first:true}),"welcome"])}}})})(jQuery,UIK);(function(b,a){b.extend(a.view,{$permalink:null,$fb_link:null});a.permalink={};b.extend(a.permalink,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$permalink=b("#permalink");a.view.$fb_link=b("#rightPanel a.facebook")},bindEvents:function(){a.view.$document.on("/uik/permalink/update",function(f,g,e){var c=a.view,d=document.url_root+"?lat="+g.lat+"&lon="+g.lng+"&zoom="+e;c.$permalink.prop("href",d);c.$fb_link.prop("href","https://www.facebook.com/sharer/sharer.php?u="+d)})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{$josmLink:null});a.josm={};b.extend(a.josm,{init:function(){this.bindEvents();this.setDomOptions()},setDomOptions:function(){a.view.$josmLink=b("#josm-link")},bindEvents:function(){b("#json_link").on("mouseover",function(){var c=a.viewmodel.map.getBounds(),d=("http://127.0.0.1:8111/load_and_zoom?left="+c.getNorthWest().lng+"&top="+c.getNorthWest().lat+"&right="+c.getSouthEast().lng+"&bottom="+c.getSouthEast().lat);b(this).attr("href",d)})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{version:null});b.extend(a.view,{$divVersions:null});a.versions={};b.extend(a.versions,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$divVersions=b("#versionsUIK")},bindEvents:function(){var c=this;a.view.$document.on("/uik/versions/build",function(){c.buildVersions()});a.view.$document.on("/uik/versions/clearUI",function(){c.clearVersionsUI()})},buildVersions:function(){a.view.$divVersions.empty();if(a.viewmodel.uikSelected.versions&&a.viewmodel.uikSelected.versions.length>0){for(var c in a.viewmodel.uikSelected.versions){var d=a.viewmodel.uikSelected.versions[c];var e=a.templates.versionsTemplate({num:+c+1,name:d.display_name,time:d.time});a.view.$divVersions.append(e)}}else{a.view.$divVersions.append("У этого УИКа нет сохраненных версий")}},clearVersionsUI:function(){a.view.$divVersions.empty()}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{$activatedEditorTab:null});a.editor.tab={};b.extend(a.editor.tab,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$activatedEditorTab=a.view.$editorContainer.find("ul.nav li.active")},bindEvents:function(){var c=this,d;a.view.$editorContainer.find("ul.nav li").off("click").on("click",function(f){d=b(this);if(d.data("id")!==a.view.$activatedEditorTab.data("id")){c.activateTab(d)}})},activateTab:function(d){var c=a.view;c.$activatedEditorTab.removeClass("active");c.$activatedEditorTab=d.addClass("active");c.$editorContainer.attr("class",d.data("id"))}})})(jQuery,UIK);UIK.templates={};UIK.templates.alertsTemplate=Mustache.compile('<div id="alert_{{id}}" class="alert alert-{{type}}" style="display: none;"> <button type="button" class="close" data-dismiss="alert">&times;</button> <strong>{{statusText}}</strong> {{text}} </div>');UIK.templates.searchResultsTemplate=Mustache.compile('<ul class="{{cssClass}}"> {{#uiks}} <li data-lat={{lat}} data-lon={{lon}} data-id={{id}}> <span>{{name}}</span> {{addr}} <a class="target" title="Перейти к УИКу"></a> {{#isAuth}}<a class="edit" title="Редактировать УИК"></a>{{/isAuth}} </li> {{/uiks}} </ul>');UIK.templates.uik2012PopupInfoTemplate=Mustache.compile('<div class="header">Это местоположение УИК в 2012 году (выборы Президента):</div> <table class="table table-striped"> <tr> <td>Номер УИКа</td> <td>{{uikp.name}}</td> </tr> <tr> <td>Адрес</td> <td>{{uikp.address}}</td> </tr> <tr> <td>Комментарий</td> <td>{{uikp.comment}}</td> </tr> </table> ');UIK.templates.osmPopupTemplate=Mustache.compile('<div class="osm-popup"> <div class="caption"> <span>{{id}}</span> <a href="{{link}}" target="_blank" title="Посмотреть на OpenStreetMaps" class="osm"></a> </div> <table class="table table-striped"> {{#tags}} <tr> <td>{{key}}</td> <td>{{val}}</td> </tr> {{/tags}} </table> </div>');UIK.templates.addressSearchTemplate=Mustache.compile('<ul class="{{cssClass}}"> {{#matches}} <li data-lat={{lat}} data-lon={{lon}} data-id={{id}}> {{display_name}} <a class="target" title="Перейти к объекту"></a> </li> {{/matches}} </ul>');UIK.templates.versionsTemplate=Mustache.compile("<ul> <li> <b>v{{num}}</b> {{time}}, {{name}} </li> </ul>");UIK.templates.welcomeTemplate=Mustache.compile('<div id="welcomePopup"> <p><strong>Здесь вы можете помочь проверить информацию по местоположениям Участковых избирательных комиссий.</strong></p> <p>Чтобы начать работу - <a target="_blank" href="{{rootUrl}}register">зарегистрируйтесь</a> и найдите интересный вам участок или непроверенные УИКи.</p> <p>Вы можете найти УИКи с помощью этой карты или через <a target="_blank" href="{{rootUrl}}uik/stat">список УИКов</a>. </p> <p>Полезные ссылки:</p> <ul> <li><a target="_blank" href="http://gis-lab.info/qa/uikgeo-manual.html">Руководство пользователя редактора</a></li> <li><a target="_blank" href="http://gis-lab.info/qa/uikgeo.html">О проекте</a></li> <li><a target="_blank" href="http://gis-lab.info/forum/viewforum.php?f=55">Задать вопросы или обсудить на форуме</a></li> <li>Контакты: <a href="mailto:uikgeo@gis-lab.info">uikgeo@gis-lab.info</a></li> </ul> {{#first}} <div class="start"> <input type="button" class="btn btn-primary" value="Начать работу!"/> </div> {{/first}} </div> ');UIK.templates.uikPopupTemplate=Mustache.compile('<div id="uik-popup" class="{{css}} loader"></div>');UIK.templates.uikPopupInfoTemplate=Mustache.compile('<table class="table table-striped"> <tr> <td>Номер УИКа</td> <td>{{uik.number_official}}</td> </tr> <tr> <td>ТИК</td> <td>{{tik.name}}</td> </tr> <tr> <td>Регион</td> <td>{{region.name}}</td> </tr> <tr> <td>Адрес голосования</td> <td>{{uik.address_voting}}</td> </tr> <tr> <td>Место помещения голосования</td> <td>{{uik.place_voting}}</td> </tr> <tr> <td>Точность геокодирования</td> <td>{{geo_precision.name_ru}}</td> </tr> <tr> <td>Комментарий</td> <td>{{uik.comment}}</td> </tr> <tr> <td>Проверен</td> <td> {{#uik.is_applied}}Да{{/uik.is_applied}} {{^uik.is_applied}}Нет{{/uik.is_applied}} </td> </tr> {{#isBlocked}} <tr class="block"> {{#isUnBlocked}} <td>Заблокирована вами</td> <td> <button class="btn btn-small btn-primary block" id="unblock" type="button">Разблокировать</button> </td> {{/isUnBlocked}} {{^isUnBlocked}} <td>Заблокировал</td> <td>{{userBlocked}}</td> {{/isUnBlocked}} </tr> {{/isBlocked}} </table> <div class="edit"> <a href="http://www.wikiuiki.org/ik/{{region.id}}-uik-{{uik.number_official}}" target="_blank" class="btn btn-small btn-info">Перейти в wikiuiki</a> {{#isUserEditor}} <button class="btn btn-small btn-primary {{#isBlock}}block{{/isBlock}}" id="edit" type="button" {{#editDenied}}disabled="disabled"{{/editDenied}}>Редактировать</button> {{/isUserEditor}} </div> ');UIK.templates.userLogsTemplate=Mustache.compile('<table class="table table-striped logs"> <caption>Общая статистика</caption> <tr> <th>Показатель</th> <th>Значение</th> </tr> <tr> <td>Всего УИКов</td> <td class="stop">{{count_all}}</td> </tr> <tr> <td>Отредактировано УИКов</td> <td class="stop">{{count_editable}}</td> </tr> <tr> <td>Отредактировано, %</td> <td class="stop">{{percent}}</td> </tr> </table> <table class="table table-striped logs"> <caption>Статистика по пользователям</caption> <tr> <th>Пользователь</th> <th>Кол-во УИКов</th> </tr> {{#user_logs}} <tr> <td>{{user_name}}</td> <td class="stop">{{count_uiks}}</td> </tr> {{/user_logs}} </table>');