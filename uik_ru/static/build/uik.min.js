/*
 * jQuery imagesLoaded plugin v2.1.1
 * http://github.com/desandro/imagesloaded
 *
 * MIT License. by Paul Irish et al.
 */
(function(a,b){var c="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";a.fn.imagesLoaded=function(l){var i=this,n=a.isFunction(a.Deferred)?a.Deferred():0,m=a.isFunction(n.notify),f=i.find("img").add(i.filter("img")),g=[],k=[],h=[];if(a.isPlainObject(l)){a.each(l,function(o,p){if(o==="callback"){l=p}else{if(n){n[o](p)}}})}function j(){var o=a(k),p=a(h);if(n){if(h.length){n.reject(f,o,p)}else{n.resolve(f)}}if(a.isFunction(l)){l.call(i,f,o,p)}}function e(o){d(o.target,o.type==="error")}function d(o,p){if(o.src===c||a.inArray(o,g)!==-1){return}g.push(o);if(p){h.push(o)}else{k.push(o)}a.data(o,"imagesLoaded",{isBroken:p,src:o.src});if(m){n.notifyWith(a(o),[p,f,a(k),a(h)])}if(f.length===g.length){setTimeout(j);f.unbind(".imagesLoaded",e)}}if(!f.length){j()}else{f.bind("load.imagesLoaded error.imagesLoaded",e).each(function(o,q){var r=q.src;var p=a.data(q,"imagesLoaded");if(p&&p.src===r){d(q,p.isBroken);return}if(q.complete&&q.naturalWidth!==b){d(q,q.naturalWidth===0||q.naturalHeight===0);return}if(q.readyState||q.complete){q.src=c;q.src=r}})}return n?n.promise(i):i}})(jQuery);L.BingLayer=L.TileLayer.extend({options:{subdomains:[0,1,2,3],type:"Aerial",attribution:"Bing",culture:""},initialize:function(b,a){L.Util.setOptions(this,a);this._key=b;this._url=null;this.meta={};this.loadMetadata()},tile2quad:function(a,g,e){var c="";for(var d=e;d>0;d--){var f=0;var b=1<<(d-1);if((a&b)!=0){f+=1}if((g&b)!=0){f+=2}c=c+f}return c},getTileUrl:function(c,d){var d=this._getZoomForUrl();var a=this.options.subdomains,b=this.options.subdomains[Math.abs((c.x+c.y)%a.length)];return this._url.replace("{subdomain}",b).replace("{quadkey}",this.tile2quad(c.x,c.y,d)).replace("{culture}",this.options.culture)},loadMetadata:function(){var d=this;var c="_bing_metadata_"+L.Util.stamp(this);window[c]=function(g){d.meta=g;window[c]=undefined;var f=document.getElementById(c);f.parentNode.removeChild(f);if(g.errorDetails){alert("Got metadata"+g.errorDetails);return}d.initMetadata()};var b="http://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.options.type+"?include=ImageryProviders&jsonp="+c+"&key="+this._key;var a=document.createElement("script");a.type="text/javascript";a.src=b;a.id=c;document.getElementsByTagName("head")[0].appendChild(a)},initMetadata:function(){var e=this.meta.resourceSets[0].resources[0];this.options.subdomains=e.imageUrlSubdomains;this._url=e.imageUrl;this._providers=[];for(var b=0;b<e.imageryProviders.length;b++){var g=e.imageryProviders[b];for(var a=0;a<g.coverageAreas.length;a++){var h=g.coverageAreas[a];var f={zoomMin:h.zoomMin,zoomMax:h.zoomMax,active:false};var d=new L.LatLngBounds(new L.LatLng(h.bbox[0]+0.01,h.bbox[1]+0.01),new L.LatLng(h.bbox[2]-0.01,h.bbox[3]-0.01));f.bounds=d;f.attrib=g.attribution;this._providers.push(f)}}this._update()},_update:function(){if(this._url==null||!this._map){return}this._update_attribution();L.TileLayer.prototype._update.apply(this,[])},_update_attribution:function(){var c=this._map.getBounds();var b=this._map.getZoom();for(var a=0;a<this._providers.length;a++){var d=this._providers[a];if((b<=d.zoomMax&&b>=d.zoomMin)&&c.intersects(d.bounds)){if(!d.active){this._map.attributionControl.addAttribution(d.attrib)}d.active=true}else{if(d.active){this._map.attributionControl.removeAttribution(d.attrib)}d.active=false}}},onRemove:function(c){for(var a=0;a<this._providers.length;a++){var b=this._providers[a];if(b.active){this._map.attributionControl.removeAttribution(b.attrib);b.active=false}}L.TileLayer.prototype.onRemove.apply(this,[c])}});
/*
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */
(function(a,b){if(typeof exports==="object"&&exports){module.exports=b}else{if(typeof define==="function"&&define.amd){define(b)}else{a.Mustache=b}}}(this,(function(){var v={};v.name="mustache.js";v.version="0.7.2";v.tags=["{{","}}"];v.Scanner=t;v.Context=r;v.Writer=p;var d=/\s*/;var k=/\s+/;var h=/\S/;var g=/\s*=/;var m=/\s*\}/;var s=/#|\^|\/|>|\{|&|=|!/;var i=RegExp.prototype.test;var u=Object.prototype.toString;function n(y,x){return i.call(y,x)}function f(x){return !n(h,x)}var j=Array.isArray||function(x){return u.call(x)==="[object Array]"};function e(x){return x.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function l(x){return String(x).replace(/[&<>"'\/]/g,function(y){return c[y]})}v.escape=l;function t(x){this.string=x;this.tail=x;this.pos=0}t.prototype.eos=function(){return this.tail===""};t.prototype.scan=function(y){var x=this.tail.match(y);if(x&&x.index===0){this.tail=this.tail.substring(x[0].length);this.pos+=x[0].length;return x[0]}return""};t.prototype.scanUntil=function(y){var x,z=this.tail.search(y);switch(z){case -1:x=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:x="";break;default:x=this.tail.substring(0,z);this.tail=this.tail.substring(z);this.pos+=z}return x};function r(x,y){this.view=x;this.parent=y;this._cache={}}r.make=function(x){return(x instanceof r)?x:new r(x)};r.prototype.push=function(x){return new r(x,this)};r.prototype.lookup=function(x){var A=this._cache[x];if(!A){if(x=="."){A=this.view}else{var z=this;while(z){if(x.indexOf(".")>0){A=z.view;var B=x.split("."),y=0;while(A&&y<B.length){A=A[B[y++]]}}else{A=z.view[x]}if(A!=null){break}z=z.parent}}this._cache[x]=A}if(typeof A==="function"){A=A.call(this.view)}return A};function p(){this.clearCache()}p.prototype.clearCache=function(){this._cache={};this._partialCache={}};p.prototype.compile=function(z,x){var y=this._cache[z];if(!y){var A=v.parse(z,x);y=this._cache[z]=this.compileTokens(A,z)}return y};p.prototype.compilePartial=function(y,A,x){var z=this.compile(A,x);this._partialCache[y]=z;return z};p.prototype.getPartial=function(x){if(!(x in this._partialCache)&&this._loadPartial){this.compilePartial(x,this._loadPartial(x))}return this._partialCache[x]};p.prototype.compileTokens=function(z,y){var x=this;return function(A,C){if(C){if(typeof C==="function"){x._loadPartial=C}else{for(var B in C){x.compilePartial(B,C[B])}}}return o(z,x,r.make(A),y)}};p.prototype.render=function(z,x,y){return this.compile(z)(x,y)};function o(E,y,x,H){var B="";var z,F,G;for(var C=0,D=E.length;C<D;++C){z=E[C];F=z[1];switch(z[0]){case"#":G=x.lookup(F);if(typeof G==="object"){if(j(G)){for(var A=0,J=G.length;A<J;++A){B+=o(z[4],y,x.push(G[A]),H)}}else{if(G){B+=o(z[4],y,x.push(G),H)}}}else{if(typeof G==="function"){var I=H==null?null:H.slice(z[3],z[5]);G=G.call(x.view,I,function(K){return y.render(K,x)});if(G!=null){B+=G}}else{if(G){B+=o(z[4],y,x,H)}}}break;case"^":G=x.lookup(F);if(!G||(j(G)&&G.length===0)){B+=o(z[4],y,x,H)}break;case">":G=y.getPartial(F);if(typeof G==="function"){B+=G(x)}break;case"&":G=x.lookup(F);if(G!=null){B+=G}break;case"name":G=x.lookup(F);if(G!=null){B+=v.escape(G)}break;case"text":B+=F;break}}return B}function w(D){var y=[];var C=y;var E=[];var A;for(var z=0,x=D.length;z<x;++z){A=D[z];switch(A[0]){case"#":case"^":E.push(A);C.push(A);C=A[4]=[];break;case"/":var B=E.pop();B[5]=A[2];C=E.length>0?E[E.length-1][4]:y;break;default:C.push(A)}}return y}function a(C){var z=[];var B,y;for(var A=0,x=C.length;A<x;++A){B=C[A];if(B){if(B[0]==="text"&&y&&y[0]==="text"){y[1]+=B[1];y[3]=B[3]}else{y=B;z.push(B)}}}return z}function q(x){return[new RegExp(e(x[0])+"\\s*"),new RegExp("\\s*"+e(x[1]))]}v.parse=function(O,D){O=O||"";D=D||v.tags;if(typeof D==="string"){D=D.split(k)}if(D.length!==2){throw new Error("Invalid tags: "+D.join(", "))}var H=q(D);var z=new t(O);var F=[];var E=[];var C=[];var P=false;var N=false;function M(){if(P&&!N){while(C.length){delete E[C.pop()]}}else{C=[]}P=false;N=false}var A,y,G,I,B;while(!z.eos()){A=z.pos;G=z.scanUntil(H[0]);if(G){for(var J=0,K=G.length;J<K;++J){I=G.charAt(J);if(f(I)){C.push(E.length)}else{N=true}E.push(["text",I,A,A+1]);A+=1;if(I=="\n"){M()}}}if(!z.scan(H[0])){break}P=true;y=z.scan(s)||"name";z.scan(d);if(y==="="){G=z.scanUntil(g);z.scan(g);z.scanUntil(H[1])}else{if(y==="{"){G=z.scanUntil(new RegExp("\\s*"+e("}"+D[1])));z.scan(m);z.scanUntil(H[1]);y="&"}else{G=z.scanUntil(H[1])}}if(!z.scan(H[1])){throw new Error("Unclosed tag at "+z.pos)}B=[y,G,A,z.pos];E.push(B);if(y==="#"||y==="^"){F.push(B)}else{if(y==="/"){if(F.length===0){throw new Error('Unopened section "'+G+'" at '+A)}var x=F.pop();if(x[1]!==G){throw new Error('Unclosed section "'+x[1]+'" at '+A)}}else{if(y==="name"||y==="{"||y==="&"){N=true}else{if(y==="="){D=G.split(k);if(D.length!==2){throw new Error("Invalid tags at "+A+": "+D.join(", "))}H=q(D)}}}}}var x=F.pop();if(x){throw new Error('Unclosed section "'+x[1]+'" at '+z.pos)}E=a(E);return w(E)};var b=new p();v.clearCache=function(){return b.clearCache()};v.compile=function(y,x){return b.compile(y,x)};v.compilePartial=function(y,z,x){return b.compilePartial(y,z,x)};v.compileTokens=function(y,x){return b.compileTokens(y,x)};v.render=function(z,x,y){return b.render(z,x,y)};v.to_html=function(A,y,z,B){var x=v.render(A,y,z);if(typeof B==="function"){B(x)}else{return x}};return v}())));(function(b,a){b.extend(a.viewmodel,{version:null});b.extend(a.view,{$document:null});a.loader={};b.extend(a.loader,{templates:["uikPopupTemplate","uikPopupInfoTemplate","searchResultsTemplate","userLogsTemplate","alertsTemplate"],init:function(){var c=this;this.setDomOptions();window.setTimeout(function(){c.initModules();b("img").imagesLoaded(function(){a.view.$body.removeClass("loading")})},1000)},initModules:function(){try{a.common.init();a.alerts.init();a.permalink.init();a.map.init();a.searcher.init();a.searcher.tab.init();a.editor.init();a.user.init();a.uiks.init()}catch(c){alert(c)}},setDomOptions:function(){a.view.$document=b(document)}});b(document).ready(function(){a.loader.init()})})(jQuery,UIK);(function(b,a){a.helpers={};b.extend(a.helpers,{getIcon:function(d,c){return L.divIcon({className:d,iconSize:[c,c],iconAnchor:[c/2,c/2],popupAnchor:[0,2-(c/2)]})},hashToArrayKeyValues:function(d){var c=[];if(Object.prototype.toString.call(d)==="[object Array]"){return d}for(var e in d){if(!d.hasOwnProperty(e)){continue}c.push({key:e,val:d[e]})}return c},boolToString:function(d,c){switch(d){case null:return c?"null":"";break;case true:return c?"true":"Да";break;case false:return c?"false":"Нет";break}throw"The bool value is not convertible to string"},valueNullToString:function(c){if(c===null){return""}return c},sortByFields:function(){var d=arguments,c=this;return function(j,h){var f=0,e=0,g=d.length;while(e===0&&f<g){e=c.dynamicSort(d[f])(j,h);f++}return e}},dynamicSort:function(d){var c=1;if(d[0]==="-"){c=-1;d=d.substr(1,d.length-1)}return function(g,f){var e=(g[d]<f[d])?-1:(g[d]>f[d])?1:0;return e*c}}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{bodyPanelsVisible:[true,true,true,true]});b.extend(a.view,{$body:null,$popup:null});a.common={};b.extend(a.common,{init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){var c=this;a.view.$document.on("/sm/common/openPopup",function(f,g,d){c.openPopup(g,d)});a.view.$popup.find("a.close").off("click").on("click",function(){a.view.$body.removeClass("popup")});a.view.$document.on("/sm/common/setMainLoad",function(){a.view.$body.addClass("loader")})},openPopup:function(g,c){var f=a.view.$popup,e,d;f.find("div.header").text(g);f.find("div.content").html(c);e=f.width()/2;d=f.height()/2;f.css({"margin-left":-e+"px","margin-top":-d+"px"});a.view.$body.addClass("popup")},closePopup:function(){},setDomOptions:function(){a.view.$body=b("body");a.view.$popup=b("#popup")}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{map:null,mapLayers:{},isPopupOpened:false});b.extend(a.view,{$map:null});a.map={};b.extend(a.map,{defaultExtent:{latlng:new L.LatLng(55.742,37.658),zoom:17},init:function(){this.buildMap();this.buildLayerManager();this.bindEvents()},bindEvents:function(){var c=this;a.viewmodel.map.on("moveend",function(h){var g=h.target,d=g.getCenter(),f=g.getZoom();c.setLastExtentToCookie(d,f);a.view.$document.trigger("/uik/permalink/update",[d,f]);a.view.$document.trigger("/sm/map/updateAllLayers")});a.view.$document.on("/sm/map/updateAllLayers",function(){a.view.$document.trigger("/sm/stops/updateStops")});a.view.$document.on("/sm/map/openPopup",function(i,j,f){var g=a.viewmodel,d=g.mapLayers.select,h=g.map;h.panTo(j);h.openPopup(L.popup().setLatLng(j).setContent(f))});a.viewmodel.map.on("popupclose",function(){var d=a.viewmodel;d.isPopupOpened=false;d.mapLayers.select.clearLayers()})},buildMap:function(){var e=a.viewmodel,d=this.getExtentFromUrl(),c;a.view.$map=b("#map");e.map=new L.Map("map");L.control.scale().addTo(e.map);if(d){e.map.setView(d.latlng,d.zoom);this.setLastExtentToCookie(d.latlng,d.zoom)}else{lastExtent=this.getLastExtentFromCookie();if(lastExtent){e.map.setView(lastExtent.latlng,lastExtent.zoom)}else{e.map.setView(this.defaultExtent.latlng,this.defaultExtent.zoom);this.setLastExtentToCookie(this.defaultExtent.latlng,this.defaultExtent.zoom)}}a.view.$document.trigger("/uik/permalink/update",[e.map.getCenter(),e.map.getZoom()]);c=L.layerGroup();e.map.addLayer(c);e.mapLayers.select=c},getLastExtentFromCookie:function(){var e=parseFloat(b.cookie("map.lat"),10),c=parseFloat(b.cookie("map.lng"),10),d=parseInt(b.cookie("map.zoom"),10);if(e&&c&&d){return{latlng:new L.LatLng(e,c),zoom:d}}else{return null}},setLastExtentToCookie:function(d,c){b.cookie("map.lat",d.lat,{expires:7,path:"/"});b.cookie("map.lng",d.lng,{expires:7,path:"/"});b.cookie("map.zoom",c,{expires:7,path:"/"})},getExtentFromUrl:function(){var e=parseFloat(this.getURLParameter("lat")),c=parseFloat(this.getURLParameter("lon")),d=parseFloat(this.getURLParameter("zoom"));if(e&&c&&d){return{latlng:new L.LatLng(e,c),zoom:d}}return null},getURLParameter:function(c){return decodeURI((RegExp(c+"=(.+?)(&|$)").exec(location.search)||[,null])[1])}})})(jQuery,UIK);(function(b,a){b.extend(a.map,{getIcon:function(d,c){return L.divIcon({className:d,iconSize:[c,c],iconAnchor:[c/2,c/2],popupAnchor:[0,2-(c/2)]})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{currentTileLayer:null});b.extend(a.view,{$tileLayers:null,$manager:null});b.extend(a.map,{_layers:{},_lastIndex:0,buildLayerManager:function(){var c=a.view;a.view.$manager=b("#manager");this.addTileLayer("osm","http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png","© OpenStreetMap contributors");this.addBingLayer("AujH--7B6FRTK8b81QgPhuvw_Sb3kc8hBO-Lp5OLNyhCD4ZQoGGW4cQS6zBgaeEh");a.view.$tileLayers=c.$map.find("div.leaflet-tile-pane div.leaflet-layer");this.bindLayerManagerEvents();this.onLayer("osm")},bindLayerManagerEvents:function(){var c=this;a.viewmodel.map.off("zoomend").on("zoomend",function(){c.onLayer()});a.view.$manager.find("div.tile-layers div.icon").off("click").on("click",function(d){c.onLayer(b(this).data("layer"))})},onLayer:function(e){var d=a.viewmodel,c=a.view,f=b(a.viewmodel.map.getPanes().tilePane).find("div.leaflet-layer");if(e){c.$body.removeClass(d.currentTileLayer).addClass(e);d.currentTileLayer=e;f.hide().eq(this._layers[e].index).show()}else{f.hide().eq(this._layers[d.currentTileLayer].index).show()}},addTileLayer:function(f,d,c){var e=new L.TileLayer(d,{minZoom:8,maxZoom:18,attribution:c});this._layers[f]={layer:a.viewmodel.map.addLayer(e,true),index:this._lastIndex};this._lastIndex=+1},addBingLayer:function(d){var c=new L.BingLayer(d,{minZoom:8,maxZoom:19});this._layers.bing={layer:a.viewmodel.map.addLayer(c,true),index:this._lastIndex};this._lastIndex=+1}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{searcherCollapsed:false,filter:{name:"",addr:""},isFilterValidated:true});b.extend(a.view,{$searchContainer:null,$filterName:null,$$filterAddr:null,$searchButton:null,$searchResults:null,$clearSearch:null});a.searcher={};b.extend(a.searcher,{min_characters_name:3,init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){var c=a.view;c.$searchContainer=b("#searchContainer");c.$filterName=b("#filter_name");c.$filterAddr=b("#filter_address");c.$searchButton=b("#search");c.$searchResults=b("#searchResults");c.$clearSearch=c.$searchContainer.find("a.clear-search")},bindEvents:function(){var d=this,c=a.view;c.$searchContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){a.viewmodel.searcherCollapsed=!a.viewmodel.searcherCollapsed;a.view.$body.toggleClass("searcher-collapsed",d.searcherCollapsed)});a.view.$clearSearch.off("click").on("click",function(){if(!b(this).hasClass("disabled")){a.view.$searchContainer.find("input").val("");d.applyFilter()}});c.$filterName.off("keyup").on("keyup",function(f){d.keyUpHandler(f)});c.$filterAddr.off("keyup").on("keyup",function(f){d.keyUpHandler(f)});b("#filter_name").off("focus").on("focus",function(){a.view.$searchResults.prop("class","description")});b("#searchResults p.description").off("click").on("click",function(){a.view.$searchResults.prop("class","active")});c.$searchButton.off("click").on("click",function(){if(a.viewmodel.isFilterValidated){d.applyFilter()}});c.$document.on("/sm/searcher/update",function(){d.updateSearch()});c.$document.on("/uik/uiks/startUpdate",function(){var e=a.view;e.$searchResults.prop("class","update");e.$filterName.prop("disabled",true);e.$filterAddr.prop("disabled",true);d.validateSearch()});c.$document.on("/sm/stops/endUpdate",function(){var e=a.view;e.$searchResults.prop("class","active");e.$filterName.prop("disabled",false);e.$filterAddr.prop("disabled",false)})},keyUpHandler:function(c){this.validateSearch();if(c.keyCode===13){this.applyFilter()}},validateSearch:function(){var f=this.min_characters_name,c=a.view,g=a.viewmodel,d=b.trim(c.$filterName.val()),h=b.trim(c.$filterAddr.val()),e=h.length>f||h==="";c.$filterAddr.toggleClass("invalid",!e);if(!e){g.filter.addr=""}g.isFilterValidated=e;c.$searchButton.toggleClass("active",a.viewmodel.isFilterValidated);c.$clearSearch.toggleClass("disabled",d===""&&h==="")},applyFilter:function(){if(a.viewmodel.isFilterValidated){this.updateFilter();this.search()}},updateFilter:function(){var c=a.view,d=a.viewmodel;d.filter.name=c.$filterName.val();d.filter.addr=c.$filterAddr.val()},search:function(){a.view.$document.trigger("/sm/stops/updateStops")},updateSearch:function(){var d=a.viewmodel.pointLayers,c=a.config.data.points,g,f=a.view.$searchResults.find("div"),e;f.empty();for(g in d){if(d.hasOwnProperty(g)){e=this.getHtmlForSearchResults(c[g].searchCssClass,d[g].elements);f.append(e)}}f.find("a.target").on("click",function(){var h=b(this).parent();a.viewmodel.map.setView(new L.LatLng(h.data("lat"),h.data("lon")),18);b("#target").show().delay(1000).fadeOut(1000)});f.find("a.edit").on("click",function(){if(a.viewmodel.editable){return false}var i=b(this).parent(),h;a.viewmodel.map.setView(new L.LatLng(i.data("lat"),i.data("lon")),18);b("#target").show().delay(1000).fadeOut(1000);h=i.data("id");b.getJSON(document.url_root+"uik/"+h,function(j){if(!a.viewmodel.editable){a.viewmodel.uikSelected=j;a.view.$document.trigger("/uik/editor/startEdit")}})});a.view.$searchResults.prop("class","active")},getHtmlForSearchResults:function(c,d){return a.templates.searchResultsTemplate({cssClass:c,uiks:d,isAuth:a.viewmodel.isAuth})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{});a.searcher.tab={};b.extend(a.searcher.tab,{init:function(){this.bindEvents()},bindEvents:function(){a.view.$searchContainer.find("ul.nav a").off("click").on("click",function(c){c.preventDefault();c.stopPropagation()})}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{editorCollapsed:false,editable:false,latlngEditable:{lat:{validated:null,marker:null,editor:null},lng:{validated:null,marker:null,editor:null},isNeedApplied:false,sourceCoordinates:null},markerEditable:null});b.extend(a.view,{$editorContainer:null});a.editor={};b.extend(a.editor,{regex:{url:new RegExp("(https?)://[-A-Za-z0-9+&@#/%?=~_|!:,.;]*[-A-Za-z0-9+&@#/%=~_|]")},precisionDegree:6,init:function(){this.setDomOptions();this.buildEditLayer();this.bindEvents()},setDomOptions:function(){a.view.$editorContainer=b("#editorContainer");a.viewmodel.editorCollapsed=a.view.$body.hasClass("editor-collapsed")},buildEditLayer:function(){var c=L.layerGroup();a.viewmodel.mapLayers.edit=a.viewmodel.map.addLayer(c)},bindEvents:function(){var c=this;a.view.$editorContainer.find("span.icon-collapse, div.title").off("click").on("click",function(){c.toggleEditor()});a.view.$document.on("/uik/editor/startEdit",function(d){c.startAjaxEdition()});b("#save").off("click").on("click",function(d){d.stopPropagation();c.save()});b("#discard").off("click").on("click",function(f){var d=a.viewmodel;f.stopPropagation();if(!d.latlngEditable.sourceCoordinates.equals(d.markerEditable.getLatLng())){d.map.setView(d.latlngEditable.sourceCoordinates,18);b("#target").show().delay(1000).fadeOut(1000)}c.finishAjaxEdition()});b("#editorForm").find(":checkbox").off("click").on("click",function(){var e=b(this),d=b("#"+e.data("id"));if(e.is(":checked")){d.val(1)}else{d.val(0)}});b("#lat, #lng").off("keyup").on("keyup",function(d){c.coordinatesInputHandler(d,b(this))});b("#applyCoordinates").off("click").on("click",function(){c.applyCoordinates(a.viewmodel.latlngEditable)})},toggleEditor:function(){var c=!a.viewmodel.editorCollapsed;a.viewmodel.editorCollapsed=c;a.view.$body.toggleClass("editor-collapsed",c)},coordinatesInputHandler:function(g,h){var c=h.attr("id"),j=h.val(),k=a.viewmodel.latlngEditable,l=k[c],d=l.validated,i=l.editor!==l.marker,f=k.isNeedApplied;if(g.keyCode===13){if(k.isNeedApplied){this.applyCoordinates(k)}}else{l.validated=this.verifyDecimalDegree(j);if(l.validated){j=parseFloat(j.replace(",",".")).toFixed(this.precisionDegree);l.editor=j}else{a.alerts.showAlert("validateCoordinatesError")}k.isNeedApplied=this.getIsCanApplied(k);if(f!==k.isNeedApplied){b("#applyCoordinates").prop("disabled",!k.isNeedApplied)}if(k.isNeedApplied){a.alerts.showAlert("changeCoordinates")}if(d!==l.validated){h.toggleClass("invalid",!l.validated)}else{if(i!==(l.editor!==l.marker)){h.toggleClass("need-apply",l.editor!==l.marker)}}}},getIsCanApplied:function(c){if(!c.lat.validated||!c.lng.validated){return false}return c.lat.editor!==c.lat.marker||c.lng.editor!==c.lng.marker},verifyDecimalDegree:function(c){return !/^\s*$/.test(c)&&!isNaN(c)},applyCoordinates:function(c){var d=a.viewmodel,e=new L.LatLng(parseFloat(c.lat.editor),parseFloat(c.lng.editor));this.updateCoordinates(e);d.markerEditable.setLatLng(e);d.map.setView(e,18);b("#target").show().delay(1000).fadeOut(1000);b("#lat, #lng").removeClass("need-apply")},startAjaxEdition:function(){var c=this;b.ajax({type:"GET",url:document.url_root+"uik/block/"+a.viewmodel.uikSelected.uik.id}).done(function(){c.startEdit()})},startEdit:function(){var d=a.viewmodel,c=a.view;c.$body.addClass("editable");if(d.editorCollapsed){this.toggleEditor()}c.$editorContainer.find("input, select, textarea, button").removeAttr("disabled");c.$editorContainer.find("form").removeClass("disabled");d.editable=true;this.startEditingGeometry(d.uikSelected.uik.geom.lat,d.uikSelected.uik.geom.lng);this.fillEditor(d.uikSelected);d.map.closePopup()},startEditingGeometry:function(h,e){var f=this,d=L.marker([h,e],{icon:a.helpers.getIcon("stop-editable",25),draggable:true}),c=h.toFixed(this.precisionDegree),g=e.toFixed(this.precisionDegree);d.on("dragend",function(i){f.updateCoordinates(i.target.getLatLng())});a.viewmodel.mapLayers.edit.addLayer(d);b("#applyCoordinates").prop("disabled",true);a.viewmodel.latlngEditable={lat:{validated:true,marker:c,editor:c},lng:{validated:true,marker:g,editor:g},isNeedApplied:false,sourceCoordinates:new L.LatLng(h,e)};a.viewmodel.markerEditable=d},updateCoordinates:function(f){var h=f.lat.toFixed(this.precisionDegree),d=f.lng.toFixed(this.precisionDegree),g=a.viewmodel,c=g.latlngEditable.isNeedApplied,e=g.latlngEditable.sourceCoordinates;g.uikSelected.uik.geom.lat=f.lat;g.uikSelected.uik.geom.lng=f.lng;if(c){b("#applyCoordinates").prop("disabled",true)}g.latlngEditable={lat:{validated:true,marker:h,editor:h},lng:{validated:true,marker:d,editor:d},isNeedApplied:false,sourceCoordinates:e};b("#lat").val(h);b("#lng").val(d)},fillEditor:function(d){var c=a.helpers;b("#id").val(d.uik.id).attr("disabled","disabled");b("#name").val(d.uik.number_official).attr("disabled","disabled");b("#region").val(d.region.name).attr("disabled","disabled");b("#tik").val(d.tik.name).attr("disabled","disabled");b("#address_voting").val(c.valueNullToString(d.uik.address_voting));b("#place_voting").val(c.valueNullToString(d.uik.place_voting));b("#geo_precision option:eq("+d.geo_precision.id+")").prop("selected",true);b("#lat").val(d.uik.geom.lat.toFixed(this.precisionDegree));b("#lng").val(d.uik.geom.lng.toFixed(this.precisionDegree));b("#comment").val(c.valueNullToString(d.uik.comment));if(d.uik.is_applied){b("#is_applied").val(1);b("#chb_is_applied").prop("checked",true)}else{b("#is_applied").val(0);b("#chb_is_applied").prop("checked",false)}},save:function(){if(!this.verifyEditor()){return}var h=this,j=b("#editorContainer form"),k=j.serializeArray(),d=k.length,c=a.viewmodel.uikSelected,f={id:c.uik.id},e=document.url_root+"uik/"+f.id,g=0;for(g;g<d;g+=1){f[k[g].name]=k[g].value}f.geom=c.uik.geom;b.ajax({type:"POST",url:e,data:{uik:JSON.stringify(f)}}).done(function(){a.alerts.showAlert("saveSuccessful");h.finishEditing()}).error(function(){a.alerts.showAlert("saveError")})},verifyEditor:function(){var d=true,c=a.viewmodel.latlngEditable;if(c.isNeedApplied){d=false;a.alerts.showAlert("notAppliedCoordinates")}if(!c.lat.validated||!c.lng.validated){d=false;a.alerts.showAlert("validateCoordinatesError")}return d},finishAjaxEdition:function(){var c=this;b.ajax({type:"GET",url:document.url_root+"uik/unblock/"+a.viewmodel.uikSelected.uik.id}).done(function(){c.finishEditing()})},finishEditing:function(){var d=a.viewmodel,c=a.view;d.map.closePopup();d.mapLayers.edit.clearLayers();d.editable=false;c.$body.addClass("editable");c.$editorContainer.find("input, textarea").val("");c.$editorContainer.find("input:checkbox").prop("checked",false);c.$editorContainer.find("input, select, textarea, button").attr("disabled","disabled").removeClass("invalid");c.$editorContainer.find("form").addClass("disabled");a.view.$document.trigger("/sm/map/updateAllLayers")}})})(jQuery,UIK);(function(b,a){b.extend(a.viewmodel,{isAuth:false});b.extend(a.view,{$userContainer:null,$signInForm:null,$signOutForm:null});a.user={};b.extend(a.user,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$userContainer=b("#userContainer");a.view.$signInForm=b("#signInForm");a.view.$signOutForm=b("#signOutForm");if(a.view.$userContainer.hasClass("inner")){a.viewmodel.isAuth=true}},bindEvents:function(){var c=this;b("#signOutForm div.log").off("click").on("click",function(){c.renderLogs()})},renderLogs:function(){var c=document.url_root+"logs";a.view.$document.trigger("/sm/common/setMainLoad");b.ajax({type:"GET",url:c,dataType:"json",success:function(e){var d=a.templates.userLogsTemplate({user_logs:e.uiks_by_users,count_all:e.count.all,count_editable:e.count.editable,percent:(e.count.editable/e.count.all*100).toFixed(2)});a.view.$body.removeClass("loader");a.view.$document.trigger("/sm/common/openPopup",["Статистика пользователей",d])}})}})})(jQuery,UIK);(function(b,a){b.extend(a.view,{$permalink:null,$fb_link:null});a.permalink={};b.extend(a.permalink,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$permalink=b("#permalink");a.view.$fb_link=b("#rightPanel a.facebook")},bindEvents:function(){a.view.$document.on("/uik/permalink/update",function(f,g,e){var c=a.view,d=document.url_root+"?lat="+g.lat+"&lon="+g.lng+"&zoom="+e;c.$permalink.prop("href",d);c.$fb_link.prop("href","https://www.facebook.com/sharer/sharer.php?u="+d)})}})})(jQuery,UIK);UIK.templates={};UIK.templates.uikPopupTemplate=Mustache.compile('<div id="stop-popup" class="{{css}} loader"></div>');UIK.templates.userLogsTemplate=Mustache.compile('<table class="table table-striped logs"> <caption>Общая статистика</caption> <tr> <th>Показатель</th> <th>Значение</th> </tr> <tr> <td>Всего УИКов</td> <td class="stop">{{count_all}}</td> </tr> <tr> <td>Отредактировано УИКов</td> <td class="stop">{{count_editable}}</td> </tr> <tr> <td>Отредактировано, %</td> <td class="stop">{{percent}}</td> </tr> </table> <table class="table table-striped logs"> <caption>Статистика по пользователям</caption> <tr> <th>Пользователь</th> <th>Кол-во УИКов</th> </tr> {{#user_logs}} <tr> <td>{{user_name}}</td> <td class="stop">{{count_uiks}}</td> </tr> {{/user_logs}} </table>');UIK.templates.searchResultsTemplate=Mustache.compile('<ul class="{{cssClass}}"> {{#uiks}} <li data-lat={{lat}} data-lon={{lon}} data-id={{id}}> <span>{{name}}</span> {{addr}} <a class="target" title="Перейти к УИКу"></a> {{#isAuth}}<a class="edit" title="Редактировать УИК"></a>{{/isAuth}} </li> {{/uiks}} </ul>');UIK.templates.uikPopupInfoTemplate=Mustache.compile('<table class="table table-striped"> <tr> <td>Номер УИКа</td> <td>{{uik.number_official}}</td> </tr> <tr> <td>ТИК</td> <td>{{tik.name}}</td> </tr> <tr> <td>Регион</td> <td>{{region.name}}</td> </tr> <tr> <td>Адрес голосования</td> <td>{{uik.address_voting}}</td> </tr> <tr> <td>Место помещения голосования</td> <td>{{uik.place_voting}}</td> </tr> <tr> <td>Точность геокодирования</td> <td>{{geo_precision.name_ru}}</td> </tr> <tr> <td>Комментарий</td> <td>{{uik.comment}}</td> </tr> <tr> <td>Проверен</td> <td> {{#uik.is_applied}}Да{{/uik.is_applied}} {{^uik.is_applied}}Нет{{/uik.is_applied}} </td> </tr> {{#isBlocked}} <tr class="block"> {{#isUnBlocked}} <td>Заблокирована вами</td> <td> <button class="btn btn-small btn-primary block" id="unblock" type="button">Разблокировать</button> </td> {{/isUnBlocked}} {{^isUnBlocked}} <td>Заблокировал</td> <td>{{userBlocked}}</td> {{/isUnBlocked}} </tr> {{/isBlocked}} </table> {{#isUserEditor}} <div class="edit"> <button class="btn btn-small btn-primary {{#isBlock}}block{{/isBlock}}" id="edit" type="button" {{#editDenied}}disabled="disabled"{{/editDenied}}>Редактировать</button> </div> {{/isUserEditor}} ');UIK.templates.osmPopupTemplate=Mustache.compile('<div class="osm-popup"> <div class="caption"> <span>{{id}}</span> <a href="{{link}}" target="_blank" title="Посмотреть на OpenStreetMaps" class="osm"></a> </div> <table class="table table-striped"> {{#tags}} <tr> <td>{{key}}</td> <td>{{val}}</td> </tr> {{/tags}} </table> </div>');UIK.templates.alertsTemplate=Mustache.compile('<div id="alert_{{id}}" class="alert alert-{{type}}" style="display: none;"> <button type="button" class="close" data-dismiss="alert">&times;</button> <strong>{{statusText}}</strong> {{text}} </div>');